<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="GitLab is an open-source DevOps platform widely adopted in many companies. This instruction outlines the setup of a hot standby (active-passive) GitLab instance."><meta name="keyword" content="DevOps,Git"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Setting up an active-passive GitLab instance</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">Setting up an active-passive GitLab instance</div><div class="date no-print">2024-11-11 / modified at 2025-10-08 / 1.4k words / 8 mins</div><div class="content"><p>GitLab is an open-source DevOps platform widely adopted in many companies. This instruction outlines the setup of a hot standby (active-passive) GitLab instance.</p><span id="more"></span><h2>Key Considerations</h2><ul><li>To maintain segregation of duties and adhere to vendor-neutral technology stack, we’re utilizing a reduced-feature set (dumb down) GitLab configuration, focusing on core repository hosting functionalities.</li><li>We’re introducing an active-passive deployment that eliminates the need for NFS.</li></ul><h2>GitLab: More Than Just a Repository Host</h2><p>GitLab Inc ($GTLB) is under pressure from stockholders to demonstrate income growth, leading to a rapid release cycle of new features. While these additions can be beneficial, they also increase the complexity of GitLab instance. requiring platform engineers to manage a broader range of components, disable potentially vulnerable features, and maintain high availability. The guide details how to create hot standby Git hosting solution using GitLab OSS.</p><h2>Choosing the Right Hardware for GitLab Self-Hosting</h2><p>We support approximately 3,000 active users per month performing code commits and CI/CD builds (by Jenkins) on self-hosting GitLab instances. We continuously evaluate GitLab performance across various cloud and bare metal environments.</p><h4>Cloud VM Specs</h4><p>The following specifications are recommended for GitLab‑centric workloads:</p><ul><li>CPU: GitLab is not inherently CPU-intensive; peak load occurring during merge request processing. However, avoid oversold CPU, as high speed I/O network adapter requires a more powerful CPU specs.</li><li>Memory: GitLab requires between 8 GB and 128 GB of RAM. In addition to the application memory, the operating system may cache Git repository files into memory pages.</li><li>Networking: GitLab requires high-speed I/O during pull and push operations.<ul><li>Without LFS: We’re observed peak traffic of ~5 Gbps during pipeline builds.</li><li>With LFS: If LFS storage is proxied or hosted by a GitLab instance, a 10 Gbps networking card is recommended.</li><li>Local storage: High-performance storage (e.g., clould SSD disks) is crucial for optimal performance during merge request processing.</li></ul></li></ul><h4>Bare Metal Considerations</h4><p>While bare metal deployments offer potential benefits, our testing indicates that they are not always as efficient as virtualized environments.</p><h5>Storage Scalability</h5><p>Manage RAID5 disks at a fundamental level presents a barrier for non-IDC engineers. Furthermore, the limited disk slots (typically 8) on existing computing nodes, combined with our existing dedicated enterprise storage, makes bare metal expansion less attractive.</p><h5>Memory Utilization</h5><p>Significant RAM (e.g., 1TB/512G installed) may be underutilized, as only 100 GB of RAM (including the OS pages) is consumed by the application.</p><h5>Network inefficiency</h5><p>A 25 Gb/s fiber network adapter may be underutilized if peak traffic remains bellow 5 Gb/s.</p><p>In summary, we recommend deploying GitLab on instances with 4U/32G or 8U/64G configurations and large local cloud SSD disks.</p><h2>GitLab Architecture</h2><p>GitLab is a Ruby Rails application built on top of Postgres, Redis, and cloud storage. Compared with <a href="/tags/subversion">subversion</a>’s focus solely on repository hosting, which requires only an Apache httpd loadbalancer and shared disk, GitLab demands more resources.</p><h4>Component Overall</h4><p>The diagram shows the minimum components for the repository-hosting.</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="416px" preserveAspectRatio="none" style="width:502px;height:416px;background:#fff" version="1.1" viewBox="0 0 502 416" width="502px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="65.4932" x="10" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45.4932" x="20" y="211.8857">GitLab</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="74.749" x="125.4932" y="48.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54.749" x="135.4932" y="71.1436">Stateful</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="157.1494" x="250.2422" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="137.1494" x="260.2422" y="42.9951">Gitaly: The FS layer</text><path d="M200.2422,66.2969 L210.2422,66.2969 C225.2422,66.2969 225.2422,38.1484 240.2422,38.1484 L250.2422,38.1484" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="240.1514" x="250.2422" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="220.1514" x="260.2422" y="99.292">Sidekiq: Redis-based job queue</text><path d="M200.2422,66.2969 L210.2422,66.2969 C225.2422,66.2969 225.2422,94.4453 240.2422,94.4453 L250.2422,94.4453" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M75.4932,207.0391 L85.4932,207.0391 C100.4932,207.0391 100.4932,66.2969 115.4932,66.2969 L125.4932,66.2969" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="84.1484" x="125.4932" y="160.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64.1484" x="135.4932" y="183.7373">Stateless</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="173.3369" x="259.6416" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="153.3369" x="269.6416" y="155.5889">Rails: The RESTful API</text><path d="M209.6416,178.8906 L219.6416,178.8906 C234.6416,178.8906 234.6416,150.7422 249.6416,150.7422 L259.6416,150.7422" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="140.4971" x="259.6416" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120.4971" x="269.6416" y="211.8857">Nginx/Workhorse</text><path d="M209.6416,178.8906 L219.6416,178.8906 C234.6416,178.8906 234.6416,207.0391 249.6416,207.0391 L259.6416,207.0391" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M75.4932,207.0391 L85.4932,207.0391 C100.4932,207.0391 100.4932,178.8906 115.4932,178.8906 L125.4932,178.8906" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="86.8008" x="125.4932" y="301.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66.8008" x="135.4932" y="324.4795">Database</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="123.4688" x="262.2939" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103.4688" x="272.2939" y="268.1826">Postgres/Redis</text><path d="M212.2939,319.6328 L222.2939,319.6328 C237.2939,319.6328 237.2939,263.3359 252.2939,263.3359 L262.2939,263.3359" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="155.0918" x="262.2939" y="301.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135.0918" x="272.2939" y="324.4795">S3: for LFS/uploads</text><path d="M212.2939,319.6328 L222.2939,319.6328 C237.2939,319.6328 237.2939,319.6328 252.2939,319.6328 L262.2939,319.6328" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="134.0234" x="262.2939" y="357.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114.0234" x="272.2939" y="380.7764">Disk(EBS/NVME)</text><path d="M212.2939,319.6328 L222.2939,319.6328 C237.2939,319.6328 237.2939,375.9297 252.2939,375.9297 L262.2939,375.9297" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M75.4932,207.0391 L85.4932,207.0391 C100.4932,207.0391 100.4932,319.6328 115.4932,319.6328 L125.4932,319.6328" fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><h4>NFS: End of support</h4><p>Prior to GitLab 15, we implemented GitLab availability using shared NFS, despite occasional latency errors while accessing the filesystem.</p><p>Since GitLab 16, Gitaly, the filesystem layer of Git, has officially ended supporting for shared disk, including NFS, Luster, GlusterFS, multi-attach EBS, and EFS. The only supported storage is block storage, such as Cinder, EBS, or VMDK.</p><h3>Which components could be disabled?</h3><p>Due to segregation of duties (SoD) and vulnerabilities concerns, we opt to keep simplicity on GitLab. Features such as CI/CD, GitOps, KAS(Kubernetes management), or artifacts are disabled in our self-hosted GitLab. Instead, we opt for other well-known alternatives (JFrog, Jenkins) to reduce the workload on GitLab.</p><h2>Git high availability hosting solutions</h2><p>Here are some Git hosting solutions.</p><table><thead><tr><th></th><th>GitLab Enterprise</th><th>Wandisco’s Gerrit</th><th>Hot standby GitLab</th></tr></thead><tbody><tr><td>License</td><td>Commercial</td><td>Commercial</td><td>OSS</td></tr><tr><td>Docs</td><td>GitLab <a target="_blank" rel="noopener" href="https://docs.GitLab.com/ee/administration/geo/">Geo-replica</a>.</td><td><a target="_blank" rel="noopener" href="https://docs.cirata.com/gerrit/1.9/">Wandisco’s Multisite solution</a></td><td>Here</td></tr><tr><td>Minimum Nodes</td><td>5</td><td>3</td><td>2</td></tr><tr><td>Local Storages Support</td><td>Yes</td><td>Yes</td><td>N (Centralized storage required)</td></tr><tr><td>AZ Replication</td><td>Yes(Gitaly cluster)</td><td>Yes(PAXOS)</td><td>Partial</td></tr><tr><td>Regional Replication</td><td>Yes(GitLab Geo)</td><td>Yes(WAN replication)</td><td>No</td></tr><tr><td>Comments</td><td><a target="_blank" rel="noopener" href="https://docs.GitLab.com/ee/administration/gitaly/index.html#disk-requirements">Gitaly cluster</a> requires an additional Postgres</td><td>Require ecosystem migration</td><td>Swichover is not automatically.</td></tr></tbody></table><h4>Implement replication through GitLab Enterprise</h4><p>You need to purchase enterprise licenses to access these premium services.</p><ul><li>GitLab Geo (Push-through Proxy) facilitates communication between regional datacenters.</li><li>Gitaly Cluster (Shard and replication between LAN nodes), leveraging GitLab’s <a target="_blank" rel="noopener" href="https://docs.GitLab.com/ee/administration/gitaly/index.html#disk-requirements">Gitlay cluster</a> with an additional Postgres and three dedicated storage nodes, while technical support is only for enterprise users.</li></ul><p>It works fine on both bare metal and virtual machines, even with local storage. The issue remains here is that there will still be downtime during the upgrade.<br>It works fine on both bare metal and virtual machines, even with local storage. The issue remains here is that there will still be downtime during the upgrade.</p><h4>Implement with Wandisco’s Gerrit</h4><p>Wandisco introduced PAXOS on Git, which is a consensus algorithm for distributed systems, to replicate repositories in multiple continents. The performance has been proven over decades of use in their subversion product.</p><p>To use Gerrit by Wandisco, consider the following:</p><ul><li><strong>Licenseing fees</strong>: you need to purchase a license to receive their support.</li><li><strong>Ecosystem changed</strong>: you have to switch from GitLab to Gerrit. This may be acceptable if your team is migrating from subversion to Git.</li></ul><h4>Implement centralized storage with the hot standby node</h4><p>To avoid the disruptions to computing nodes, we believe each node should access dedicated storage nodes through fiber connections, such as a NetApp/OceanStor hardware, or <a target="_blank" rel="noopener" href="https://docs.openstack.org/project-deploy-guide/openstack-ansible/ocata/overview-storage-arch.html">Cinder</a> virtualization platform.</p><p>The diagram shows a hot standby architecture along with disaster tolerance in another region.</p><ul><li>In Region 1, there are two nodes. the secondary node is connecting the primary VM directly with <a target="_blank" rel="noopener" href="https://docs.GitLab.com/ee/administration/gitaly/#gitaly-architecture">Gitaly client</a> through gRPC, rather than connecting to a local disk.</li><li>For backup in Region 2, leveraging storage level replication is sufficient. Incremental backup tools like AWS Backup or Restic is acceptable. There could be a minor risk of data loss while transactional data is being uploaded during snapshot progress, but it’s acceptable.</li></ul><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="DESCRIPTION" height="588px" preserveAspectRatio="none" style="width:891px;height:588px;background:#fff" version="1.1" viewBox="0 0 891 588" width="891px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g class="cluster" data-entity="az1" data-source-line="9" data-uid="ent0003" id="cluster_az1"><rect fill="none" height="448" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="796.37" x="89.2" y="134"/><path d="M163.6219,134 L163.6219,143.2969 L153.6219,153.2969 L89.2,153.2969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="64.4219" x="92.2" y="147.9951">Region1</text></g><g class="cluster" data-entity="engine" data-source-line="10" data-uid="ent0004" id="cluster_engine"><rect fill="none" height="219" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="181.96" x="494.56" y="339"/><path d="M670.851,339 L670.851,348.2969 L660.851,358.2969 L494.56,358.2969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="166.291" x="497.56" y="352.9951">Primary VM(16U64G)</text></g><g class="cluster" data-entity="engine2" data-source-line="15" data-uid="ent0008" id="cluster_engine2"><rect fill="none" height="158" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="182.68" x="222.2" y="269"/><path d="M399.9402,269 L399.9402,278.2969 L389.9402,288.2969 L222.2,288.2969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="167.7402" x="225.2" y="282.9951">Secondary VM(4U8G)</text></g><g class="cluster" data-entity="az2" data-source-line="27" data-uid="ent0016" id="cluster_az2"><rect fill="none" height="103" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="173.99" x="498.55" y="7"/><path d="M666.5627,7 L666.5627,32.5938 L656.5627,42.5938 L498.55,42.5938" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="64.4219" x="548.3454" y="20.9951">Region2</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="158.0127" x="501.55" y="37.292">(Disaster tolerance)</text></g><g class="entity" data-entity="lb" data-source-line="20" data-uid="ent0011" id="entity_lb"><path d="M109.2,364.85 L109.2,388.85 M109.2,376.85 L126.2,376.85" fill="none" style="stroke:#454645;stroke-width:.5"/><ellipse cx="138.2" cy="376.85" fill="#FFE552" rx="12" ry="12" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26.25" x="116.575" y="405.8451">ELB</text></g><g class="entity" data-entity="session" data-source-line="21" data-uid="ent0012" id="entity_session"><path d="M769.16,516.35 C769.16,506.35 813.8797,506.35 813.8797,506.35 C813.8797,506.35 858.5995,506.35 858.5995,516.35 L858.5995,541.6469 C858.5995,551.6469 813.8797,551.6469 813.8797,551.6469 C813.8797,551.6469 769.16,551.6469 769.16,541.6469 L769.16,516.35" fill="#00FFFF" style="stroke:#454645;stroke-width:.5"/><path d="M769.16,516.35 C769.16,526.35 813.8797,526.35 813.8797,526.35 C813.8797,526.35 858.5995,526.35 858.5995,516.35" fill="none" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.4395" x="779.16" y="543.3451">Redis(HA)</text></g><g class="entity" data-entity="pg" data-source-line="22" data-uid="ent0013" id="entity_pg"><path d="M758.2,373.35 C758.2,363.35 813.8846,363.35 813.8846,363.35 C813.8846,363.35 869.5691,363.35 869.5691,373.35 L869.5691,398.6469 C869.5691,408.6469 813.8846,408.6469 813.8846,408.6469 C813.8846,408.6469 758.2,408.6469 758.2,398.6469 L758.2,373.35" fill="#00FFFF" style="stroke:#454645;stroke-width:.5"/><path d="M758.2,373.35 C758.2,383.35 813.8846,383.35 813.8846,383.35 C813.8846,383.35 869.5691,383.35 869.5691,373.35" fill="none" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91.3691" x="768.2" y="400.3451">Postgres(HA)</text></g><g class="entity" data-entity="disk" data-source-line="23" data-uid="ent0014" id="entity_disk"><path d="M520.88,250.35 C520.88,240.35 585.5367,240.35 585.5367,240.35 C585.5367,240.35 650.1935,240.35 650.1935,250.35 L650.1935,275.6469 C650.1935,285.6469 585.5367,285.6469 585.5367,285.6469 C585.5367,285.6469 520.88,285.6469 520.88,275.6469 L520.88,250.35" fill="#00FFFF" style="stroke:#454645;stroke-width:.5"/><path d="M520.88,250.35 C520.88,260.35 585.5367,260.35 585.5367,260.35 C585.5367,260.35 650.1935,260.35 650.1935,250.35" fill="none" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74.792" x="530.88" y="277.3451">Virtualized</text><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4.4502" x="605.672" y="277.3451">&#160;</text><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.0713" x="610.1222" y="277.3451">Disk</text></g><g class="entity" data-entity="s3" data-source-line="24" data-uid="ent0015" id="entity_s3"><rect fill="#F1F1F1" height="36.2969" rx="35" ry="35" style="stroke:#181818;stroke-width:.5" width="37.7939" x="566.64" y="168.85"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="17.7939" x="576.64" y="191.8451">S3</text></g><g class="entity" data-entity="pub" data-source-line="11" data-uid="ent0005" id="entity_pub"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="98.5039" x="536.29" y="444.85"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78.5039" x="546.29" y="467.8451">Rails/Nginx</text></g><g class="entity" data-entity="gitaly" data-source-line="12" data-uid="ent0006" id="entity_gitaly"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="101.9629" x="534.56" y="373.85"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40.9814" x="544.56" y="396.8451">Gitaly</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4.4502" x="585.5414" y="396.8451">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36.5313" x="589.9916" y="396.8451">Local</text></g><g class="entity" data-entity="mq" data-source-line="13" data-uid="ent0007" id="entity_mq"><path d="M554.96,515.85 L616.1202,515.85 C621.1202,515.85 621.1202,528.9984 621.1202,528.9984 C621.1202,528.9984 621.1202,542.1469 616.1202,542.1469 L554.96,542.1469 C549.96,542.1469 549.96,528.9984 549.96,528.9984 C549.96,528.9984 549.96,515.85 554.96,515.85" fill="#FF6347" style="stroke:#454645;stroke-width:1.5"/><path d="M616.1202,515.85 C611.1202,515.85 611.1202,528.9984 611.1202,528.9984 C611.1202,542.1469 616.1202,542.1469 616.1202,542.1469" fill="none" style="stroke:#454645;stroke-width:1.5"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51.1602" x="554.96" y="533.8451">Sidekiq</text></g><g class="entity" data-entity="pub2" data-source-line="16" data-uid="ent0009" id="entity_pub2"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="98.5039" x="264.29" y="303.85"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78.5039" x="274.29" y="326.8451">Rails/Nginx</text></g><g class="entity" data-entity="gitaly_rmt" data-source-line="17" data-uid="ent0010" id="entity_gitaly_rmt"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="130.6807" x="248.2" y="374.85"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.3164" x="258.2" y="397.8451">Gitaly(as</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4.4502" x="320.5164" y="397.8451">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43.9141" x="324.9666" y="397.8451">client)</text></g><g class="entity" data-entity="s3_back" data-source-line="28" data-uid="ent0017" id="entity_s3_back"><rect fill="#F1F1F1" height="36.2969" rx="35" ry="35" style="stroke:#181818;stroke-width:.5" width="93.9922" x="538.55" y="57.85"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51.748" x="548.55" y="80.8451">Backup</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4.4502" x="600.298" y="80.8451">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="17.7939" x="604.7482" y="80.8451">S3</text></g><g class="entity" data-entity="front" data-source-line="7" data-uid="ent0002" id="entity_front"><ellipse cx="25.6021" cy="355.35" fill="#454645" rx="8" ry="8" style="stroke:#454645;stroke-width:.5"/><path d="M25.6021,363.35 L25.6021,390.35 M12.6021,371.35 L38.6021,371.35 M25.6021,390.35 L12.6021,405.35 M25.6021,390.35 L38.6021,405.35" fill="none" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39.2041" x="6" y="419.8451">Users</text></g><g class="link" data-entity-1="front" data-entity-2="lb" data-source-line="32" data-uid="lnk18" id="link_front_lb"><path d="M45.67,385 C62.57,385 80.81,385 98.92,385" fill="none" id="front-to-lb" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="104.92,385,95.92,381,99.92,385,95.92,389,104.92,385" style="stroke:#666;stroke-width:1"/></g><g class="link" data-entity-1="lb" data-entity-2="pub" data-source-line="33" data-uid="lnk19" id="link_lb_pub"><path d="M130.57,409.25 C130.57,432.15 130.57,463 130.57,463 C130.57,463 412.07,463 529.99,463" fill="none" id="lb-to-pub" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="535.99,463,526.99,459,530.99,463,526.99,467,535.99,463" style="stroke:#666;stroke-width:1"/><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="19.3125" x="241.4" y="475.1387">3/4</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="3.8145" x="260.7125" y="475.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="41.625" x="264.527" y="475.1387">traffics</text></g><g class="link" data-entity-1="lb" data-entity-2="pub2" data-source-line="34" data-uid="lnk20" id="link_lb_pub2"><path d="M130.57,360.46 C130.57,342.77 130.57,322 130.57,322 C130.57,322 203.84,322 258.03,322" fill="none" id="lb-to-pub2" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="264.03,322,255.03,318,259.03,322,255.03,326,264.03,322" style="stroke:#666;stroke-width:1"/><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="19.3125" x="113.07" y="334.1387">1/4</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="3.8145" x="132.3825" y="334.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="41.625" x="136.197" y="334.1387">traffics</text></g><g class="link" data-entity-1="pub" data-entity-2="pg" data-source-line="36" data-uid="lnk21" id="link_pub_pg"><path d="M640.94,463 C693.93,463 764.57,463 764.57,463 C764.57,463 764.57,437.78 764.57,415.1" fill="none" id="pub-pg" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="634.94,463,643.94,467,639.94,463,643.94,459,634.94,463" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="764.57,409.1,760.57,418.1,764.57,414.1,768.57,418.1,764.57,409.1" style="stroke:#666;stroke-width:1"/></g><g class="link" data-entity-1="pub2" data-entity-2="pg" data-source-line="37" data-uid="lnk22" id="link_pub2_pg"><path d="M313.57,346.42 C313.57,359.44 313.57,368.6 313.57,368.6 C313.57,368.6 621.39,368.6 751.95,368.6" fill="none" id="pub2-pg" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="313.57,340.42,309.57,349.42,313.57,345.42,317.57,349.42,313.57,340.42" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="757.95,368.6,748.95,364.6,752.95,368.6,748.95,372.6,757.95,368.6" style="stroke:#666;stroke-width:1"/></g><g class="link" data-entity-1="s3" data-entity-2="s3_back" data-source-line="39" data-uid="lnk23" id="link_s3_s3_back"><path d="M585.57,168.42 C585.57,147.93 585.57,121.15 585.57,100.64" fill="none" id="s3-to-s3_back" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="585.57,94.64,581.57,103.64,585.57,99.64,589.57,103.64,585.57,94.64" style="stroke:#666;stroke-width:1"/><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="34.2773" x="494.57" y="143.6687">Cloud</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="3.8145" x="528.8473" y="143.6687">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="52.3066" x="532.6618" y="143.6687">Regional</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="66.9434" x="506.2975" y="157.6374">Replication</text></g><g class="link" data-entity-1="mq" data-entity-2="session" data-source-line="41" data-uid="lnk24" id="link_mq_session"><path d="M627.47,529 C667.28,529 719.56,529 762.74,529" fill="none" id="mq-session" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="621.47,529,630.47,533,626.47,529,630.47,525,621.47,529" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="768.74,529,759.74,525,763.74,529,759.74,533,768.74,529" style="stroke:#666;stroke-width:1"/><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="24.5449" x="670.1" y="541.1387">jobs</text></g><g class="link" data-entity-1="gitaly" data-entity-2="disk" data-source-line="44" data-uid="lnk25" id="link_gitaly_disk"><path d="M585.57,367.52 C585.57,344.39 585.57,316.79 585.57,291.8" fill="none" id="gitaly-disk" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="585.57,373.52,589.57,364.52,585.57,368.52,581.57,364.52,585.57,373.52" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="585.57,285.8,581.57,294.8,585.57,290.8,589.57,294.8,585.57,285.8" style="stroke:#666;stroke-width:1"/><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="17.0273" x="567.57" y="326.7987">I/O</text></g><g class="link" data-entity-1="gitaly_rmt" data-entity-2="gitaly" data-source-line="45" data-uid="lnk26" id="link_gitaly_rmt_gitaly"><path d="M379.04,392.5 C426.67,392.5 484.25,392.5 528.22,392.5" fill="none" id="gitaly_rmt-to-gitaly" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="534.22,392.5,525.22,388.5,529.22,392.5,525.22,396.5,534.22,392.5" style="stroke:#666;stroke-width:1"/><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="23.9531" x="432.63" y="404.6387">RPC</text></g><g class="link" data-entity-1="disk" data-entity-2="s3" data-source-line="46" data-uid="lnk27" id="link_disk_s3"><path d="M585.57,240.2 C585.57,229 585.57,221.7 585.57,211.2" fill="none" id="disk-to-s3" style="stroke:#666;stroke-width:1"/><polygon fill="#666666" points="585.57,205.2,581.57,214.2,585.57,210.2,589.57,214.2,585.57,205.2" style="stroke:#666;stroke-width:1"/><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="36.6094" x="483.57" y="234.8387">Restic</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="3.8145" x="520.1794" y="234.8387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60.9844" x="523.9938" y="234.8387">snapshots</text></g></g></svg><p>Here is more details explanation:</p><ul><li>The Sidekiq component, a distributed job executor, is disabled on the secondary node, as we found that when users attempt to retrieve a temporary file generated by a background job, Nginx cannot reliably routed the request to the same node.</li><li>All code should be protected within a private R&amp;D subnet, which don’t connect to production environments.</li><li>You can even create more secondary machines to minimize the downtime risk.</li></ul><p>Compared with the single node deployment, when the primary VM is unavailable, the Rails application on the secondary node, which is database-backed, continues to run.</p><ul><li>The administrator can send <a target="_blank" rel="noopener" href="https://docs.GitLab.com/ee/administration/broadcast_messages.html">broadcast messages</a> to inform users about the outage in their terminal or webpages.</li><li>Third-party integration jobs such as group and user synchronization remain functional.</li><li>Instead of wait for the infrastructure provider, you might manually switch over the primary VM to other VMs by remounting the disk (GitLab reconfiguration is required, root access is required).</li></ul><h2>Maintenance and Support costs on GitLab</h2><p>Unlike Jenkins or Sonarqube, there is no LTS version of GitLab on security &amp; bug fixes, we must keep the instance up-to-date every three months. However, according to GitLab’s version policy, new releases may include <strong>new features</strong>, which are not always free from vulnerabilities. That is to say, we are in a frequently upgrade cycle.</p><ul><li>New features can be an experimental version (e.g., AI chat, Kubernetes deployment) for an extended period, you might wait for the maturity.</li><li>The upgrade requires extensive preparations <strong>every three months</strong>.<ul><li>It requires thorough test of <strong>any</strong> platforms that integrate with GitLab API, in case of significant API changes.</li><li>It requires a downtime window for backuping databases and repositories.</li><li>Besides the GitLab instance, the PostgreSQL upgrade is also complex for non-DBA engineers.</li></ul></li></ul><p>Ultimately, the maintenance and support (M&amp;S) costs could be expensive despite there are no license fees on GitLab OSS.</p><h2>Summary</h2><p>While no solution elimates all single points of failure, the hot-standby solution offers a license-free option with tradeoffs, I hope you find the design useful when deploying GitLab services.</p></div><div class="tags"><a class="tag-link" href="/tags/DevOps/" rel="tag">DevOps</a><a class="tag-link" href="/tags/Git/" rel="tag">Git</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>