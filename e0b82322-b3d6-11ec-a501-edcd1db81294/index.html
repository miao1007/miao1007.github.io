<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="Nomad is an easy-to-use workload orchestrator which is more lightweight and operational than Kubernetes. With nomad, we can create a scalable jenkins cluster running up to 1k jobs on the bare metal machines."><meta name="keyword" content="DevOps,Jenkins,Nomad,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Resilient Jenkins Agents Provisioning with HashiCorp's Nomad</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">Resilient Jenkins Agents Provisioning with HashiCorp's Nomad</div><div class="date no-print">2019-10-20 / modified at 2023-07-30 / 796 words / 4 mins</div><div class="content"><blockquote><span>️This article has been <strong>over 2 years</strong> since the last update.</span></blockquote><p>Nomad is an easy-to-use workload orchestrator which is more lightweight and operational than Kubernetes. With nomad, we can create a scalable jenkins cluster running up to 1k jobs on the bare metal machines.</p><span id="more"></span><h2>What we have achieved?</h2><ul><li>Running raw_exec, docker with jenkins/nomad on self-hosted machines at scale. Which is a cheaper solution compared with IBM LSF.</li><li>Declarative agent pool(based on HCL) provisioner that can allocate CPU and memories at user side.</li><li>OpenLDAP/AutoFS works fine with Nomad.</li></ul><h2>How Agent Works</h2><h4>jenkins agent is not a jenkinsfile-runner</h4><p>It is intuitive that jenkins agent seems to be a jenkinsfile-runner. However, the agent(TCP/WebSocket based) is only an asynchronous event-driven application for bytecode commands intercepting.</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="DESCRIPTION" height="469px" preserveAspectRatio="none" style="width:751px;height:469px;background:#fff" version="1.1" viewBox="0 0 751 469" width="751px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g class="cluster" data-entity="agent" data-source-line="5" data-uid="ent0003" id="cluster_agent"><rect fill="none" height="456.59" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="602" x="143.91" y="7"/><path d="M227.3895,7 L227.3895,16.2969 L217.3895,26.2969 L143.91,26.2969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="73.4795" x="146.91" y="20.9951">Agent.jar</text></g><g class="cluster" data-entity="e" data-source-line="6" data-uid="ent0004" id="cluster_e"><rect fill="none" height="99.29" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="229" x="167.91" y="50"/><path d="M297.1903,50 L297.1903,59.2969 L287.1903,69.2969 L167.91,69.2969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="119.2803" x="170.91" y="63.9951">NIO Dispatcher</text></g><g class="cluster" data-entity="CommandReceiver" data-source-line="11" data-uid="ent0007" id="cluster_CommandReceiver"><rect fill="none" height="241.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="538" x="175.91" y="190.29"/><path d="M332.8075,190.29 L332.8075,199.5869 L322.8075,209.5869 L175.91,209.5869" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="146.8975" x="178.91" y="204.2851">CommandReceiver</text></g><g class="cluster" data-entity="interceptor" data-source-line="12" data-uid="ent0008" id="cluster_interceptor"><rect fill="none" height="158.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="466" x="215.91" y="241.29"/><path d="M646.6493,241.29 L646.6493,254.29 L636.6493,264.29 L215.91,264.29" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="304.7324" x="218.91" y="258.9882">InterceptingExecutorService(from 0 to</text><image height="21" width="40" x="528.5164" xlink:href="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjIxIiB3aWR0aD0iNDAiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciID48ZGVmcy8+PGc+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9IndpZHRoOjQwcHg7aGVpZ2h0OjIxcHg7YmFja2dyb3VuZDojRkZGRkZGOyIgd2lkdGg9IjQwIiBoZWlnaHQ9IjIxIi8+IDx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzMuNzE0OCIgeD0iNSIgeT0iMTcuOTk1MSI+Ml4zMjwvdGV4dD48L2c+PC9zdmc+" y="242.29"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="67.2588" x="572.3905" y="258.9882">threads)</text></g><g class="cluster" data-entity="RemotingClassLoader2" data-source-line="13" data-uid="ent0009" id="cluster_RemotingClassLoader2"><rect fill="none" height="87.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="197" x="460.91" y="288.29"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="181.2959" x="468.7621" y="303.2851">RemotingClassLoader2</text></g><g class="cluster" data-entity="RemotingClassLoader1" data-source-line="16" data-uid="ent0011" id="cluster_RemotingClassLoader1"><rect fill="none" height="87.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="197" x="239.91" y="288.29"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="181.2959" x="247.7621" y="303.2851">RemotingClassLoader1</text></g><g class="entity" data-entity="Selector" data-source-line="8" data-uid="ent0005" id="entity_Selector"><path d="M322.4092,89 L322.4092,113 M322.4092,101 L339.4092,101" fill="none" style="stroke:#454645;stroke-width:.5"/><ellipse cx="351.4092" cy="101" fill="#FFE552" rx="12" ry="12" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75.8584" x="304.98" y="129.9951">Dispatcher</text></g><g class="entity" data-entity="worker" data-source-line="9" data-uid="ent0006" id="entity_worker"><path d="M189.11,96 L264.7008,96 C269.7008,96 269.7008,109.1484 269.7008,109.1484 C269.7008,109.1484 269.7008,122.2969 264.7008,122.2969 L189.11,122.2969 C184.11,122.2969 184.11,109.1484 184.11,109.1484 C184.11,109.1484 184.11,96 189.11,96" fill="#FF6347" style="stroke:#454645;stroke-width:1.5"/><path d="M264.7008,96 C259.7008,96 259.7008,109.1484 259.7008,109.1484 C259.7008,122.2969 264.7008,122.2969 264.7008,122.2969" fill="none" style="stroke:#454645;stroke-width:1.5"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65.5908" x="189.11" y="113.9951">IO Queue</text></g><g class="entity" data-entity="bytecodes" data-source-line="14" data-uid="ent0010" id="entity_bytecodes"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="93.0488" x="512.38" y="323.29"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73.0488" x="522.38" y="346.2851">Bytecodes</text></g><g class="entity" data-entity="bytecodes2" data-source-line="17" data-uid="ent0012" id="entity_bytecodes2"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="93.0488" x="291.38" y="323.29"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73.0488" x="301.38" y="346.2851">Bytecodes</text></g><g class="entity" data-entity="master" data-source-line="4" data-uid="ent0002" id="entity_master"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="67.8105" x="7" y="91"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47.8105" x="17" y="113.9951">Master</text></g><g class="link" data-entity-1="master" data-entity-2="worker" data-source-line="21" data-uid="lnk13" id="link_master_worker"><path d="M75.02,109.14 C105.64,109.14 144.74,109.14 177.84,109.14" fill="none" id="master-to-worker" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="183.84,109.14,174.84,105.14,178.84,109.14,174.84,113.14,183.84,109.14" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="73.5884" x="92.96" y="102.2069">Commands</text></g><g class="link" data-entity-1="worker" data-entity-2="Selector" data-source-line="22" data-uid="lnk14" id="link_worker_Selector"><path d="M269.95,109.14 C281.54,109.14 287.13,109.14 298.72,109.14" fill="none" id="worker-to-Selector" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="304.72,109.14,295.72,105.14,299.72,109.14,295.72,113.14,304.72,109.14" style="stroke:#454645;stroke-width:1"/></g><g class="link" data-entity-1="Selector" data-entity-2="CommandReceiver" data-source-line="23" data-uid="lnk15" id="link_Selector_CommandReceiver"><path d="M314.13,133.65 C301.2,145.08 286.32,159.52 274.91,174.29 C271.7425,178.3894 268.6203,182.6132 265.5497,186.9308 C264.7821,188.0101 267.4513,184.175 266.6903,185.2656" fill="none" id="Selector-to-CommandReceiver" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="263.2566,190.186,271.6873,185.0945,266.118,186.0857,265.1269,180.5163,263.2566,190.186" style="stroke:#454645;stroke-width:1"/></g></g></svg><p>The jenkins master sends and receives commands to the agent via JNLP(TCP). In most situation, a fixed TCP port is seleted on startup.</p><h4>Agent internal</h4><ul><li>Dispatcher: Networking and dispatching in a single thread by NIO.</li><li>InterceptingExecutorService: Running commands by the cached thread pool, corePoolSize is 0, idle time is 60s</li></ul><h2>Resilient Agent Pool</h2><p>Here is an example using HashiCorp’s nomad for scheduling</p><h4>Provision Flow</h4><p>Nomad will use cgroups(Linux Control Groups) and chroot for resource isolation(based on <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runc">runc</a>). Nomad can be replaced with Kubernetes. Howerver, a single binary is easier to be installed and maintained.</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="908px" preserveAspectRatio="none" style="width:760px;height:908px;background:#fff" version="1.1" viewBox="0 0 760 908" width="760px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="none" height="20.9531" style="stroke:none;stroke-width:1" width="699.4141" x="15" y="12.7451"/><ellipse cx="155.8867" cy="48.6982" fill="#222222" rx="10" ry="10" style="stroke:#222;stroke-width:1"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="142.9004" x="84.4365" y="78.6982"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="122.9004" x="94.4365" y="99.8369">Timer(PeriodicWork)</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="162.9688" x="74.4023" y="154.0659"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="142.9688" x="84.4023" y="175.2046">NodeProvisionerInvoker</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="137.1172" x="87.3281" y="256.437"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="117.1172" x="97.3281" y="277.5757">use existing agents</text><ellipse cx="155.8867" cy="349.2104" fill="none" rx="11" ry="11" style="stroke:#222;stroke-width:1"/><ellipse cx="155.8867" cy="349.2104" fill="#222222" rx="6" ry="6" style="stroke:#222;stroke-width:1"/><polygon fill="#F1F1F1" points="69.9304,208.0347,241.843,208.0347,253.843,220.0347,241.843,232.0347,69.9304,232.0347,57.9304,220.0347,69.9304,208.0347" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="13.7017" x="159.8867" y="242.2451">no</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="171.9126" x="69.9304" y="223.8428">Any job starving for executors?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="19.0083" x="253.843" y="217.4404">yes</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="269.7734" x="21" y="402.2104"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="249.7734" x="31" y="423.3491">org.jenkinsci.plugins.nomad.NomadCloud</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="113.6621" x="99.0557" y="456.1792"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="93.6621" x="109.0557" y="477.3179">Agent(pending)</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="93.459" x="109.1572" y="745.231"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="73.459" x="119.1572" y="766.3696">Agent(busy)</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="134.6152" x="88.5791" y="820.5986"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="114.6152" x="98.5791" y="841.7373">Agent(idle/release)</text><ellipse cx="155.8867" cy="885.5674" fill="none" rx="11" ry="11" style="stroke:#222;stroke-width:1"/><ellipse cx="155.8867" cy="885.5674" fill="#222222" rx="6" ry="6" style="stroke:#222;stroke-width:1"/><line style="stroke:#000;stroke-width:1.5" x1="15" x2="15" y1="12.7451" y2="896.5674"/><rect fill="#FAEBD7" height="883.8223" style="stroke:#faebd7;stroke-width:1" width="146.7598" x="402.0796" y="12.7451"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="136.7598" x="408.0796" y="527.4072"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="116.7598" x="418.0796" y="548.5459">calculate resources</text><line style="stroke:#000;stroke-width:1.5" x1="402.0796" x2="402.0796" y1="12.7451" y2="896.5674"/><rect fill="#FAEBD7" height="883.8223" style="stroke:#faebd7;stroke-width:1" width="163.7139" x="548.8394" y="12.7451"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="142.9121" x="554.8394" y="598.6353"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="122.9121" x="564.8394" y="619.7739">runc(opencontainer)</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="124.2207" x="564.1851" y="674.0029"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="104.2207" x="574.1851" y="695.1416">running agent.jar</text><line style="stroke:#000;stroke-width:1.5" x1="548.8394" x2="548.8394" y1="12.7451" y2="896.5674"/><line style="stroke:#000;stroke-width:1.5" x1="712.5532" x2="712.5532" y1="12.7451" y2="896.5674"/><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="58.6982" y2="78.6982"/><polygon fill="#454645" points="151.8867,68.6982,155.8867,78.6982,159.8867,68.6982,155.8867,72.6982" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="112.667" y2="154.0659"/><polygon fill="#454645" points="151.8867,144.0659,155.8867,154.0659,159.8867,144.0659,155.8867,148.0659" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="237.1929" x="159.8867" y="133.9717">hudson.model.LoadStatistics.clock(dft 10s)</text><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="290.4058" y2="338.2104"/><polygon fill="#454645" points="151.8867,328.2104,155.8867,338.2104,159.8867,328.2104,155.8867,332.2104" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="163.48" x="159.8867" y="318.1162">Jenkins internal LoadBalancer</text><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="232.0347" y2="256.437"/><polygon fill="#454645" points="151.8867,246.437,155.8867,256.437,159.8867,246.437,155.8867,250.437" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="253.843" x2="333.3667" y1="220.0347" y2="220.0347"/><polygon fill="#454645" points="329.3667,295.3237,333.3667,305.3237,337.3667,295.3237,333.3667,299.3237" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="333.3667" x2="333.3667" y1="220.0347" y2="382.2104"/><line style="stroke:#454645;stroke-width:1" x1="333.3667" x2="155.8867" y1="382.2104" y2="382.2104"/><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="382.2104" y2="402.2104"/><polygon fill="#454645" points="151.8867,392.2104,155.8867,402.2104,159.8867,392.2104,155.8867,396.2104" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="188.0347" y2="208.0347"/><polygon fill="#454645" points="151.8867,198.0347,155.8867,208.0347,159.8867,198.0347,155.8867,202.0347" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="436.1792" y2="456.1792"/><polygon fill="#454645" points="151.8867,446.1792,155.8867,456.1792,159.8867,446.1792,155.8867,450.1792" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="779.1997" y2="820.5986"/><polygon fill="#454645" points="151.8867,810.5986,155.8867,820.5986,159.8867,810.5986,155.8867,814.5986" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="118.7925" x="159.8867" y="800.5044">All pending jobs done</text><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="854.5674" y2="874.5674"/><polygon fill="#454645" points="151.8867,864.5674,155.8867,874.5674,159.8867,864.5674,155.8867,868.5674" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="626.2954" x2="626.2954" y1="632.604" y2="674.0029"/><polygon fill="#454645" points="622.2954,664.0029,626.2954,674.0029,630.2954,664.0029,626.2954,668.0029" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="77.2578" x="630.2954" y="653.9087">cgroup/chroot</text><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="490.1479" y2="512.4072"/><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="476.4595" y1="512.4072" y2="512.4072"/><line style="stroke:#454645;stroke-width:1" x1="476.4595" x2="476.4595" y1="512.4072" y2="527.4072"/><polygon fill="#454645" points="472.4595,517.4072,476.4595,527.4072,480.4595,517.4072,476.4595,521.4072" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="247.7202" x="159.8867" y="505.9072">submit a job called jenkins-agent-xxx.nomad</text><line style="stroke:#454645;stroke-width:1" x1="476.4595" x2="476.4595" y1="561.376" y2="583.6353"/><line style="stroke:#454645;stroke-width:1" x1="476.4595" x2="626.2954" y1="583.6353" y2="583.6353"/><line style="stroke:#454645;stroke-width:1" x1="626.2954" x2="626.2954" y1="583.6353" y2="598.6353"/><polygon fill="#454645" points="622.2954,588.6353,626.2954,598.6353,630.2954,588.6353,626.2954,592.6353" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="120.2427" x="480.4595" y="577.1353">bin packing algorithm</text><line style="stroke:#454645;stroke-width:1" x1="626.2954" x2="626.2954" y1="707.9717" y2="730.231"/><line style="stroke:#454645;stroke-width:1" x1="626.2954" x2="155.8867" y1="730.231" y2="730.231"/><line style="stroke:#454645;stroke-width:1" x1="155.8867" x2="155.8867" y1="730.231" y2="745.231"/><polygon fill="#454645" points="151.8867,735.231,155.8867,745.231,159.8867,735.231,155.8867,739.231" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="117.9761" x="630.2954" y="723.731">JNLP connection back</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="64.002" x="176.5388" y="29.4531">Jenkins</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="123.4951" x="413.7119" y="29.4531">NomadServer</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="66.5771" x="597.4077" y="29.4531">HostOS</text></g></svg><p>when your resources(CPU/Memory) are exhausted, Nomad will refused to create agent, and shows</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Placement Failures</span><br><span class="line">  jenkins-slave-taskgroup 1 unplaced</span><br><span class="line">    Resources exhausted on 1 node</span><br><span class="line">    Dimension memory exhausted on 1 node</span><br></pre></td></tr></table></figure><p>Even the real usage of the CPU is not full.</p><h4>Networking</h4><p>Nomad uses the Serf protocal to communicate within the nodes.</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="DESCRIPTION" height="460px" preserveAspectRatio="none" style="width:655px;height:460px;background:#fff" version="1.1" viewBox="0 0 655 460" width="655px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g class="cluster" data-entity="Host" data-source-line="6" data-uid="ent0004" id="cluster_Host"><rect fill="none" height="218.89" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="642" x="7" y="7"/><path d="M80.2188,7 L80.2188,16.2969 L70.2188,26.2969 L7,26.2969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="63.2188" x="10" y="20.9951">Host OS</text></g><g class="cluster" data-entity="runc" data-source-line="8" data-uid="ent0006" id="cluster_runc"><rect fill="none" height="135.89" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="497" x="120" y="58"/><path d="M411.4014,58 L411.4014,67.2969 L401.4014,77.2969 L120,77.2969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="281.4014" x="123" y="71.9951">Containers(based on Runc)2GHz/4G</text></g><g class="entity" data-entity="nomad" data-source-line="7" data-uid="ent0005" id="entity_nomad"><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="70.1416" x="22.93" y="109.15"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.1416" x="32.93" y="132.1451">Nomad</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41.4395" x="32.93" y="148.442">Agent</text></g><g class="entity" data-entity="agent1" data-source-line="9" data-uid="ent0007" id="entity_agent1"><rect fill="#F1F1F1" height="68.8906" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="81.127" x="163.44" y="101"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.3467" x="173.44" y="123.9951">Agent1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56.6768" x="177.8902" y="140.292">500MHz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.5898" x="173.44" y="156.5889">1G RAM</text></g><g class="entity" data-entity="agent2" data-source-line="10" data-uid="ent0008" id="entity_agent2"><rect fill="#F1F1F1" height="68.8906" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="81.127" x="279.44" y="101"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.3467" x="289.44" y="123.9951">Agent2</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56.6768" x="293.8902" y="140.292">500MHz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.5898" x="289.44" y="156.5889">1G RAM</text></g><g class="entity" data-entity="agent3" data-source-line="11" data-uid="ent0009" id="entity_agent3"><rect fill="#F1F1F1" height="68.8906" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="81.127" x="395.44" y="101"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.3467" x="405.44" y="123.9951">Agent3</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56.6768" x="409.8902" y="140.292">500MHz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.5898" x="405.44" y="156.5889">1G RAM</text></g><g class="entity" data-entity="agent4" data-source-line="12" data-uid="ent0010" id="entity_agent4"><rect fill="#F1F1F1" height="68.8906" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="81.127" x="511.44" y="101"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.3467" x="521.44" y="123.9951">Agent4</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56.6768" x="525.8902" y="140.292">500MHz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.5898" x="521.44" y="156.5889">1G RAM</text></g><g class="entity" data-entity="master" data-source-line="4" data-uid="ent0002" id="entity_master"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="69.7793" x="285.11" y="288.89"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49.7793" x="295.11" y="311.8851">Jenkins</text></g><g class="entity" data-entity="server" data-source-line="5" data-uid="ent0003" id="entity_server"><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="70.1416" x="92.93" y="402.19"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.1416" x="102.93" y="425.1851">Nomad</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45.9102" x="102.93" y="441.482">Server</text></g><g class="link" data-entity-1="nomad" data-entity-2="runc" data-source-line="14" data-uid="lnk11" id="link_nomad_runc"><path d="M93.55,135.44 C99.155,135.44 104.7625,135.44 110.37,135.44 C113.1738,135.44 115.9775,135.44 118.7809,135.44 C119.1314,135.44 119.4818,135.44 119.8322,135.44 C119.876,135.44 119.9198,135.44 119.9636,135.44" fill="none" id="nomad-runc" style="stroke:#454645;stroke-width:1"/></g><g class="link" data-entity-1="master" data-entity-2="server" data-source-line="16" data-uid="lnk12" id="link_master_server"><path d="M291.67,325.66 C257.56,346.88 205.3548,379.3609 168.3948,402.3509" fill="none" id="master-to-server" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="163.3,405.52,173.0549,404.1629,167.5457,402.8791,168.8295,397.3698,163.3,405.52" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157.9614" x="242" y="368.2569">Resource request(HTTP)</text></g><g class="link" data-entity-1="server" data-entity-2="nomad" data-source-line="17" data-uid="lnk13" id="link_server_nomad"><path d="M121.89,402.07 C108.65,347.01 77.43,217.22 64.15,162.02" fill="none" id="server-nomad" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108.1577" x="105" y="311.6069">Scheduling(Serf)</text></g><g class="link" data-entity-1="agent1" data-entity-2="master" data-source-line="18" data-uid="lnk14" id="link_agent1_master"><path d="M222.49,170.08 C233.38,189.19 247.76,213.34 262,233.89 C270.1,245.59 273.09,247.79 282,258.89 C289.9,268.73 298.74,279.7 305.91,288.59" fill="none" id="agent1-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28.6406" x="283" y="254.9569">JNLP</text></g><g class="link" data-entity-1="agent2" data-entity-2="master" data-source-line="19" data-uid="lnk15" id="link_agent2_master"><path d="M320,170.36 C320,206.12 320,261.05 320,288.77" fill="none" id="agent2-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g><g class="link" data-entity-1="agent3" data-entity-2="master" data-source-line="20" data-uid="lnk16" id="link_agent3_master"><path d="M417.52,170.09 C406.65,189.21 392.26,213.35 378,233.89 C364.52,253.29 347.4,274.2 335.26,288.49" fill="none" id="agent3-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g><g class="link" data-entity-1="agent4" data-entity-2="master" data-source-line="21" data-uid="lnk17" id="link_agent4_master"><path d="M538.63,169.98 C528.9,190.73 513.95,216.62 494,233.89 C453.33,269.1 393.08,288.85 355.21,298.47" fill="none" id="agent4-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g></g></svg><p>Jenkins to Nomad(HTTP)</p><ul><li>Requests for provision containers who will run the agent.jar</li><li>Health: Nomad will check the JVM process and recreate if required.</li></ul><p>Jenkins to Agent</p><ul><li>Two sides of the channel via TCP/WebSocket.</li><li>Persistence: for <code>DurableTask</code>, there is a file-cookie based solution.</li></ul><h2>Agent-side performace</h2><h4>Cold startup performance</h4><ul><li>Using Java 11+ with AOT and CDS</li><li>Using <a target="_blank" rel="noopener" href="https://modules.readthedocs.io/en/latest/">environment module</a> or docker image for binary consistency.</li><li>Using Cloud Storage Gateway for storage performace.</li></ul><h4>Scheduling-policy</h4><ul><li>Nomd side: You may use <a target="_blank" rel="noopener" href="https://www.nomadproject.io/docs/job-specification/affinity">affinity</a> to run jobs depends on free disk and more.</li><li>Jenkins side: Add some idle timeout for the reuse of agents.</li></ul><h2>Troubleshoot</h2><h4>when the agent.jar is down?</h4><p>There will be some errors show that</p><blockquote><p>“hudson.remoting.RequestAbortedException: java.nio.channels.AsynchronousCloseException”.</p></blockquote><p>The job would die even if the agent have restarted.</p><h4>What will happen when the master restarts?</h4><p>For <code>DurableTask</code>, there is a file-cookie solution to monitor the bash status. However, the agent.jar may lost the connection.</p><p>Please avoid master restarting while any agent is running.</p><h4>Parked thread leaking problem</h4><p>First, It is known that a thread will be stopped when code fragments end. But a thread pool can pause(park) the thread to be reused. In Jenkins, a <code>parallel</code> step can create a thread overhead.</p><p>For example, we submit a pipeline job for a stress test, creating a lot of threads in parallels.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pipeline&#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        label <span class="string">&quot;test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages&#123;</span><br><span class="line">        stage(<span class="string">&#x27;init&#x27;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="keyword">def</span> jobs = [:]</span><br><span class="line">                    <span class="number">100.</span>times&#123;</span><br><span class="line">                        jobs[<span class="string">&quot;task&quot;</span> + it] =&#123; echo <span class="string">&quot;1&quot;</span>&#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    parallel(jobs);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You will see the threads increasing during the workload, but when all jobs are done, parked threads are <strong>not released</strong>. By using <code>top</code>, you may find that <strong>your native threads are also not released</strong> which means</p><ul><li>You will leak native stack size(or Xss) on master.</li><li>You will leak <code>/proc/sys/kernel/threads-max</code> .</li><li>You will face <code>Unable to create new native thread</code> when you deploy too many agents.</li></ul><p>What you need to do</p><ul><li>Increase more heap memory in the case of OOM.</li><li>Increase more ulimt or decrease Xss(eg: <code>-Xss256K</code>) or restart the agent periodically in case of the parking thread are not released.</li><li>Modify code of the threadpool. (Only if you really have too many agents.)</li></ul><h4>Preserve images while agents are getting stopped</h4><p>By default, nomad will remove your agent’s docker image after 5 minus. To avoid re-download images, please see the configs at <a target="_blank" rel="noopener" href="https://www.nomadproject.io/docs/drivers/docker#gc">here</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># on nomad&#x27;s client-&gt;plugin &quot;docker&quot;-&gt;config</span><br><span class="line">gc &#123;</span><br><span class="line">    image = false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2>Reference</h2><ul><li><a target="_blank" rel="noopener" href="https://blog.codecentric.de/en/2017/11/microservices-nomad-consul/">https://blog.codecentric.de/en/2017/11/microservices-nomad-consul/</a></li></ul></div><div class="tags"><a class="tag-link" href="/tags/DevOps/" rel="tag">DevOps</a><a class="tag-link" href="/tags/Jenkins/" rel="tag">Jenkins</a><a class="tag-link" href="/tags/Nomad/" rel="tag">Nomad</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>