<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>NativeThread</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../java/index.html"><strong aria-hidden="true">2.</strong> Java/JVM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../java/gc/index.html"><strong aria-hidden="true">2.1.</strong> 垃圾回收</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../java/gc/analyze-full-gc.html"><strong aria-hidden="true">2.1.1.</strong> analyze-full-gc</a></li></ol></li><li class="chapter-item expanded "><a href="../../java/classloader/index.html"><strong aria-hidden="true">2.2.</strong> ClassLoader</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../java/classloader/class.html"><strong aria-hidden="true">2.2.1.</strong> Class的结构</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../juc/index.html"><strong aria-hidden="true">3.</strong> 并发编程</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../juc/final/index.html"><strong aria-hidden="true">3.1.</strong> final/ThreadLocal</a></li><li class="chapter-item expanded "><a href="../../juc/thread/index.html"><strong aria-hidden="true">3.2.</strong> 线程</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../juc/thread/nativethread.html" class="active"><strong aria-hidden="true">3.2.1.</strong> NativeThread</a></li><li class="chapter-item expanded "><a href="../../juc/thread/jvmthread.html"><strong aria-hidden="true">3.2.2.</strong> JVM线程</a></li><li class="chapter-item expanded "><a href="../../juc/thread/threadpool.html"><strong aria-hidden="true">3.2.3.</strong> ThreadPool</a></li></ol></li><li class="chapter-item expanded "><a href="../../juc/lock/index.html"><strong aria-hidden="true">3.3.</strong> 锁</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../juc/lock/cas/index.html"><strong aria-hidden="true">3.3.1.</strong> CAS与AQS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../juc/lock/cas/cas-impl.html"><strong aria-hidden="true">3.3.1.1.</strong> CAS的实现</a></li><li class="chapter-item expanded "><a href="../../juc/lock/cas/aqs/aqs-impl.html"><strong aria-hidden="true">3.3.1.2.</strong> AQS的实现</a></li><li class="chapter-item expanded "><a href="../../juc/lock/cas/aqs/reentrantlock.html"><strong aria-hidden="true">3.3.1.3.</strong> ReentrantLock</a></li><li class="chapter-item expanded "><a href="../../juc/lock/cas/aqs/countdownlatch.html"><strong aria-hidden="true">3.3.1.4.</strong> CountDownLatch</a></li><li class="chapter-item expanded "><a href="../../juc/lock/cas/aqs/read-write-lock.html"><strong aria-hidden="true">3.3.1.5.</strong> ReadWriteLock</a></li></ol></li><li class="chapter-item expanded "><a href="../../juc/lock/synchronized/index.html"><strong aria-hidden="true">3.3.2.</strong> synchronized</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../juc/lock/synchronized/jvm-sync.html"><strong aria-hidden="true">3.3.2.1.</strong> sync的native实现</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../juc/juc-problems.html"><strong aria-hidden="true">3.4.</strong> 常见并发问题</a></li><li class="chapter-item expanded "><a href="../../juc/cow/index.html"><strong aria-hidden="true">3.5.</strong> 写时复制</a></li></ol></li><li class="chapter-item expanded "><a href="../../microservice/index.html"><strong aria-hidden="true">4.</strong> 微服务中间件</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>a review for thread mode</p>
<hr />
<p>本文首先介绍了一些线程基础，比如并发、并行、内存分配、系统调用、POSIX线程。接着通过strace分析了线程与进程的区别。最后以Android、Golang等线程模型进行了分析。</p>
<h2 id="1-基础"><a class="header" href="#1-基础">1. 基础</a></h2>
<h3 id="11-os下如何进行内存分配用户区与内核区有什么区别"><a class="header" href="#11-os下如何进行内存分配用户区与内核区有什么区别">1.1. OS下如何进行内存分配？用户区与内核区有什么区别？</a></h3>
<p>在32位的Linux操作系统中，当一个进程启动后，将被分配4G的虚拟内存。内存可以分为两个空间，一个是用户空间（0～3G），另一个是内核空间（3G～4G）。其中用户空间就是代码运行的空间，比如堆栈、BSS（未初始化数据段）、DATA（已经初始化数据段）、TEXT（代码二进制段）；而在内核空间中，是OS内核的映射，只有在执行syscall系统调用时，才能进行重写。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/98641-9cb17f0304091fcc.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="32 Bit OS Virtual Memory" /></p>
<p>在用户态中，执行用户代码，比如直接运行C程序、或者运行JVM虚拟机等。</p>
<p>在内核中，主要负责I/O(显示，层三以下的网络，FS)，Memory(虚拟内存，页面替换/缓存), Process（信号、线程/进程管理，CPU调度）的管理，直接控制CPU、内存等硬件，权限(privilege)非常大;</p>
<h3 id="12-系统调用中断sci是什么"><a class="header" href="#12-系统调用中断sci是什么">1.2. 系统调用中断(SCI)是什么？</a></h3>
<p>系统调用是用户与内核间的一个桩(stub)，当在用户态执行高权限任务，需要通过系统调用切换入内核态去执行最底层任务。比如在C语言中调用<code>getTime()</code>时，大致流程如下</p>
<pre><code>1. app method(User Application)
    |
    |调用stdlibc标准库
    |
2. systemcall_stub(std libc)
    |
    |系统调用，进入内核态
    |
3. system_call_table[call_number](Kernel)
    |
    |通过查表调用硬件函数
    |
4. hardware_call(Kernel)
</code></pre>
<ol>
<li>在App层面，开发者不需要自己写系统调用，系统会提供相关C标准库的SDK供开发者使用，比如开发者调用<code>getTime()</code>时，实际是使用了标准库的<code>time.h</code>头文件。</li>
<li>代码在执行时，OS自动加载标准库。比如在android的bionic库中，实际执行getTime的系统调用是<a href="https://github.com/android/platform_bionic/blob/master/libc/arch-arm/syscalls/clock_gettime.S">这里</a>的平台相关的汇编代码，将系统调用的ID、参数传入内核。</li>
<li>内核通过系统调用ID进行表的索引，寻找真正的硬件调用函数</li>
<li>进行硬件相关的调用</li>
</ol>
<blockquote>
<p>在Mac下打开ActivityManager或者在Terminal中运行top，就可以显示地看到用户与系统的CPU占用</p>
<p><img src="http://upload-images.jianshu.io/upload_images/98641-a24e7c2ffc982584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="User and Kernel CPU usage" /></p>
</blockquote>
<h3 id="13-posix线程模型"><a class="header" href="#13-posix线程模型">1.3. POSIX线程模型</a></h3>
<p>POSIX是IEEE P1003.1中的线程标准，目前所有的系统，甚至windows都支持POSIX。它提供了用户态下的线程编程接口，开发者在进行线程开发时，只用引用<code>pthread.h</code>头文件调用即可。程序在运行时通过系统调用，在内核中进行线程的实现。它有很多函数，比如create, exit, join, yield等，具体可以去各个平台下的libc源码/sdk中去看Header文件中方法的定义，比如android中使用biolibc中pthread.h的代码在<a href="https://android.googlesource.com/platform/bionic/+/master/libc/include/pthread.h">这里</a>，这里的头文件是对内核线程的包装。</p>
<h2 id="2-线程与进程的区别"><a class="header" href="#2-线程与进程的区别">2. 线程与进程的区别</a></h2>
<p>这是一道经典的面试题，大多数回答者都是回忆起当初学习操作系统课本中的知识。然而课本中太偏向于内核，从开始就学习内核底层，而脱离开发，笔者认为是不太明智的。因此通过设计一个系统调用栈的分析，让读者有更清晰的了解。</p>
<p>本文线程特指32位下使用glibc的Linux系统中的POSIX模型，即用户面线程，进程特指<code>unstd.h</code>中的fork产生的进程。</p>
<p>本测试基于Ubuntu 14.04 i386</p>
<h3 id="1-测试代码设计"><a class="header" href="#1-测试代码设计">1. 测试代码设计</a></h3>
<h4 id="11-线程测试代码"><a class="header" href="#11-线程测试代码">1.1. 线程测试代码</a></h4>
<pre><code class="language-c">//modified from https://computing.llnl.gov/tutorials/pthreads/samples/hello.c

//todo run:
//clang -Wall -g pthread.c -o pthread.out -lpthread
//strace -Cfo ./pthread.strace.log ./pthread.out

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pthread.h&gt;

void*
PrintHello(void *threadid)
{
   long tid;
   tid = (long)threadid;
   printf(&quot;Hello World! It's me, thread #%ld!\n&quot;, tid);
   pthread_exit(NULL);
}

int 
main(int argc, char *argv[]){
   pthread_t thread;
   int rc = 0;
   long t = 0;
   printf(&quot;In main: creating thread %ld\n&quot;, t);
   //注意这里是一个函数指针，不要傻眼了
   rc = pthread_create(&amp;thread, NULL, PrintHello, (void *)t);
   if (rc){
     exit(-1);
   }
}
</code></pre>
<h4 id="12-进程测试代码"><a class="header" href="#12-进程测试代码">1.2. 进程测试代码</a></h4>
<pre><code class="language-c">//todo run:
//clang -Wall -g fork.c -o fork.out
//strace -Cfo ./fork.strace.log ./fork.out

#include &lt;unistd.h&gt;

int 
main(int argc, char *argv[])
{
  pid_t pid;
  pid = fork();
  if(pid &lt; 0){
    return -1;
  }    
  return 0;
}
</code></pre>
<h3 id="2-测试结果"><a class="header" href="#2-测试结果">2. 测试结果</a></h3>
<p>在编译完成后，调用<code>strace</code>命令后，结果如下</p>
<h4 id="21-进程的strace路线如下"><a class="header" href="#21-进程的strace路线如下">2.1. 进程的strace路线如下</a></h4>
<pre><code>19948 execve(&quot;./fork.out&quot;, [&quot;./fork.out&quot;], [/* 68 vars */]) = 0
19948 brk(0)                            = 0x9bc000
19948 open(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3
19948 read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\320\37\2\0\0\0\0\0&quot;..., 832) = 832
.....
19948 clone(child_stack=0, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f5adac4ca10) = 19949
....
19949 +++ exited with 0 +++
</code></pre>
<h4 id="22-线程的strace路线如下"><a class="header" href="#22-线程的strace路线如下">2.2. 线程的strace路线如下</a></h4>
<pre><code>21958 execve(&quot;./pthread.out&quot;, [&quot;./pthread.out&quot;], [/* 68 vars */]) = 0
21958 open(&quot;/lib/x86_64-linux-gnu/libpthread.so.0&quot;, O_RDONLY|O_CLOEXEC) = 3
....
21958 access(&quot;/etc/ld.so.nohwcap&quot;, F_OK) = -1 ENOENT (No such file or directory)
21958 open(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3
21958 read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\320\37\2\0\0\0\0\0&quot;..., 832) = 832
21958 fstat(3, {st_mode=S_IFREG|0755, st_size=1845024, ...}) = 0
21958 mmap(NULL, 3953344, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f34229e4000
....
21958 clone(child_stack=0x7f34229e2fb0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tidptr=0x7f34229e39d0, tls=0x7f34229e3700, child_tidptr=0x7f34229e39d0) = 21959
....
21958 +++ exited with 0 +++
</code></pre>
<h3 id="3-测试结论"><a class="header" href="#3-测试结论">3. 测试结论</a></h3>
<p>通过上述的调用栈分析，可以得知均是通过调用<code>x86_64-linux-gnu</code>下的libc库，接着通过systemcall函数<code>clone()</code>实现对内核Process的控制，主要区别在<strong>函数参数中clone_flag上的不同</strong>，clone_flag指定了可以共享的资源，下图显示了进程与线程的flag</p>
<pre><code>//clone flag between thread and process
//⚠️: 省略了`CLONE_｀前缀

//进程的FLAG参数
flags=CHILD_CLEARTID|CHILD_SETTID|SIGCHLD

//线程的FLAG参数
flags=VM|FS|FILES|SIGHAND|THREAD|SYSVSEM|SETTLS|PARENT_SETTID|CHILD_CLEARTID
</code></pre>
<p>通过对<code>clone</code>进行man<a href="http://linux.die.net/man/2/clone">查询</a>，解释如下</p>
<p>进程的参数解释：</p>
<ul>
<li><code>CLONE_CHILD_CLEARTID</code>: Erase child thread ID at location ctid in child memory when the child exits, and do a wakeup on the futex at that address。</li>
<li><code>CLONE_SETTLS</code>: thread local storage (TLS) area，注意这个不可移植</li>
<li><code>CLONE_SIGHAND</code>: 共享signal handlers</li>
</ul>
<p>线程的一些参数解释：</p>
<ul>
<li><code>CLONE_VM</code>: the calling process and the child process run in the same memory space. (注意这里说的是<code>memory space</code>，指通过mmap()分配的内存。再多说一点，线程中的栈内存由<code>pthread_attr_t</code>属性中的<code>pthread_attr_setstacksize()</code>函数实现，默认可能为8MB(你可以运行<code>ulimit -a</code>查看最大值)，当然在实际中我们使用栈内存大多都是几KB而已；堆内存是共享的，这里不讨论)</li>
<li><code>CLONE_FS</code>: 共享文件系统，如下函数chroot(2), chdir(2), or umask(2)会被影响。</li>
<li><code>CLONE_FILES</code>: 共享file descriptor table</li>
<li><code>CLONE_SIGHAND</code>: 共享signal handlers</li>
<li><code>CLONE_THREAD</code>: 共享thread group，即有相同的PID，独立的TID；</li>
<li><code>CLONE_SYSVSEM</code>: 共享System V semaphore undo values列表，俺表示目前还不懂。</li>
<li><code>CLONE_SETTLS</code>: thread local storage (TLS) area，注意这个不可移植</li>
<li><code>CLONE_PARENT_SETTID</code>: Store child thread ID at location ptid in parent and child memory.</li>
<li><code>CLONE_CHILD_CLEARTID</code>: Erase child thread ID at location ctid in child memory when the child exits, and do a wakeup on the futex at that address。</li>
</ul>
<p>接着结合一些教科书，可以得知最终结论</p>
<table><thead><tr><th align="left"></th><th align="left">进程</th><th align="left">线程</th></tr></thead><tbody>
<tr><td align="left">用户层函数</td><td align="left">fork()</td><td align="left">pthread_create()</td></tr>
<tr><td align="left">内核实现</td><td align="left">clone()</td><td align="left">clone()</td></tr>
<tr><td align="left">内存</td><td align="left">新复制的内存(Copy-on-Write)，独立4G(1G+3G)</td><td align="left">共享4G内存：其中8M左右的栈内存是私有的，可以通过参数决定；共享堆内存</td></tr>
<tr><td align="left">创建耗时</td><td align="left">复制的flag少，所以耗时多</td><td align="left">低</td></tr>
<tr><td align="left">上下文切换耗时</td><td align="left">主要是切换内存空间</td><td align="left">几乎只有进出内核的损失</td></tr>
<tr><td align="left">内部通信</td><td align="left">IPC(Socket, Pipe, ASM...)</td><td align="left">共享的数据段(比如说DATA段的全局变量，更简单)</td></tr>
<tr><td align="left">举例</td><td align="left">Redis备份，运行含全局锁的脚本语言...</td><td align="left">I/O Select 的消息处理、线程池...</td></tr>
</tbody></table>
<h2 id="高级语言对内核线程的封装实现"><a class="header" href="#高级语言对内核线程的封装实现">高级语言对内核线程的封装实现</a></h2>
<p>除了通过POSIX标准外，高级语言也可以自己通过系统调用对内核的线程进行实现，主要有如下三种。</p>
<h3 id="1-纯内核线程实现11"><a class="header" href="#1-纯内核线程实现11">1. 纯内核线程实现(1:1)</a></h3>
<p>此线程模型将内核线程与App线程一一对应，可以看作为一种简单的映射关系，这里的代表有POSIX线程模型(pthread)，以及依赖pThread标准库的Java与Ruby(1.9+)线程模型。</p>
<p>以在Android/ARTJvm下创建线程为例，具体实现调用栈如下</p>
<pre><code>java.lang.Thread
    |
POSIX thread(user mode){
    0. art.runtime.Thread::CreateNativeThread(cpp, in jvm)
    1. pthread_create(pthread.h，标准库头文件)
    2. bionic标准库下的so文件，进行SystemCall(libc)
    3. 用户态陷入内核态
}
    |
Kernal thread(kernal mode)
</code></pre>
<p>可以看出，在JVM下的实现主要是对POSIX线程的包装与映射，自己本身只是做了点微小的工作，特点如下：</p>
<ol>
<li>移植性较差，需要适配各种libc库，但是由于被OS直接管理，因此在分配任务上可以充分借用内核的高效调度，能够高效利用物理核并实现真正的并行。</li>
<li>用户态与内核态切换有一定的消耗损失</li>
</ol>
<h3 id="2-纯用户态实现1n"><a class="header" href="#2-纯用户态实现1n">2. 纯用户态实现(1:N)</a></h3>
<p>将线程的调度在用户态实现，也称<code>green thread</code>，自己写调度算法，可以将一个native线程映射为多个app thread(这里也可以叫做线程包)，这里的代表有Ruby(1.8-)，Java等老版本，特点如下：</p>
<ol>
<li>移植性好，没有切换、映射到内核的损失</li>
<li>需要自己维护Scheduler</li>
<li>由于内核并不了解调度细节，很难进行多核利用</li>
</ol>
<h3 id="3-混合实现mn"><a class="header" href="#3-混合实现mn">3. 混合实现(M:N)</a></h3>
<p>可以同时运行M个kernel线程下管理N个app线程，比如golang。通过设置<code>GOMAXPROCS</code>个native线程，然后通过<code>go</code>关键词创建app线程，它的特点如下：</p>
<ol>
<li>调度器实现比较困难</li>
<li>通过语法糖与管道简化了并发编程，切换损失低</li>
<li>部分调度需要自己主动释放时间片</li>
</ol>
<pre><code>golang threading model(N)
    ↓
    ↓ goroutine
    ↓
Kernal thread model(M)
</code></pre>
<blockquote>
<p>详见<a href="https://swtch.com/libtask/">libtask</a>与许式伟的《go语言编程》</p>
</blockquote>
<h2 id="总结"><a class="header" href="#总结">总结</a></h2>
<ol>
<li>Concurrent是Parallels的父类</li>
<li>在启动一个程序后，将分配用户态与内核态任务，通过系统调用执行内核中的高权限任务</li>
<li>POSIX是一种线程标准，或者是一种接口，由libc库实现</li>
<li>线程与进程最大的区别在于内核函数<code>clone</code>函数的flag不同，导致共享资源不同。最终创建、切换耗时不同；以及内存分配、内部通信复杂度不同。</li>
<li>在Java中，<code>java.lang.Thread</code>与内核线程一一对应；在某些旧版语言中，实现了一个内核线程对应多个高层线程；在golang中，通过<code>goroutine</code>实现M个内核线程对应N个高层线程；</li>
</ol>
<h2 id="refference"><a class="header" href="#refference">REFFERENCE</a></h2>
<ol>
<li><a href="https://www.zhihu.com/question/21461752">https://www.zhihu.com/question/21461752</a></li>
<li><a href="https://blog.codinghorror.com/understanding-user-and-kernel-mode/">https://blog.codinghorror.com/understanding-user-and-kernel-mode/</a></li>
<li><a href="http://stackoverflow.com/questions/1311402/differences-between-user-and-kernel-modes">http://stackoverflow.com/questions/1311402/differences-between-user-and-kernel-modes</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E5%BF%99%E7%A2%8C%E7%AD%89%E5%BE%85">https://zh.wikipedia.org/wiki/%E5%BF%99%E7%A2%8C%E7%AD%89%E5%BE%85</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-system-calls/">https://www.ibm.com/developerworks/cn/linux/l-system-calls/</a></li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../juc/thread/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../juc/thread/jvmthread.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../juc/thread/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../juc/thread/jvmthread.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
