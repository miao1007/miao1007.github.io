<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="This article describes how to choose appreciated tokens in security design."><meta name="keyword" content="Security,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Security design for token authenticates</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">Security design for token authenticates</div><div class="date no-print">2023-10-01 / modified at 2025-10-04 / 1.5k words / 9 mins</div><div class="content"><p>This article describes how to choose appreciated tokens in security design.</p><span id="more"></span><blockquote><p>This article is for security demonstrating purposes only, and the author is not a full-time security researcher. API Tokens are not designing for critical environment such as TLS-breaking eavesdropper or compromised ROOT passwords. Any examples provided here are without warranty.</p></blockquote><h2>Alternatives</h2><p>If we lack confidence in the security design for a particular job or project, leveraging third-party SaaS services such as Auth0, Hashicorp Vault, or cloud KMS can provide an effective solution. By utilizing these services, we can alleviate concerns regarding security design and focus on other critical aspects of our work, such as developing business-related applications or systems.</p><h2>Threat Modeling</h2><p>It’s critical to follow <a target="_blank" rel="noopener" href="https://owasp.org/www-community/Threat_Modeling_Process">threat modeling</a> before designing tokens in the system, which consists of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Information_security">confidentiality, integrity, availability, accountability, and authentication</a>. Here are some key processes. Have a look at</p><ul><li><a target="_blank" rel="noopener" href="https://1passwordstatic.com/files/security/1password-white-paper.pdf">1Password Security Design</a></li><li><a target="_blank" rel="noopener" href="https://help.apple.com/pdf/security/en_US/apple-platform-security-guide.pdf">Apple Platform Security</a></li><li><a target="_blank" rel="noopener" href="https://github.com/mozilla/fxa-auth-server/wiki/onepw-protocol">Firefox</a></li></ul><h2>Security premises of token design</h2><h4>Security Design</h4><p>Have a look inside the application binary</p><ul><li>User case diagrams such as login, authentication, or forward-auth.</li><li>SOD enforcement: Keep IT admins, users and audits segregation of duty.</li><li>Data flow diagrams (DFDs) inside the application. Analyse high-value asserts that hackers might be interested in.</li><li>Vulnerabilities in third-party libraries embedded in the application.</li><li>ACL, scopes, rate limits, and expiration.</li></ul><h4>External Dependencies</h4><p>Enumerates the potential risks precaution against external components being compromised.</p><ul><li><p>Data flow diagrams (DFDs) that are external to the application, such as hard disks, S3, database, hashicorp vault, KMS services, and even storage chips.</p></li><li><p>Deployment diagrams including VPC, WAF, Linux, containers, Kubernetes, or physical machines. The underlying components should be hardened periodically.</p></li><li><p>Http router configurations for Nginx, traefik, or consul.</p></li></ul><h2>Types of tokens</h2><p>Designs for tokens can be classified via authenticates flow.</p><h4>User-to-server token</h4><p>User-to-server token is used for users speaking to a machine such as a news iOS App fetches data from the server via tokens owned by the current user.</p><table><thead><tr><th>Type</th><th>Description</th><th>Input</th><th>Scopes</th><th>Expiration</th></tr></thead><tbody><tr><td>Password</td><td>The password held by users.</td><td>User-input</td><td>For login only</td><td>On-demand</td></tr><tr><td>Session</td><td>Randomly generated after user login.</td><td>Server-Generated</td><td>Full</td><td>Hours</td></tr><tr><td>Access Token</td><td>Impersonates users for API calls.</td><td>Server-Generated</td><td>On-demand</td><td>On-demand</td></tr></tbody></table><p>Sessions can be implemented with a custom header name such as <code>x-authn-token</code> or custom cookie names. For instance, SpringBoot will use <code>SessionResolver</code> to generate and resolve sessions from HTTP requests sent from users.</p><h4>Server-to-server</h4><p>Server-to-server token is a static token used for servers speaking directly to another server such as a database password, LDAP password, or AKSK in S3 Storage.</p><p>It’s considered more important than the user-side tokens. SRE experts will secure the deployment behind a VPC &amp; WAF and must encrypt, rotate, and monitor the tokens periodically.</p><p>In the recent Aliyun Cloud global service failure, it was allegedly a single point of AKSK authentication failure that caused the the S3 storage failed to connect.</p><h4>OAuth Token</h4><p>OAuth Token is primarily used in SaaS services such as a hotel reservation website that connects customers, a hotel reservation server, and a payment SaaS service together. Once customers agree on the OAuth authentication, the hotel can charge the bill without further confirmation.</p><h2>Client-side storage security</h2><h4>Browser session</h4><p>The best way is to use <a target="_blank" rel="noopener" href="https://auth0.com/docs/secure/security-guidance/data-security/token-storage">in-memory storage</a> with <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker/postMessage">ServerWorkers</a> as a proxy to handle the transmission, however it can’t work in private mode of some browser.</p><p>As an alternative, in-browser storage such as local storage, session storage, and cookies are okay as long as we minimize the attack surface (XSS/CSRF). Here are some tips</p><ul><li>Enable subresource Integrity (SRI) that can check integrity from CDNs or local servers</li><li>Disable IFrame embedding with the X-Frame-Options header.</li><li>Restrict contents via the header <code>Content-Security-Policy</code> to enumerate trusting resources.</li><li>Sanitize HTML before rendering the page.</li></ul><h4>In-App session</h4><p>Besides in-memory storage, leveraging key storage to a hardware-based key manager such as Keychain is also considered secure.</p><p>As for the transmission, consider enabling HTTPS &amp; SSL Pinning to prevent MITM.</p><h2>Server-side storage security</h2><p>There are a few approaches including KMS, file, or database to store secrets. The simplest way is to store secrets in a database.</p><h3>Before all</h3><ul><li>The hard disk and database should be considered to be encrypted transparently.</li><li>The connections between applications (such as a SpringBoot application) and databases should be encrypted with TLS.</li></ul><h3>Plaintext storage</h3><p>It’s not allowed to store secrects in plaintext format in the database or codebase duo to it’s vulnerable to data leak when</p><ul><li>The database is compromised or the hard disk is stolen.</li><li>The employee is malicious</li><li>Junior programmers might print <code>select * from token</code> in the log – I’ve <a href="/e0b8232c-b3d6-11ec-a501-edcd1db81294">seen the code</a> a lot.</li></ul><h3>Password derivation</h3><p>The key derivations function(PDF), aka slow hashed/hierarchical keys, are used for generating irreversible passwords, such as <a target="_blank" rel="noopener" href="https://support.1password.com/pbkdf2/">PBKDF2</a>, scrypt and bcrypt.</p><h5>Usecase</h5><p>In a user’s registration process, the function is used for generating the hash text that will be stored in the database. The hashed key derived from human inputs can <strong>strengthen</strong> the randomness and length as user-provided passwords (such as 6 digits of PIN code) are vulnerable to dictionary attacks.</p><p>Additionally, as a password derivation, it can generate one or more secrets.</p><ul><li>1-&gt;1: In PBEWITHHMACSHA512ANDAES_256 encryption, it works as an encryption key (DEK) for AES GCM encryption.</li><li>2-&gt;1: In Two Secret Key Derivation (2SKD) , it involves in combining a new password from two passwords.</li><li>1-&gt;2: The hand input password will be splitted into two parts, one for login, another for password synchronization. See <a target="_blank" rel="noopener" href="https://hacks.mozilla.org/2018/11/firefox-sync-privacy">details</a></li></ul><h5>Should I provide an additional encryption layer for PBKDF2?</h5><p>There is a scenario if someone has the database terminal in hand, he can bypass the authentication via privilege escalation such as</p><ul><li>Replacing the existing PBKDF2 hash in the database with a pre-calculated hash. It’s similar to replacing the password of a root user by modifying the file <code>/etc/passwd</code>.</li><li>Grant a user access by modifying relationships between users and tokens, such as updating the references of the <code>user_token_id</code> to a pre-generated token that you known.</li></ul><p>To mitigate potential risks, one approach involves adding an extra layer, such as 2SKD or nested encryption, to encrypt sensitive columns representing <code>user_token_id</code> as well as encrypted tokens. However, implementing such protections may be unnecessary since securing an extra encryption key requires exclusive and critical infrastructure beyond current needs. Furthermore, a compromised database could still expose digital asserts directly.</p><blockquote><p>When revoking a token, instead of t just updating the <code>deleted</code> flag in the column, you need to remove them physically, such as filling the value with null.</p></blockquote><h5>Should I add client-side hash layer for a plaintext password?</h5><p>Client-side hash just replaces the <code>password</code> with <code>hash(password, salt, iteration)</code>, for backend servers they are considered the same, hackers can still impersonate users with the hashed password.</p><p>You needn’t to create your own HTTPS protocol. Hashing is only designed for preventing brute-force attacks, which don’t resolve MITM nor replay attacks issues.</p><p>Nonetheless, It’s okay to create a hash at a client level if you fail to persuade your leaders.</p><h3>Symmetric encryption</h3><p>Algorithm: Such as AESGCM256 with 96 nouces(IV).</p><p>Storage: The encrypted text can be directly stored in the database. However, the symmetric key requires isolated storage separating from the database and codebase.</p><h3>Asymmetric encryption</h3><p>Asymmetric encryption is primarily utilized for secure exchange of information. Duo to the slow performance, asymmetrical encryption are mostly be used for encrypt a symmetric key.</p><p>Here are some use cases</p><ul><li>TLS exchange, such as HTTPS, FTPS</li><li>iMessage/iCloud E2E encryption, where only your device holds the private key.</li><li>License key generation and validator, which rely on public keys to validate the metadata (features, expiration etc.), such as FLexLM</li></ul><p>Algorithm: Such as RSA/ECC</p><p>Storage: Same as above.</p><h4>How to log requests safely?</h4><p>See my <a href="/e0b8232c-b3d6-11ec-a501-edcd1db81294">another blog</a>.</p><h2>Where to store reversible encryption key?</h2><p>Technically it’s a problem of chained trust storage, even if using cloud KMS or Hardware KMS as underlying storage, you have to provide at least one reversible key (aka master key, pin code, phrases, alias or seal key) inside the application for cryptography operations. Once the key is breached, the data may be potentially exposed.</p><p>As an application developer, leveraging third-party storage rather than self-implementation is the best known method.</p><ul><li>Never hard-code secrets in the source code, it can be considered as a backdoor by customers.</li><li>Segregate the roles of the reversible key holders and the application developers.</li><li>Deploy applications on PaaS orchestrators, as exemplified kubernetes or nomad, which both can inject secrets into files or environment variables within isolated namespaces via chroot jail.</li><li>Use JCA Provider in Java, which uses PKCS internally.</li></ul><p>As we have talked above, we can’t omit all threats from skilled attackers but make it more difficult to be compromised.</p></div><div class="tags"><a class="tag-link" href="/tags/Security/" rel="tag">Security</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>