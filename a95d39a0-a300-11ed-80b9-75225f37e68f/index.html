<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="This post will introduce how to analyse native and JVM memory on containers."><meta name="keyword" content="Docker,Kubernetes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Memory diagnosis for java application on kubernetes</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">Memory diagnosis for java application on kubernetes</div><div class="date no-print">2023-02-08 / modified at 2024-07-17 / 1k words / 6 mins</div><div class="content"><blockquote><span>️This article has been <strong>over 1 years</strong> since the last update.</span></blockquote><p>This post will introduce how to analyse native and JVM memory on containers.</p><span id="more"></span><h2>Prequenence</h2><p>Following terminologies should be resolved before the diagnosis.</p><ul><li>You should known RSS in Linux.</li><li>You should known JVM memory layout spec.</li><li>RssAnon: mapped anon pages, or RSS, it dosn’t contains any file cache.</li><li>RssFile: cache pages, or Cache, reserves roughly 15MB for JVM.</li><li>CGroup memory footprint: accounts memory for RssAnon and RssFile(when used frequently)</li><li>Swap: Swapness are disabled by default, we use RAM only for performance.</li></ul><h2>How memory is managed</h2><h4>Memory footprint in JVM</h4><p>JVM can be divided into its <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-2.html#jvms-2.5">specs</a> and implementations. Open source implemetations for OpenJDK are <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/gctuning/garbage-collector-implementation.html#GUID-23844E39-7499-400C-A579-032B68E53073">HotSpot</a>(Originally by Oracle) and OpenJ9(Originally by IBM). But it’s mostly HotSpot based JVM that is preferred, which can be freely downloaded at eclipse <a target="_blank" rel="noopener" href="https://adoptium.net/temurin/releases/">temurin</a>.</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="303px" preserveAspectRatio="none" style="width:399px;height:303px;background:#fff" version="1.1" viewBox="0 0 399 303" width="399px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="83.916" x="10" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="63.916" x="20" y="155.5889">JVM Spes</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="58.7598" x="143.916" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="38.7598" x="153.916" y="42.9951">Stack</text><path d="M93.916,150.7422 L103.916,150.7422 C118.916,150.7422 118.916,38.1484 133.916,38.1484 L143.916,38.1484" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="111.7314" x="143.916" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91.7314" x="153.916" y="99.292">Heap(GC Ok)</text><path d="M93.916,150.7422 L103.916,150.7422 C118.916,150.7422 118.916,94.4453 133.916,94.4453 L143.916,94.4453" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="164.6074" x="143.916" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="144.6074" x="153.916" y="155.5889">Method Area(GC Ok)</text><path d="M93.916,150.7422 L103.916,150.7422 C118.916,150.7422 118.916,150.7422 133.916,150.7422 L143.916,150.7422" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="188.5195" x="143.916" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="168.5195" x="153.916" y="211.8857">Run-Time Constant Pool</text><path d="M93.916,150.7422 L103.916,150.7422 C118.916,150.7422 118.916,207.0391 133.916,207.0391 L143.916,207.0391" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="243.9932" x="143.916" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="223.9932" x="153.916" y="268.1826">Native Method Stacks(C Stacks)</text><path d="M93.916,150.7422 L103.916,150.7422 C118.916,150.7422 118.916,263.3359 133.916,263.3359 L143.916,263.3359" fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><p>Keep in mind, <strong>all</strong> memory list above can throw OutOfMemoryError when insufficient. And once more, there are no concept of young generation gc and <a href="www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">jvmoptions</a> for now.</p><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se17/html/index.html">https://docs.oracle.com/javase/specs/jvms/se17/html/index.html</a></p><h4>Memory footprint in a container</h4><p>To see the RAM limit inside a container</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl exec &lt;podname&gt; -n &lt;ns_name&gt; -it -- sh</span></span><br><span class="line"><span class="built_in">cat</span> /sys/fs/cgroup/memory/memory.usage_in_bytes</span><br><span class="line"><span class="comment"># hard limit MB, will be killed when OOM</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(cat /sys/fs/cgroup/memory/memory.limit_in_bytes)</span>/1024/1024&quot;</span> | bc</span><br><span class="line"><span class="comment"># soft limit MB, not used in kubernetes but used in Nomad</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(cat /sys/fs/cgroup/memory/memory.soft_limit_in_bytes)</span>/1024/1024&quot;</span> | bc</span><br></pre></td></tr></table></figure><p>To see current RAM usage</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a fuzz value</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(cat /sys/fs/cgroup/memory/memory.usage_in_bytes)</span>/1024/1024&quot;</span> | bc</span><br><span class="line"><span class="comment"># exact memory usage caculated by cgroup</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(cat /sys/fs/cgroup/memory/memory.stat | grep &#x27;^rss &#x27; | awk &#x27;&#123;print $2&#125;&#x27;)</span>&quot;</span>/1024/1024 | bc</span><br><span class="line"><span class="comment"># exact RAM usage in proc</span></span><br><span class="line"><span class="built_in">cat</span> /proc/1/status |grep <span class="string">&#x27;^Rss&#x27;</span></span><br></pre></td></tr></table></figure><p>You could learn <a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/resource_management_guide/chap-introduction_to_control_groups">CGroup</a> for better understanding. And Java Native Memory Tracking(NMT) can be used together with cgroup.</p><h4>Memory footprint in an orchestrator</h4><p>Application running on kubernetes can’t make full use of the memory.</p><p>On an 8GB VM, we have to reserve 1G for OS and kubernetes. Click <a target="_blank" rel="noopener" href="https://learnk8s.io/allocatable-resources">here</a> fore more.</p><h2>Build a java based docker image</h2><h4>Choose the base image</h4><p>It is eclipse-temurin, <a target="_blank" rel="noopener" href="https://blog.adoptopenjdk.net/2021/08/goodbye-adoptopenjdk-hello-adoptium/">formerly</a> known as AdoptOpenJDK that is widely used among developers. Here are examples</p><ul><li><a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-boot-docker/">SpringBoot</a> documents for beginners.</li></ul><p>Here are some production proven open source images</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/SonarSource/docker-sonarqube/blob/master/9/community/Dockerfile">Sonarqube</a>, properly configured with non-root, gpg signs and chmod.</li><li><a target="_blank" rel="noopener" href="https://github.com/jenkinsci/docker/blob/master/17/alpine/hotspot/Dockerfile">Jenkins</a>, with a multi-stage build.</li><li><a target="_blank" rel="noopener" href="https://github.com/plantuml/plantuml-server/blob/master/Dockerfile.jetty">PlantUML</a> for war applications.</li></ul><h4>Reduce JRE size by 100MB</h4><p>It’s just for development use when use JRE based docker image. In production, we could use <a target="_blank" rel="noopener" href="https://blog.monosoul.dev/2022/04/25/reduce-java-docker-image-size/">Multi-stage builds </a>to reduce JRE size by 100MB.</p><h2>Configuration in orchestrator</h2><h4>Configure JVM heap Max RAM Percentage through CGroup limit</h4><p>Java 11+ can directly configure reservable memory from the hard limit in CGroups.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## JVM reads from cgroup files</span></span><br><span class="line"><span class="comment">## mainly in /sys/fs/cgroup/memory/memory.limit_in_bytes</span></span><br><span class="line">java -Xlog:os+container=trace -version</span><br><span class="line"><span class="comment">## RSS Memory calculated by JVM</span></span><br><span class="line"><span class="built_in">echo</span> $(java -XX:+PrintFlagsFinal -version 2&gt;&amp;1 | grep -E <span class="string">&#x27;MaxHeapSize&#x27;</span> | grep <span class="string">&#x27;product&#x27;</span> | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>)/1024/1024*4 | bc</span><br></pre></td></tr></table></figure><p>Since we have the limit, the parameter <code>-Xmx</code> is no more required, use <code>-XX:MaxRAMPercentage</code> instead. For example, you can check your RAM with following cmd:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal -XX:MaxRAMPercentage=70 -version \</span><br><span class="line">  | grep -E <span class="string">&quot;MaxRAMPercentage | MaxHeapSize&quot;</span></span><br></pre></td></tr></table></figure><p>To permanently alter the default config, pass the environment in pods or nomad HCL.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_TOOL_OPTIONS=<span class="string">&quot;-XX:MaxRAMPercentage=70&quot;</span></span><br></pre></td></tr></table></figure><p>The percentage requires a accurately estimation depending on your workloads. Allocating 90% memory is not as ideal as the default value. I have tested that allocating more than 70% RAM for heap might be more likely to be OOM-Killed by Kernel, making the developer impossible to dump a hprof file.</p><h4>Configure RSS in orchestrator</h4><p>To config a nomad job, configure the <code>memory</code> attribute for <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/nomad/tutorials/advanced-scheduling/memory-oversubscription">oversubscription</a>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mebibyte</span></span><br><span class="line">resources &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">the equivalence of memory.soft_limit_in_bytes/10^20</span></span><br><span class="line">  memory = 400</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">the equivalence of memory.limit_in_bytes/10^20</span></span><br><span class="line">  memory_max = 520</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>To config a pod in Kubernetes, configure the <code>resources</code> attribute.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mi means Mebibyte</span></span><br><span class="line"><span class="comment"># controlled by memory.limit_in_bytes</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">520Mi</span></span><br></pre></td></tr></table></figure><p>For example, we have an application with 3GB heap memory reserverd, we might consider following</p><ul><li>Heap size: 3G, with MaxRAMPercentage=70~75%<ul><li>for typical workload: 2.4GB</li><li>extra for peak periods request: 0.6GB</li></ul></li><li>Hard limit(limits in kubernetes): 3GB/0.75=4G</li><li>Soft limit(requests in kubernetes): 2.4GB/0.75=3.2G</li></ul><p>To use a calculator, click <a target="_blank" rel="noopener" href="https://learnk8s.io/kubernetes-instance-calculator">here</a></p><blockquote><p>Soft limit is not designed for peak request, use Horizontal Pod Autoscaling instead.</p></blockquote><h2>Improve observability</h2><h4>Collect performance metrics with APM</h4><p>Here are some java agent based solution to collect realtime JVM memory usage and send to a centralized database. A sidecar jar needs to be packed into the image.</p><ul><li>Free: <a target="_blank" rel="noopener" href="https://github.com/uber-common/jvm-profiler">Uber JVM Profiler</a> Sending Metrics to Kafka. The development seems no more under maintenance, but only a few lines make it easy to be customized.</li><li>Free: <a target="_blank" rel="noopener" href="https://opentelemetry.io/docs/instrumentation/java/">OpenTelemetry</a></li><li>Free: <a target="_blank" rel="noopener" href="https://github.com/prometheus/jmx_exporter">Prometheus JMX Exporter</a></li><li>Paid: <a target="_blank" rel="noopener" href="https://www.datadoghq.com/ja/java-memory-usage/">DataDog</a> with managed dashboard service.</li><li>Paid: Buying enterprise JVM from Azul Mission Control.</li></ul><blockquote><p>Free versions require a SRE team to maintain the TSDB and dashboard. For more solutions, check out at <a target="_blank" rel="noopener" href="https://openapm.io/">OpenAPM</a></p></blockquote><p>Following metrics are important</p><ul><li>JVM heap eden space commited/used</li><li>JVM heap young space commited/used</li><li>RssAnon and RssCache: used for estimate the percentage of heap.</li></ul><h4>OOM Killer in JVM</h4><p>pass <code>-XX:+HeapDumpOnOutOfMemoryError</code> to save hpref files in the pod. Howerver, your pod might be destroyed when health check fails.</p><h2>Troubleshoot memory issues on kubernetes</h2><p>At first, read the official documents before step in.</p><ul><li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/troubleshoot/index.html">Troubleshooting Guide</a></li><li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/gctuning/index.html">Garbage Collection Tuning Guide</a></li></ul><p>When your application slows down or crashes by OutOfMemoryError, it usually leads by</p><ul><li>Heap exceeds Linux memory quota.<ul><li>Heavy/Buster work loads</li><li>Memory leak</li></ul></li><li>Max thread exceeds Linux process quota: unable to create new native thread<ul><li>Native threads/stacks/descriptor get leak or exceed the quota in ulimit.</li><li>Misuse <code>-Xss</code>, we could use <code>-Xss512k</code> to reduce the size.</li></ul></li></ul></div><div class="tags"><a class="tag-link" href="/tags/Docker/" rel="tag">Docker</a><a class="tag-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>