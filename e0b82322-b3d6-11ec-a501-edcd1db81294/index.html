<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="Nomad is an easy-to-use workload orchestrator which is more lightweight and operational than Kubernetes. With nomad, we can create a scalable jenkins cluster running up to 1k jobs on the bare metal machines."><meta name="keyword" content="DevOps,Jenkins,Nomad,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Resilient Jenkins Agents Provisioning with HashiCorp's Nomad</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-102296742-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-102296742-1")</script><meta name="generator" content="Hexo 5.4.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">Resilient Jenkins Agents Provisioning with HashiCorp's Nomad</div><div class="date">2019-10-20 / modified at 2023-02-20</div><div class="content"><p>Nomad is an easy-to-use workload orchestrator which is more lightweight and operational than Kubernetes. With nomad, we can create a scalable jenkins cluster running up to 1k jobs on the bare metal machines.</p><span id="more"></span><h2>What we have achieved?</h2><ul><li>Running raw_exec, docker with jenkins/nomad on self-hosted machines at scale.</li><li>Raw HCL/Agent pool supported(not talk here).</li><li>OpenLDAP/AutoFS works fine with Nomad.</li></ul><h2>How Agent Works</h2><h4>jenkins agent is not a jenkinsfile-runner</h4><p>It is intuitive that jenkins agent seems to be a jenkinsfile-runner. However, the agent(TCP/WebSocket based) is only an asynchronous event-driven application for bytecode commands intercepting.</p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="469px" preserveAspectRatio="none" style="width:752px;height:469px;background:#fff" version="1.1" viewBox="0 0 752 469" width="752px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g id="cluster_agent"><rect fill="none" height="456.59" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="602" x="144.5" y="7"/><path d="M226.5,7 L226.5,16.2969 L216.5,26.2969 L144.5,26.2969 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="72" x="147.5" y="20.9951">Agent.jar</text></g><g id="cluster_e"><rect fill="none" height="99.29" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="228" x="168.5" y="50"/><path d="M295.5,50 L295.5,59.2969 L285.5,69.2969 L168.5,69.2969 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="117" x="171.5" y="63.9951">NIO Dispatcher</text></g><g id="cluster_CommandReceiver"><rect fill="none" height="241.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="538" x="176.5" y="190.29"/><path d="M333.5,190.29 L333.5,199.5869 L323.5,209.5869 L176.5,209.5869 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="147" x="179.5" y="204.2851">CommandReceiver</text></g><g id="cluster_interceptor"><rect fill="none" height="158.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="466" x="216.5" y="241.29"/><path d="M645.5,241.29 L645.5,254.29 L635.5,264.29 L216.5,264.29 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="304" x="219.5" y="258.9882">InterceptingExecutorService(from 0 to</text><image height="21" width="39" x="528.5" xlink:href="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjIxIiB3aWR0aD0iMzkiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciID48ZGVmcy8+PGc+PHJlY3QgZmlsbD0iI0ZGRkZGRiIgc3R5bGU9IndpZHRoOjM5cHg7aGVpZ2h0OjIxcHg7YmFja2dyb3VuZDojRkZGRkZGOyIgLz4gPHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzMiIgeD0iNSIgeT0iMTcuOTk1MSI+Ml4zMjwvdGV4dD48L2c+PC9zdmc+" y="242.29"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="67" x="571.5" y="258.9882">threads)</text></g><g id="cluster_RemotingClassLoader2"><rect fill="none" height="87.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="197" x="461.5" y="288.29"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="181" x="469.5" y="303.2851">RemotingClassLoader2</text></g><g id="cluster_RemotingClassLoader1"><rect fill="none" height="87.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="197" x="240.5" y="288.29"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="181" x="248.5" y="303.2851">RemotingClassLoader1</text></g><g id="elem_Selector"><path d="M322,89 L322,113 M322,101 L339,101 " fill="none" style="stroke:#454645;stroke-width:.5"/><ellipse cx="351" cy="101" fill="#FFE552" rx="12" ry="12" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="305" y="129.9951">Dispatcher</text></g><g id="elem_worker"><path d="M190,96 L265,96 C270,96 270,109.1484 270,109.1484 C270,109.1484 270,122.2969 265,122.2969 L190,122.2969 C185,122.2969 185,109.1484 185,109.1484 C185,109.1484 185,96 190,96 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5"/><path d="M265,96 C260,96 260,109.1484 260,109.1484 C260,122.2969 265,122.2969 265,122.2969 " fill="none" style="stroke:#454645;stroke-width:1.5"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="190" y="113.9951">IO Queue</text></g><g id="elem_bytecodes"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="94" x="512.5" y="323.29"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="522.5" y="346.2851">Bytecodes</text></g><g id="elem_bytecodes2"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="94" x="291.5" y="323.29"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="301.5" y="346.2851">Bytecodes</text></g><g id="elem_master"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="67" x="7" y="91"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="17" y="113.9951">Master</text></g><g id="link_master_worker"><path d="M74.36,109.14 C103.62,109.14 146.23,109.14 179.09,109.14 " fill="none" id="master-to-worker" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="183.68,109.14,174.68,105.14,178.68,109.14,174.68,113.14,183.68,109.14" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="92.5" y="102.2069">Commands</text></g><g id="link_worker_Selector"><path d="M270.18,109.14 C279.69,109.14 289.2,109.14 298.72,109.14 " fill="none" id="worker-to-Selector" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="303.64,109.14,294.64,105.14,298.64,109.14,294.64,113.14,303.64,109.14" style="stroke:#454645;stroke-width:1"/></g><g id="link_Selector_CommandReceiver"><path d="M314.17,133.71 C301.43,145.16 286.77,159.6 275.5,174.29 C272.3481,178.4006 269.2396,182.6344 266.1812,186.9605 C265.4165,188.0421 264.655,189.1294 263.8968,190.222 " fill="none" id="Selector-to-CommandReceiver" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="263.8968,190.222,272.3143,185.1087,266.7475,186.1143,265.7419,180.5475,263.8968,190.222" style="stroke:#454645;stroke-width:1"/></g></g></svg><p>The jenkins master sends and receives commands to the agent via JNLP(TCP). In most situation, a fixed TCP port is seleted on startup.</p><h4>Agent internal</h4><ul><li>Dispatcher: Networking and dispatching in a single thread by NIO.</li><li>InterceptingExecutorService: Running commands by the cached thread pool, corePoolSize is 0, idle time is 60s</li></ul><h2>Resilient Agent Pool</h2><p>Here is an example using HashiCorp’s nomad for scheduling</p><h4>Provision Flow</h4><p>Nomad will use cgroups(Linux Control Groups) and chroot for resource isolation(based on <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runc">runc</a>). Nomad can be replaced with Kubernetes. Howerver, a single binary is easier to be installed and maintained.</p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="908px" preserveAspectRatio="none" style="width:784px;height:908px;background:#fff" version="1.1" viewBox="0 0 784 908" width="784px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="none" height="20.9531" style="stroke:none;stroke-width:1" width="724" x="15" y="12.7451"/><ellipse cx="160" cy="48.6982" fill="#222222" rx="10" ry="10" style="stroke:#222;stroke-width:1"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="145" x="87.5" y="78.6982"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="125" x="97.5" y="99.8369">Timer(PeriodicWork)</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="167" x="76.5" y="154.0659"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="147" x="86.5" y="175.2046">NodeProvisionerInvoker</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="143" x="88.5" y="256.437"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="123" x="98.5" y="277.5757">use existing agents</text><ellipse cx="160" cy="349.2104" fill="none" rx="11" ry="11" style="stroke:#222;stroke-width:1"/><ellipse cx="160" cy="349.2104" fill="#222222" rx="6" ry="6" style="stroke:#111;stroke-width:1"/><polygon fill="#F1F1F1" points="71.5,208.0347,248.5,208.0347,260.5,220.0347,248.5,232.0347,71.5,232.0347,59.5,220.0347,71.5,208.0347" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="14" x="164" y="242.2451">no</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="177" x="71.5" y="223.8428">Any job starving for executors?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="20" x="260.5" y="217.4404">yes</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="278" x="21" y="402.2104"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="258" x="31" y="423.3491">org.jenkinsci.plugins.nomad.NomadCloud</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="118" x="101" y="456.1792"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="98" x="111" y="477.3179">Agent(pending)</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="96" x="112" y="745.231"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="76" x="122" y="766.3696">Agent(busy)</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="140" x="90" y="820.5986"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="120" x="100" y="841.7373">Agent(idle/release)</text><ellipse cx="160" cy="885.5674" fill="none" rx="11" ry="11" style="stroke:#222;stroke-width:1"/><ellipse cx="160" cy="885.5674" fill="#222222" rx="6" ry="6" style="stroke:#111;stroke-width:1"/><line style="stroke:#000;stroke-width:1.5" x1="15" x2="15" y1="12.7451" y2="896.5674"/><rect fill="#FAEBD7" height="883.8223" style="stroke:#faebd7;stroke-width:1" width="154" x="414" y="12.7451"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="144" x="420" y="527.4072"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="124" x="430" y="548.5459">calculate resources</text><line style="stroke:#000;stroke-width:1.5" x1="414" x2="414" y1="12.7451" y2="896.5674"/><rect fill="#FAEBD7" height="883.8223" style="stroke:#faebd7;stroke-width:1" width="169" x="568" y="12.7451"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="150" x="574" y="598.6353"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="130" x="584" y="619.7739">runc(opencontainer)</text><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="129" x="584.5" y="674.0029"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="109" x="594.5" y="695.1416">running agent.jar</text><line style="stroke:#000;stroke-width:1.5" x1="568" x2="568" y1="12.7451" y2="896.5674"/><line style="stroke:#000;stroke-width:1.5" x1="737" x2="737" y1="12.7451" y2="896.5674"/><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="58.6982" y2="78.6982"/><polygon fill="#454645" points="156,68.6982,160,78.6982,164,68.6982,160,72.6982" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="112.667" y2="154.0659"/><polygon fill="#454645" points="156,144.0659,160,154.0659,164,144.0659,160,148.0659" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="245" x="164" y="133.9717">hudson.model.LoadStatistics.clock(dft 10s)</text><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="290.4058" y2="338.2104"/><polygon fill="#454645" points="156,328.2104,160,338.2104,164,328.2104,160,332.2104" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="168" x="164" y="318.1162">Jenkins internal LoadBalancer</text><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="232.0347" y2="256.437"/><polygon fill="#454645" points="156,246.437,160,256.437,164,246.437,160,250.437" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="260.5" x2="342" y1="220.0347" y2="220.0347"/><polygon fill="#454645" points="338,295.3237,342,305.3237,346,295.3237,342,299.3237" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="342" x2="342" y1="220.0347" y2="382.2104"/><line style="stroke:#454645;stroke-width:1" x1="342" x2="160" y1="382.2104" y2="382.2104"/><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="382.2104" y2="402.2104"/><polygon fill="#454645" points="156,392.2104,160,402.2104,164,392.2104,160,396.2104" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="188.0347" y2="208.0347"/><polygon fill="#454645" points="156,198.0347,160,208.0347,164,198.0347,160,202.0347" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="436.1792" y2="456.1792"/><polygon fill="#454645" points="156,446.1792,160,456.1792,164,446.1792,160,450.1792" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="779.1997" y2="820.5986"/><polygon fill="#454645" points="156,810.5986,160,820.5986,164,810.5986,160,814.5986" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="122" x="164" y="800.5044">All pending jobs done</text><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="854.5674" y2="874.5674"/><polygon fill="#454645" points="156,864.5674,160,874.5674,164,864.5674,160,868.5674" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="649" x2="649" y1="632.604" y2="674.0029"/><polygon fill="#454645" points="645,664.0029,649,674.0029,653,664.0029,649,668.0029" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="79" x="653" y="653.9087">cgroup/chroot</text><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="490.1479" y2="512.4072"/><line style="stroke:#454645;stroke-width:1" x1="160" x2="492" y1="512.4072" y2="512.4072"/><line style="stroke:#454645;stroke-width:1" x1="492" x2="492" y1="512.4072" y2="527.4072"/><polygon fill="#454645" points="488,517.4072,492,527.4072,496,517.4072,492,521.4072" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="253" x="164" y="505.9072">submit a job called jenkins-agent-xxx.nomad</text><line style="stroke:#454645;stroke-width:1" x1="492" x2="492" y1="561.376" y2="583.6353"/><line style="stroke:#454645;stroke-width:1" x1="492" x2="649" y1="583.6353" y2="583.6353"/><line style="stroke:#454645;stroke-width:1" x1="649" x2="649" y1="583.6353" y2="598.6353"/><polygon fill="#454645" points="645,588.6353,649,598.6353,653,588.6353,649,592.6353" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="122" x="496" y="577.1353">bin packing algorithm</text><line style="stroke:#454645;stroke-width:1" x1="649" x2="649" y1="707.9717" y2="730.231"/><line style="stroke:#454645;stroke-width:1" x1="649" x2="160" y1="730.231" y2="730.231"/><line style="stroke:#454645;stroke-width:1" x1="160" x2="160" y1="730.231" y2="745.231"/><polygon fill="#454645" points="156,735.231,160,745.231,164,735.231,160,739.231" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="119" x="653" y="723.731">JNLP connection back</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="62" x="183.5" y="29.4531">Jenkins</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="123" x="429.5" y="29.4531">NomadServer</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="65" x="620" y="29.4531">HostOS</text></g></svg><p>when your resources(CPU/Memory) are exhausted, Nomad will refused to create agent, and shows</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Placement Failures</span><br><span class="line">  jenkins-slave-taskgroup 1 unplaced</span><br><span class="line">    Resources exhausted on 1 node</span><br><span class="line">    Dimension memory exhausted on 1 node</span><br></pre></td></tr></table></figure><p>Even the real usage of the CPU is not full.</p><h4>Networking</h4><p>Nomad uses the Serf protocal to communicate within the nodes.</p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="460px" preserveAspectRatio="none" style="width:654px;height:460px;background:#fff" version="1.1" viewBox="0 0 654 460" width="654px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g id="cluster_Host"><rect fill="none" height="218.89" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="641" x="7" y="7"/><path d="M80,7 L80,16.2969 L70,26.2969 L7,26.2969 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="63" x="10" y="20.9951">Host OS</text></g><g id="cluster_runc"><rect fill="none" height="135.89" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="497" x="119" y="58"/><path d="M413,58 L413,67.2969 L403,77.2969 L119,77.2969 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="284" x="122" y="71.9951">Containers(based on Runc)2GHz/4G</text></g><g id="elem_nomad"><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="69" x="22.5" y="109.15"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49" x="32.5" y="132.1451">Nomad</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="32.5" y="148.442">Agent</text></g><g id="elem_agent1"><rect fill="#F1F1F1" height="68.8906" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="81" x="162.5" y="101"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="172.5" y="123.9951">Agent1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="176.5" y="140.292">500MHz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="172.5" y="156.5889">1G RAM</text></g><g id="elem_agent2"><rect fill="#F1F1F1" height="68.8906" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="81" x="278.5" y="101"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="288.5" y="123.9951">Agent2</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="292.5" y="140.292">500MHz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="288.5" y="156.5889">1G RAM</text></g><g id="elem_agent3"><rect fill="#F1F1F1" height="68.8906" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="81" x="394.5" y="101"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="404.5" y="123.9951">Agent3</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="408.5" y="140.292">500MHz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="404.5" y="156.5889">1G RAM</text></g><g id="elem_agent4"><rect fill="#F1F1F1" height="68.8906" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="81" x="510.5" y="101"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="520.5" y="123.9951">Agent4</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="524.5" y="140.292">500MHz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="520.5" y="156.5889">1G RAM</text></g><g id="elem_master"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="69" x="284.5" y="288.89"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49" x="294.5" y="311.8851">Jenkins</text></g><g id="elem_server"><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="69" x="94.5" y="402.19"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49" x="104.5" y="425.1851">Nomad</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="44" x="104.5" y="441.482">Server</text></g><g id="link_nomad_runc"><path d="M91.73,135.44 C97.47,135.44 103.21,135.44 108.95,135.44 C111.82,135.44 114.69,135.44 117.56,135.44 C117.9188,135.44 118.2775,135.44 118.6363,135.44 C118.7259,135.44 118.8156,135.44 118.9053,135.44 " fill="none" id="nomad-runc" style="stroke:#454645;stroke-width:1"/></g><g id="link_master_server"><path d="M290.96,325.66 C258.66,345.97 205.34,379.49 168.76,402.49 " fill="none" id="master-to-server" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="164.94,405.52,174.6886,404.1184,169.1736,402.8597,170.4322,397.3447,164.94,405.52" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="242" y="368.2569">Resource request(HTTP)</text></g><g id="link_server_nomad"><path d="M122.71,402.07 C109.09,347.01 76.98,217.22 63.33,162.02 " fill="none" id="server-nomad" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="105" y="311.6069">Scheduling(Serf)</text></g><g id="link_agent1_master"><path d="M221.49,170.08 C232.38,189.19 246.76,213.34 261,233.89 C269.1,245.59 272.09,247.79 281,258.89 C288.9,268.73 297.74,279.7 304.91,288.59 " fill="none" id="agent1-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="282" y="254.9569">JNLP</text></g><g id="link_agent2_master"><path d="M319,170.36 C319,206.12 319,261.05 319,288.77 " fill="none" id="agent2-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g><g id="link_agent3_master"><path d="M416.52,170.09 C405.65,189.21 391.26,213.35 377,233.89 C363.52,253.29 346.4,274.2 334.26,288.49 " fill="none" id="agent3-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g><g id="link_agent4_master"><path d="M537.63,169.98 C527.9,190.73 512.95,216.62 493,233.89 C452.2,269.2 391.71,288.97 353.86,298.56 " fill="none" id="agent4-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g></g></svg><p>Jenkins to Nomad(HTTP)</p><ul><li>Requests for provision containers who will run the agent.jar</li><li>Health: Nomad will check the JVM process and recreate if required.</li></ul><p>Jenkins to Agent</p><ul><li>Two sides of the channel via TCP/WebSocket.</li><li>Persistence: for <code>DurableTask</code>, there is a file-cookie based solution.</li></ul><h2>Agent-side performace</h2><h4>Cold startup performance</h4><ul><li>Using Java 11+ with AOT and CDS</li><li>Using <a target="_blank" rel="noopener" href="https://modules.readthedocs.io/en/latest/">environment module</a> or docker image for binary consistency.</li><li>Using Cloud Storage Gateway for storage performace.</li></ul><h4>Scheduling-policy</h4><ul><li>Nomd side: You may use <a target="_blank" rel="noopener" href="https://www.nomadproject.io/docs/job-specification/affinity">affinity</a> to run jobs depends on free disk and more.</li><li>Jenkins side: Add some idle timeout for the reuse of agents.</li></ul><h2>Troubleshoot</h2><h4>when the agent.jar is down?</h4><p>There will be some errors show that</p><blockquote><p>“hudson.remoting.RequestAbortedException: java.nio.channels.AsynchronousCloseException”.</p></blockquote><p>The job would die even if the agent have restarted.</p><h4>What will happen when the master restarts?</h4><p>For <code>DurableTask</code>, there is a file-cookie solution to monitor the bash status. However, the agent.jar may lost the connection.</p><p>Please avoid master restarting while any agent is running.</p><h4>Parked thread leaking problem</h4><p>First, It is known that a thread will be stopped when code fragments end. But a thread pool can pause(park) the thread to be reused. In Jenkins, a <code>parallel</code> step can create a thread overhead.</p><p>For example, we submit a pipeline job for a stress test, creating a lot of threads in parallels.</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pipeline&#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        label <span class="string">&quot;test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages&#123;</span><br><span class="line">        stage(<span class="string">&#x27;init&#x27;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="keyword">def</span> jobs = [:]</span><br><span class="line">                    <span class="number">100.</span>times&#123;</span><br><span class="line">                        jobs[<span class="string">&quot;task&quot;</span> + it] =&#123; echo <span class="string">&quot;1&quot;</span>&#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    parallel(jobs);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You will see the threads increasing during the workload, but when all jobs are done, parked threads are <strong>not released</strong>. By using <code>top</code>, you may find that <strong>your native threads are also not released</strong> which means</p><ul><li>You will leak native stack size(or Xss) on master.</li><li>You will leak <code>/proc/sys/kernel/threads-max</code> .</li><li>You will face <code>Unable to create new native thread</code> when you deploy too many agents.</li></ul><p>What you need to do</p><ul><li>Increase more heap memory in the case of OOM.</li><li>Increase more ulimt or decrease Xss(eg: <code>-Xss256K</code>) or restart the agent periodically in case of the parking thread are not released.</li><li>Modify code of the threadpool. (Only if you really have too many agents.)</li></ul><h4>Preserve images while agents are getting stopped</h4><p>By default, nomad will remove your agent’s docker image after 5 minus. To avoid re-download images, please see the configs at <a target="_blank" rel="noopener" href="https://www.nomadproject.io/docs/drivers/docker#gc">here</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># on nomad&#x27;s client-&gt;plugin &quot;docker&quot;-&gt;config</span><br><span class="line">gc &#123;</span><br><span class="line">    image = false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2>Reference</h2><ul><li><a target="_blank" rel="noopener" href="https://blog.codecentric.de/en/2017/11/microservices-nomad-consul/">https://blog.codecentric.de/en/2017/11/microservices-nomad-consul/</a></li></ul></div><div class="tags"><a class="tag-link" href="/tags/DevOps/" rel="tag">DevOps</a><a class="tag-link" href="/tags/Jenkins/" rel="tag">Jenkins</a><a class="tag-link" href="/tags/Nomad/" rel="tag">Nomad</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry</a><span>.</span></div></footer></div></body></html>