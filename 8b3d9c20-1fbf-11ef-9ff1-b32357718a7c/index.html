<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="This guide outlines an approach to upgrading Subversion servers."><meta name="keyword" content="DevOps,Subversion"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>A guide to upgrade subversion to 1.14</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">A guide to upgrade subversion to 1.14</div><div class="date no-print">2024-06-08 / modified at 2025-10-08 / 1.3k words / 8 mins</div><div class="content"><p>This guide outlines an approach to upgrading Subversion servers.</p><span id="more"></span><p>Though subversion’s popularity has declined in favor of Git over recent years, it remains prevalent in gaming or hardware industries duo to its simplified large file management and folder-grained permissions.</p><p>Unlike the Gitlab upgrade, upgrading subversion servers requires deeper knowledge of operation systems, Apache configurations, and subversion repository structures.</p><h2>Background</h2><p>Before getting started, it’s essential to understand the internal schema and structures of a subversion repository.</p><h4>Subversion repository structure</h4><p>When creating a repository using <code>svnadmin create &lt;repo_name&gt;</code>, the following directories are generated:</p><ul><li><p>conf: Stores the <code>authz</code> file and other secrets. <em>Note</em>: The authentication file are often managed by Apache’s httpd.conf in production.</p></li><li><p>db: Contains data/metadata managed by FSFS, where internal structures could be found <a target="_blank" rel="noopener" href="https://svn.apache.org/repos/asf/subversion/trunk/subversion/libsvn_fs_fs/structure">at the Apache document</a>. We’ll use dump &amp; load scripts to migrate them from old schema(fsfs4/6/7) into the latest schema(fsfs8)</p><ul><li>revs/revprops: Stores the data and metadata.</li><li>locks: The key-value storage that persists locks from users, you can track user locks via <code>svnadmin lslocks</code>.</li><li>transactions/txn: The temporary sqlite file which is stored before running hooks.</li></ul></li><li><p>hooks: Custom scripts (won’t get transferred during dump/load).</p></li></ul><h4>Subversion file system schema compatibility matrix</h4><p>The diagram here shows the compatibility matrix of the FSFS schema.</p><table><thead><tr><th>FSFS Schema</th><th>Minimal Subversion Server</th><th>Compatible Subversion Server</th><th>Notable Features</th></tr></thead><tbody><tr><td>4</td><td>1.6</td><td>1.6~1.14</td><td>shading</td></tr><tr><td>6</td><td>1.8</td><td>1.8~1.14</td><td>packing</td></tr><tr><td>7</td><td>1.9</td><td>1.9~1.14</td><td>logical revision</td></tr><tr><td>8</td><td>1.10</td><td>1.10~1.14</td><td>Lz4 compression</td></tr></tbody></table><p>Subversion binary keeps compatibility with legacy schema. However, if you need better performance, less disk consumption, and more features, you may upgrade the repository schema as well.</p><p>For instance, if the existing subversion server is 1.6 with fsfs4 repositories, two choices could be applied for the upgrade:</p><ul><li><strong>Binaray-only upgrade</strong>: Update subversion binaries (e.g., from 1.6 to 1.14).</li><li><strong>Full upgrade</strong>: Besides the binary upgrade, reload the repository file into the fresh fsfs8 schema.</li></ul><h4>Relationship between dump, load, and upgrade</h4><p>In the <code>svnadmin</code> document, three commands can be used for the upgrade:</p><ul><li>dump: dump the repository into a fsfs4-formatted stdout stream or file.</li><li>Load: load the dump file or stdin into the new repository.</li><li>Upgrade: The <a target="_blank" rel="noopener" href="https://svnbook.red-bean.com/en/1.7/svn.ref.svn.c.upgrade.html">document</a> is ambiguous, the command <code>upgrade</code> is not an in-place upgrade, it just updates the metadata flag of the existing repository without the internal file restructured.</li><li>Dump &amp; load pipe: It’s the best solution to upgrade the schema without large space consumed. Commands are invoked in piped operation <code>svnadmin dump [existing_repo] | svnadmin load &gt; [new_repo]</code>. Furthermore, an SSH piped tunnel could be applied between two machines.</li></ul><h2>Upgrade overview</h2><p>There are two upgrade approaches:</p><ul><li>the first is an in-place upgrade, which requires a rollback plan and is constrained by downtime.</li><li>The second approach is migration, which involves creating a fresh node and retiring the old one; however, it requires additional temporary storage and computational resources.</li></ul><p>In our deployment environment, with the liability accumulated, it’s too late to implement an in-place upgrade, we have to create new machines and migrate the source code from one to another, as well as permission, hook and lock files.</p><h4>Analyse current deployment</h4><p>Before the migration, we’d like to have a full understanding of the current subversion deployment.</p><ul><li>Networking: Visualize the current structure of the physical nodes and their relationship. Find out which processes are listening on the machine, and which ports are managed under the firewall.</li><li>Storage: Calculate the storage usage of our repositories to help estimate the time consumption of the migration, and estimate the storage size prepared for the new location.</li><li>Jobs: Some crontab jobs might be running for decades, be careful with the hardcode scripts.</li></ul><h4>Migration outlook</h4><p>Upgrading legency system always involves complex planning and strategic decision-making. Here are some key steps to help you approach the upgrade effectively.</p><ul><li>(Optional) Prepare a CName/ELB switchover plan if there needs a re-routing between machines.</li><li>Prepare new machines for the subversion, I prefer installing with RockyOS.</li><li>Install the new subversion(1.14.x with fsfs8) on the new machines using yum or <a target="_blank" rel="noopener" href="https://cirata.com/source-code-management/subversion#binaries">free wandisco certificated subversion</a>. You may dockerize the Apache and subversion into an all-in-one image.</li><li>Install the Apache httpd instance to the latest version 2.4.x using yum.</li><li>Migrate repository files using dump and load.</li></ul><h2>Upgrade Steps</h2><h4>CName/ELB Setep</h4><p>If the existing httpd service is behind an ELB/VIP or managed by a DNS server, an IP address switchover is required during the migration.</p><h4>Install subversion binary file</h4><p>I’d recommend using the <a target="_blank" rel="noopener" href="https://cirata.com/source-code-management/subversion#binaries">free wandisco certificated subversion</a>, as it is fully tested and provides the latest bug fix. It could be too late to wait for the release of OS packages.</p><blockquote><p>Don’t forget to remove the embedded subversion in the operation system. Or you might create a repository with the legacy version.</p></blockquote><h4>Install Apache httpd</h4><ul><li>Install the latest Apache httpd, or compile from the source.</li><li>Migrate httpd conf grammar if the ancestor instance is httpd 2.2.x</li><li>Configure the location of <code>mod_dav_svn.so</code> to make authz work.</li></ul><h4>Initial synchronization</h4><p>During the dumpload, there is no downtime required. You may also write a parallel synchronization script if you have thousands of repositories.</p><ul><li><p>Verify existing repositories with <code>svnadmin verify</code></p></li><li><p>Create the new repo with a dump &amp; load piped script, and accomplish the first full dump &amp; load.</p><ul><li>Create new repositories in the new machine: <code>svnadmin create &lt;YOUR_REPO&gt;</code>. You may check the fsfs shema with <code>svn info</code>.</li><li>Dumpload on the old machine, the persuade piped script is: <code>svnadmin dump &lt;OLD_REPO&gt; | ssh svnuser@newnode &quot;svnadmin load&quot; &gt;&gt; &lt;NEW_REPO&gt;</code></li></ul></li><li><p>Verify the checksum of new repositories with <code>svnadmin verify</code>.</p></li><li><p>Send emails to users to help users know the downtime window and the post-migration URLs.</p></li></ul><h4>Incremental synchronization [With Downtime]</h4><ul><li>Stop the old servers, or make them read-only.</li><li>Resynchronize the delta data with the piped script again.</li><li>Copy the lock and hook folders from the old location into the new location, or skip the migration if they are no longer used by users.</li></ul><h4>Consistency checking [With Downtime]</h4><p>It’s time to check the consistency between the two repositories. The following check involves the checksum validation of files, locks, and logs of a subversion folder.</p><ul><li>generate checksum of locks: <code>svnadmin lslocks &lt;YOUR_REPO&gt; | sha1sum | head -c 40</code></li><li>generate checksum of file treeview: <code>svn ls -R file://&lt;YOUR_REPO&gt; | sha1sum | head -c 40</code></li><li>generate checksum of commit logs: <code>svn log file://&lt;YOUR_REPO&gt; | sha1sum | head -c 40</code></li></ul><p>The checksum must be the same between the two nodes, if they are not the same, you need to retry the synchronization.</p><h4>Start the new server</h4><p>It’s believed that the new server is ready for users, we can turn off the old server and start the new one.</p><h4>DNS switchover</h4><p>Switch the DNS/ELB to the new server.</p><p>If users are accessing the server via a hardcoded IP/hostname that can’t be switched easily, it’s necessary to configure a reverse proxy on the old instance after the migration, so that jobs such as Jenkins build or Master-slave synchronization continue to serve well.</p><h2>Summary</h2><p>It’s a giant process if the servers haven’t been upgraded for decades. As a result, implementing the migration requires patient and enumerative checklists.</p><h4>Paid Solution</h4><p>If you are unfamiliar with the maintenance of subversion, I’d recommend engage vendor support to reduce risks.</p><ul><li>WANdisco SVN MultiSite Plus</li><li>Visual SVN</li></ul><h4>Apache Httpd Security Tips</h4><p>As the Apache is famous for its <a target="_blank" rel="noopener" href="https://httpd.apache.org/security/vulnerabilities_24.html">vulnerability</a>, here is the checklist to make the server safer</p><ul><li>Hide Apache version: Use <code>ServerTokens Prod</code> and <code>ServerSignature Off</code> to hide your OS and Apache version.</li><li>Network policy: Enable SSL encryption, and audit logging. Apply Network ACLs inside the subnet.</li><li>Follow the <a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/2.4/misc/security_tips.html">guide</a>.</li></ul></div><div class="tags"><a class="tag-link" href="/tags/DevOps/" rel="tag">DevOps</a><a class="tag-link" href="/tags/Subversion/" rel="tag">Subversion</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>