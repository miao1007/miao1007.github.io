<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="本文总结一下常见的分布式与高可用方案"><meta name="keyword" content="PaaS"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>常见分布式系统介绍</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">常见分布式系统介绍</div><div class="date no-print">2021-08-04 / modified at 2024-06-01 / 2.5k words / 10 mins</div><div class="content"><blockquote><span>️This article has been <strong>over 1 years</strong> since the last update.</span></blockquote><p>本文总结一下常见的分布式与高可用方案</p><span id="more"></span><h2>什么是分布式系统</h2><p>定义一：A distributed system is a collection of autonomous computing elements that appears to its users as a single coherent/koˈhɪrǝnt/ system.</p><p>翻译过来，就是对用户看起来是单体，但是实际上是由独立自治的计算组件聚合而成的系统。</p><ul><li>autonomous: having the freedom to act independently.</li><li>computing elements: node, can be HPC, VM, Thread and more.</li><li>collection: is often organized as an overlay network. Eg: p2p, TCP/IP</li><li>coherent: a distributed system is coherent if it behaves according to the expectations of its users. 注意这里是用户对<strong>主观</strong>现象的观测，而非客观的定义，如果换个较真的人观察出破绽，那么它就是不是&quot;单体&quot;了。</li></ul><p>定义二：A distributed system consists of a collection of distinct processes which are spatially separated, and which com- municate with one another by exchanging messages</p><p>一个分布式系统是多个空间上分离，使用内部通信的独立<strong>流程</strong>组合的集合。</p><p>从这里的定义可以看出，分布式系统是一个经验归纳大于理论演绎的定义。它涉及到了同一（identity）关系的哲学问题（忒修斯之船），与时间颗粒度息息相关。</p><blockquote><p>机房里的CPU换了2次，内存换了3次，它还是这套集群吗？虚拟机通过热迁移技术切换到另一个机柜的设备中，它还是你的VM吗？</p></blockquote><h2>可靠和可用</h2><p><strong>High availability</strong> (<strong>HA</strong>) is a characteristic of a system which aims to ensure an agreed level of operational performance, usually <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Uptime">uptime</a>, for a higher than normal period.</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="303px" preserveAspectRatio="none" style="width:857px;height:303px;background:#fff" version="1.1" viewBox="0 0 857 303" width="857px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="87.1289" x="10" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.1289" x="20" y="155.5889">resilience</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="306.2538" x="147.1289" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="286.2538" x="157.1289" y="99.292">&#21487;&#38752;&#24615;&#65306;&#65288;&#26080;&#25925;&#38556;&#26102;&#38388;&#65289;/&#65288;&#26080;&#25925;&#38556;&#26102;&#38388; + 1&#65289;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="341.9986" x="503.3827" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="321.9986" x="513.3827" y="42.9951">&#36890;&#36807;&#23458;&#35266;&#30340;&#22120;&#20214;&#22833;&#25928;&#24471;&#21040;&#30340;&#32479;&#35745;&#25968;&#25454;&#65292;&#19981;&#28041;&#21450;&#20462;&#22797;&#12290;</text><path d="M453.3827,94.4453 L463.3827,94.4453 C478.3827,94.4453 478.3827,38.1484 493.3827,38.1484 L503.3827,38.1484" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="332.7155" x="503.3827" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="312.7155" x="513.3827" y="99.292">&#21407;&#23376;&#31995;&#32479;&#65306;&#27604;&#22914;&#20803;&#20214;&#32769;&#21270;/&#28201;&#24230;&#31561;&#23458;&#35266;&#30340;&#32479;&#35745;&#25968;&#25454;&#12290;</text><path d="M453.3827,94.4453 L463.3827,94.4453 C478.3827,94.4453 478.3827,94.4453 493.3827,94.4453 L503.3827,94.4453" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="290.7156" x="503.3827" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="270.7156" x="513.3827" y="155.5889">&#32452;&#21512;&#31995;&#32479;&#65306;&#28041;&#21450;&#21040;&#21407;&#23376;&#31995;&#32479;&#30340;&#20018;&#32852;/&#24182;&#32852;&#32452;&#21512;</text><path d="M453.3827,94.4453 L463.3827,94.4453 C478.3827,94.4453 478.3827,150.7422 493.3827,150.7422 L503.3827,150.7422" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M97.1289,150.7422 L107.1289,150.7422 C122.1289,150.7422 122.1289,94.4453 137.1289,94.4453 L147.1289,94.4453" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="344.4459" x="147.1289" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="324.4459" x="157.1289" y="240.0342">&#21487;&#29992;&#24615;&#65306;&#65288;&#26080;&#25925;&#38556;&#26102;&#38388;&#65289;/&#65288;&#26080;&#25925;&#38556;&#26102;&#38388;+&#20462;&#22797;&#26102;&#38388;&#65289;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="187.9993" x="541.5748" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167.9993" x="551.5748" y="211.8857">&#25552;&#39640;&#26080;&#25925;&#38556;&#26102;&#38388;&#65288;&#21487;&#38752;&#24615;&#65289;</text><path d="M491.5748,235.1875 L501.5748,235.1875 C516.5748,235.1875 516.5748,207.0391 531.5748,207.0391 L541.5748,207.0391" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="103.9996" x="541.5748" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.9996" x="551.5748" y="268.1826">&#25552;&#39640;&#20462;&#22797;&#36895;&#24230;</text><path d="M491.5748,235.1875 L501.5748,235.1875 C516.5748,235.1875 516.5748,263.3359 531.5748,263.3359 L541.5748,263.3359" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M97.1289,150.7422 L107.1289,150.7422 C122.1289,150.7422 122.1289,235.1875 137.1289,235.1875 L147.1289,235.1875" fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><p>分布式系统一般讨论的是高可用中的可靠性的组合场景，比如冗余或者切片。</p><blockquote><p>分布式不等于高可用(availability)，不等于高可靠(durability)，不等于弹性伸缩，不等于冗余，不等于克服了单点故障，也不提供掉电保护。</p></blockquote><h2>硬件分布式系统分类</h2><p>硬件上主要体现在冗余性，虚拟直通，存算分离上</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="556px" preserveAspectRatio="none" style="width:819px;height:556px;background:#fff" version="1.1" viewBox="0 0 819 556" width="819px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="75.9998" x="10" y="259.2617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.9998" x="20" y="282.2568">&#30828;&#20214;&#20132;&#20184;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="89.9997" x="135.9998" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="145.9998" y="99.292">&#26426;&#26588;&#21487;&#29992;&#24615;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="89.9997" x="275.9995" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="285.9995" y="42.9951">&#21452;&#20809;&#21475;&#20132;&#25442;</text><path d="M225.9995,94.4453 L235.9995,94.4453 C250.9995,94.4453 250.9995,38.1484 265.9995,38.1484 L275.9995,38.1484" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="108.2927" x="275.9995" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88.2927" x="285.9995" y="99.292">&#20887;&#20313;&#30005;&#28304;/UPS</text><path d="M225.9995,94.4453 L235.9995,94.4453 C250.9995,94.4453 250.9995,94.4453 265.9995,94.4453 L275.9995,94.4453" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="142.9233" x="275.9995" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122.9233" x="285.9995" y="155.5889">&#36328;&#26426;&#26588;&#37096;&#32626;(&#39118;&#27700;&#30005;)</text><path d="M225.9995,94.4453 L235.9995,94.4453 C250.9995,94.4453 250.9995,150.7422 265.9995,150.7422 L275.9995,150.7422" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M85.9998,277.4102 L95.9998,277.4102 C110.9998,277.4102 110.9998,94.4453 125.9998,94.4453 L135.9998,94.4453" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="89.9997" x="135.9998" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="145.9998" y="211.8857">&#26426;&#25151;&#21487;&#29992;&#24615;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="134.0914" x="275.9995" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114.0914" x="285.9995" y="211.8857">&#36328;&#21487;&#29992;&#21306;(AZ)&#37096;&#32626;</text><path d="M225.9995,207.0391 L235.9995,207.0391 C250.9995,207.0391 250.9995,207.0391 265.9995,207.0391 L275.9995,207.0391" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M85.9998,277.4102 L95.9998,277.4102 C110.9998,277.4102 110.9998,207.0391 125.9998,207.0391 L135.9998,207.0391" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="209.6492" x="135.9998" y="371.8555"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="189.6492" x="145.9998" y="394.8506">OpenStack/&#31169;&#26377;&#20113;(eg: HCS)</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="395.649" y="287.4102"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="405.649" y="310.4053">&#35745;&#31639;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="61.9998" x="493.6489" y="273.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41.9998" x="503.6489" y="296.3311">&#34394;&#25311;&#21270;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="152.4118" x="605.6487" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="132.4118" x="615.6487" y="268.1826">&#23436;&#20840;&#34394;&#25311;&#21270;/emulate</text><path d="M555.6487,291.4844 L565.6487,291.4844 C580.6487,291.4844 580.6487,263.3359 595.6487,263.3359 L605.6487,263.3359" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="80.4364" x="605.6487" y="301.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60.4364" x="615.6487" y="324.4795">DMA&#30452;&#36890;</text><path d="M555.6487,291.4844 L565.6487,291.4844 C580.6487,291.4844 580.6487,319.6328 595.6487,319.6328 L605.6487,319.6328" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M443.6489,305.5586 L453.6489,305.5586 C468.6489,305.5586 468.6489,291.4844 483.6489,291.4844 L493.6489,291.4844" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="61.9998" x="493.6489" y="329.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41.9998" x="503.6489" y="352.6279">&#35064;&#37329;&#23646;</text><path d="M443.6489,305.5586 L453.6489,305.5586 C468.6489,305.5586 468.6489,347.7813 483.6489,347.7813 L493.6489,347.7813" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M345.649,390.0039 L355.649,390.0039 C370.649,390.0039 370.649,305.5586 385.649,305.5586 L395.649,305.5586" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="395.649" y="442.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="405.649" y="465.2217">&#23384;&#20648;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="75.9998" x="493.6489" y="385.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.9998" x="503.6489" y="408.9248">&#23545;&#35937;&#23384;&#20648;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="187.9993" x="619.6486" y="385.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167.9993" x="629.6486" y="408.9248">&#22522;&#20110;&#23545;&#35937;&#23384;&#20648;&#30340;&#20998;&#24067;&#24335;&#23384;&#20648;</text><path d="M569.6486,404.0781 L579.6486,404.0781 C594.6486,404.0781 594.6486,404.0781 609.6486,404.0781 L619.6486,404.0781" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M443.6489,460.375 L453.6489,460.375 C468.6489,460.375 468.6489,404.0781 483.6489,404.0781 L493.6489,404.0781" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="108.7164" x="493.6489" y="442.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88.7164" x="503.6489" y="465.2217">&#22359;&#23384;&#20648;/&#20113;&#30828;&#30424;</text><path d="M443.6489,460.375 L453.6489,460.375 C468.6489,460.375 468.6489,460.375 483.6489,460.375 L493.6489,460.375" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="179.8374" x="493.6489" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159.8374" x="503.6489" y="521.5186">RoCE(&#26412;&#36136;&#19978;&#20173;&#28982;&#26159;&#22797;&#21046;)</text><path d="M443.6489,460.375 L453.6489,460.375 C468.6489,460.375 468.6489,516.6719 483.6489,516.6719 L493.6489,516.6719" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M345.649,390.0039 L355.649,390.0039 C370.649,390.0039 370.649,460.375 385.649,460.375 L395.649,460.375" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="50.1396" x="395.649" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.1396" x="405.649" y="521.5186">SDN</text><path d="M345.649,390.0039 L355.649,390.0039 C370.649,390.0039 370.649,516.6719 385.649,516.6719 L395.649,516.6719" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M85.9998,277.4102 L95.9998,277.4102 C110.9998,277.4102 110.9998,390.0039 125.9998,390.0039 L135.9998,390.0039" fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><p>上述可以确保VM与内存数据几乎不会丢失，但是VM中运行的软件本身仍然可能挂掉。</p><h2>软件分布式系统分类</h2><h3>理论的维度</h3><p>假如需要进行专业的体系化CS课程，至少半年，可以参考如下</p><ul><li><p>Distributed Computing Systems(<a target="_blank" rel="noopener" href="https://www.ics.uci.edu/~cs230/lectures20/distrsyslectureset1-win21.pdf">cs230</a>)</p><ul><li><p>时间：物理时间（比如ntp同步）与逻辑时间（比如term）</p></li><li><p>状态：全局状态与快照</p></li><li><p>Distributed Coordination and Resource Management</p></li><li><p>Messaging and Communication in Distributed Systems</p></li><li><p>Fault Tolerance in Distributed Systems</p></li></ul></li><li><p>Security in Distributed Systems</p></li><li><p>Distributed Database Management and Transaction Processin(<a target="_blank" rel="noopener" href="https://www.ics.uci.edu/~cs223/">cs223</a>)</p></li><li><p>Distributed Objects and Middleware Platforms(<a target="_blank" rel="noopener" href="https://www.ics.uci.edu/~cs237/">cs237</a>)</p></li></ul><p>这里理论比工程更重要，而且是存粹的理论。</p><h3>工程上的规格</h3><p>假如只是进行概念的理解，如下即可</p><ul><li><p>一致性：强一致性、最终一致性</p></li><li><p>需要分布管理的内容：比如</p><ul><li>元数据（比如k-v、状态、健康）</li><li>二进制（比如S3/Git/SVN/Lustre/边缘SDN）</li></ul></li><li><p>协商方向：</p><ul><li>Push：下游需要全量数据时才使用，比如Database streaming/mirroring，RAFT</li><li>Pull：下游需要部分数据即可，如二进制增量缓存/看门狗等场景</li><li>Proxy：比如<a target="_blank" rel="noopener" href="https://about.gitlab.com/solutions/geo/">Gitlab geo</a>的写入方案，cloudflare的Worker读写方案</li></ul></li><li><p>节点角色：广义上也可以看作政治权利，比如说“不”的权利。</p></li><li><p>故障转移时间RTO：一般商用需要为10s</p></li></ul><h3>按照组网架构分类</h3><p>常见组网架构如下</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="241px" preserveAspectRatio="none" style="width:545px;height:241px;background:#fff" version="1.1" viewBox="0 0 545 241" width="545px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="85.1875" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="33.9999" x="10" y="77.0371"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="20" y="100.0322">&#37096;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="20" y="116.3291">&#32626;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="20" y="132.626">&#26550;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="20" y="148.9229">&#26500;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="116.8651" x="93.9999" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96.8651" x="103.9999" y="42.9951">&#21333;&#26426;/Stateless</text><path d="M43.9999,119.6309 L53.9999,119.6309 C68.9999,119.6309 68.9999,38.1484 83.9999,38.1484 L93.9999,38.1484" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="162.9805" x="93.9999" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.9998" x="103.9999" y="99.292">&#20027;&#20174;&#20004;&#26426;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="142.9805" x="103.9999" y="115.5889">(primary/secondary)</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="306.9804" y="70.3711"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="316.9804" y="93.3662">&#28909;&#22791;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="103.9996" x="404.9803" y="42.2227"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.9996" x="414.9803" y="65.2178">&#25346;&#20102;&#31435;&#21051;&#21482;&#35835;</text><path d="M354.9803,88.5195 L364.9803,88.5195 C379.9803,88.5195 379.9803,60.3711 394.9803,60.3711 L404.9803,60.3711" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="128.5066" x="404.9803" y="98.5195"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="108.5066" x="414.9803" y="121.5146">&#33258;&#21160;failover&#20999;&#25442;</text><path d="M354.9803,88.5195 L364.9803,88.5195 C379.9803,88.5195 379.9803,116.668 394.9803,116.668 L404.9803,116.668" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M256.9804,102.5938 L266.9804,102.5938 C281.9804,102.5938 281.9804,88.5195 296.9804,88.5195 L306.9804,88.5195" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="306.9804" y="126.668"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="316.9804" y="149.6631">&#20919;&#22791;</text><path d="M256.9804,102.5938 L266.9804,102.5938 C281.9804,102.5938 281.9804,144.8164 296.9804,144.8164 L306.9804,144.8164" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M43.9999,119.6309 L53.9999,119.6309 C68.9999,119.6309 68.9999,102.5938 83.9999,102.5938 L93.9999,102.5938" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="75.9998" x="93.9999" y="182.9648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.9998" x="103.9999" y="205.96">&#19977;&#21488;&#20197;&#19978;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="146.1499" x="219.9997" y="182.9648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126.1499" x="229.9997" y="205.96">&#36873;&#20030;/&#22797;&#21046;/&#36716;&#21457;/&#36335;&#30001;</text><path d="M169.9997,201.1133 L179.9997,201.1133 C194.9997,201.1133 194.9997,201.1133 209.9997,201.1133 L219.9997,201.1133" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M43.9999,119.6309 L53.9999,119.6309 C68.9999,119.6309 68.9999,201.1133 83.9999,201.1133 L93.9999,201.1133" fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><blockquote><p>上述方案假设在高速LAN中横向通信，不含容灾。上述成本基本上都比托管的服务更高，也不包含硬件存储架构方案。<br>事实上云服务厂商的硬件实现的分布式存储才是最简方案。</p></blockquote><h4>工程经验类方法</h4><p>工程实践的核心思路是将本侧的分布式难题交给下游供应商，进而提高收益，比如</p><ul><li><p>将业务分解为meta/worker/proxy等无状态的服务，比如sonarqube的ComputeEngine</p></li><li><p>用硬件的RDMA/NFS转换问题，比如Oracle RAC就强制要求超高性能内网，否则直接停机。</p></li><li><p>用软件的数据库/Raft，基于元数据实现分片，比如在三个数据中心搭建<code>2+2+1</code>的高可用的quorum</p></li><li><p>用云服务，比如FSFO(by Oracle)，或者GaussDB<a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/256888">参考</a>，用Aurora把难题扔给AWS。然而云服务事实上并不兜底，最多赔偿一点代金券，相对业务损失不值一提。</p></li></ul><h2>主备方案介绍</h2><p>大部分有状态的主备份方案为冗余方案（hot standby），难点在同步复制协议（Primary/Replica）。它要求的性能与可用性（断电前写入存储介质）中取得平衡</p><ul><li>协议：主要为基于Journaling的checkpoint和reply的方案</li><li>强一致类型：写入IO性能变弱，可以实现读写分离，任意一台挂掉需要人工介入</li><li>最终一致类型：基本上就是靠事件+定时同步，可以容灾</li></ul><p>常见如下</p><table><thead><tr><th>类型</th><th>复制协议</th><th>Monitoring node</th><th>自动恢复</th><th>读写分离</th></tr></thead><tbody><tr><td>Jenkins</td><td>NFS/rsync innotify</td><td>0</td><td>需要手动</td><td>NA</td></tr><tr><td>GitLab(unofficial)</td><td>NFS/rsync innotify</td><td>keepalived</td><td>Y</td><td>勉强够用</td></tr><tr><td>MySQL</td><td>Async Binlog</td><td>0</td><td>需要手动</td><td>N</td></tr><tr><td>pg-pool</td><td>WAL</td><td>1</td><td>需要手动</td><td>Y</td></tr><tr><td>Redis</td><td>Async AOF/RDB</td><td>0</td><td>需要手动</td><td>N</td></tr><tr><td>Redis(Sentinel)</td><td>Async AOF/RDB</td><td>1~3(Sentinel)</td><td>Y，比如5s</td><td>N</td></tr><tr><td>Artifactory-Remote</td><td>Pull</td><td>NA</td><td>NA</td><td>NA</td></tr></tbody></table><p>从我个人实践的角度，热主备方案投资收益极为鸡肋</p><ul><li>大部分都无法扩容，中间的代理层导致应用定位复杂（需要额外的Client/Agent 来判活，比如pg-pool的连接池在项目中出现2次大故障，定位起来资料困乏）</li><li>冗余框架出了问题仍然要手动维修，万一真挂了，重启也修不好</li><li>自动切换需要客户端适配协商，引入繁琐的非业务用例，比如需要做“监控的监控”</li></ul><p>上述方案其实意义有限，甚至整体恢复时间不如单机版+极速备份回滚</p><h2>三台以上高可用方案</h2><h4>一致性与过期(consistance and stale)的定义</h4><p>谈到一致性，很多人就想到了被阿里带歪的CAP八股文，我们要先明确</p><ul><li>一致需要<strong>同时</strong>考虑客户端与服务端的配置，你搭建三台号称强一致性的ZK，并不代表业务就有了强一致性</li><li>CAP并不是要求三选二，而是大部分情况“我全都要”，而且主要是客户端自己决定</li></ul><p>举一些例子</p><ul><li>当etcd挂了，K8S里的应用服务仍然能跑，Calico也勉强能用，客户端缓存还在，只是部分控制域的功能丢失</li><li>Consul既支持客户端绕一圈获取协商结果（network roundtrips，耗时长），也支持直接读取单节点数据，甚至客户端/Sidecar节点本身就有一定缓存</li><li>Oracle RAC是集群数据库，它需要处理转账等强一致业务，一旦RDMA集群间断网就直接停机。</li><li>你在两个数据中心部署了2+3个zk，然后部署三台的机房突然停电，另外两台也照样完蛋。</li></ul><h4>基于元数据管理的方案</h4><p>元数据既可以通过集中管理，也可以通过分散管理</p><ul><li>分散：区块链、GlusterFS与DHT BT下载等场景，以及跨DC的<a target="_blank" rel="noopener" href="https://github.blog/2016-09-07-building-resilience-in-spokes/">Github Spokes</a> 服务</li><li>集中：常见的BT的tracker协议，以及RAFT/Paxo/Gossip（这里讨论）</li></ul><p>我们首先要明确，在中心化的一致性元数据管理中，并没有实现扩容</p><ul><li>用于数据面（比如分片）与控制面（比如路由）的元数据存储仍然需要<strong>中心化的权威存储介质</strong>(have a single primary copy at any moment.)，并基于强一致性实现多机冗余。就算是DHT表，也不会同步到所有客户端机器。</li><li>剩余节点是无状态运算机，可以扩容</li></ul><p>跨WAN的Region场景，默认是不可靠的，一般要最终一致性，这种流程可以简化容灾，跨Site同步等流程。</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="810px" preserveAspectRatio="none" style="width:592px;height:810px;background:#fff" version="1.1" viewBox="0 0 592 810" width="592px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="85.1875" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="33.9999" x="10" y="361.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="20" y="384.4795">&#20998;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="20" y="400.7764">&#21306;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="20" y="417.0732">&#26041;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="20" y="433.3701">&#26696;</text><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="82.5555" x="93.9999" y="265.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.5555" x="103.9999" y="288.1826">&#36328;DC&#22797;&#21046;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41.9998" x="103.9999" y="304.4795">&#24378;&#19968;&#33268;</text><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="135.0625" x="226.5554" y="96.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="236.5554" y="119.292">&#20803;&#25968;&#25454;&#26381;&#21153;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.0625" x="236.5554" y="135.5889">Metadata server</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="144.8652" x="411.6179" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="124.8652" x="421.6179" y="42.9951">Zookeeper(PAXO)</text><path d="M361.6179,122.5938 L371.6179,122.5938 C386.6179,122.5938 386.6179,38.1484 401.6179,38.1484 L411.6179,38.1484" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="97.752" x="411.6179" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="77.752" x="421.6179" y="99.292">Etcd(RAFT)</text><path d="M361.6179,122.5938 L371.6179,122.5938 C386.6179,122.5938 386.6179,94.4453 401.6179,94.4453 L411.6179,94.4453" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="168.9619" x="411.6179" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="148.9619" x="421.6179" y="155.5889">Nomad/Consul(RAFT)</text><path d="M361.6179,122.5938 L371.6179,122.5938 C386.6179,122.5938 386.6179,150.7422 401.6179,150.7422 L411.6179,150.7422" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="133.9688" x="411.6179" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="113.9688" x="421.6179" y="211.8857">RedisRaft(RAFT)</text><path d="M361.6179,122.5938 L371.6179,122.5938 C386.6179,122.5938 386.6179,207.0391 401.6179,207.0391 L411.6179,207.0391" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M176.5554,291.4844 L186.5554,291.4844 C201.5554,291.4844 201.5554,122.5938 216.5554,122.5938 L226.5554,122.5938" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="86.2949" x="226.5554" y="377.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66.2949" x="236.5554" y="400.7764">Metadata</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47.0244" x="236.5554" y="417.0732">Router</text><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="78.9736" x="362.8503" y="265.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18.7578" x="372.8503" y="288.1826">KV</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58.9736" x="372.8503" y="304.4795">Partition</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="62.3965" x="491.824" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42.3965" x="501.824" y="268.1826">Calico</text><path d="M441.824,291.4844 L451.824,291.4844 C466.824,291.4844 466.824,263.3359 481.824,263.3359 L491.824,263.3359" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="62.6221" x="491.824" y="301.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42.6221" x="501.824" y="324.4795">envoy</text><path d="M441.824,291.4844 L451.824,291.4844 C466.824,291.4844 466.824,319.6328 481.824,319.6328 L491.824,319.6328" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M312.8503,404.0781 L322.8503,404.0781 C337.8503,404.0781 337.8503,291.4844 352.8503,291.4844 L362.8503,291.4844" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="49.8594" x="362.8503" y="414.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29.8594" x="372.8503" y="437.0732">DHT</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="87.7031" x="462.7097" y="357.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.7031" x="472.7097" y="380.7764">GlusterFS</text><path d="M412.7097,432.2266 L422.7097,432.2266 C437.7097,432.2266 437.7097,375.9297 452.7097,375.9297 L462.7097,375.9297" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="73.0879" x="462.7097" y="414.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53.0879" x="472.7097" y="437.0732">CephFS</text><path d="M412.7097,432.2266 L422.7097,432.2266 C437.7097,432.2266 437.7097,432.2266 452.7097,432.2266 L462.7097,432.2266" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="63.8252" x="462.7097" y="470.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43.8252" x="472.7097" y="493.3701">Lustre</text><path d="M412.7097,432.2266 L422.7097,432.2266 C437.7097,432.2266 437.7097,488.5234 452.7097,488.5234 L462.7097,488.5234" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M312.8503,404.0781 L322.8503,404.0781 C337.8503,404.0781 337.8503,432.2266 352.8503,432.2266 L362.8503,432.2266" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="117.1387" x="362.8503" y="526.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="97.1387" x="372.8503" y="549.667">Sidecar-proxy</text><path d="M312.8503,404.0781 L322.8503,404.0781 C337.8503,404.0781 337.8503,544.8203 352.8503,544.8203 L362.8503,544.8203" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M176.5554,291.4844 L186.5554,291.4844 C201.5554,291.4844 201.5554,404.0781 216.5554,404.0781 L226.5554,404.0781" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M43.9999,404.0781 L53.9999,404.0781 C68.9999,404.0781 68.9999,291.4844 83.9999,291.4844 L93.9999,291.4844" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="110.5555" x="93.9999" y="659.2656"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90.5555" x="103.9999" y="682.2607">&#36328;Region&#22797;&#21046;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="103.9999" y="698.5576">&#26368;&#32456;&#19968;&#33268;&#24615;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="143.6689" x="254.5554" y="582.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123.6689" x="264.5554" y="605.9639">Rsync/Binlog/AOF</text><path d="M204.5554,685.5625 L214.5554,685.5625 C229.5554,685.5625 229.5554,601.1172 244.5554,601.1172 L254.5554,601.1172" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="68.7744" x="254.5554" y="639.2656"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48.7744" x="264.5554" y="662.2607">Eureka</text><path d="M204.5554,685.5625 L214.5554,685.5625 C229.5554,685.5625 229.5554,657.4141 244.5554,657.4141 L254.5554,657.4141" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="66.7783" x="254.5554" y="695.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46.7783" x="264.5554" y="718.5576">Gossip</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="82.3096" x="371.3337" y="695.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.3096" x="381.3337" y="718.5576">Portworx</text><path d="M321.3337,713.7109 L331.3337,713.7109 C346.3337,713.7109 346.3337,713.7109 361.3337,713.7109 L371.3337,713.7109" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M204.5554,685.5625 L214.5554,685.5625 C229.5554,685.5625 229.5554,713.7109 244.5554,713.7109 L254.5554,713.7109" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="61.9998" x="254.5554" y="751.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41.9998" x="264.5554" y="774.8545">&#21152;&#23494;&#31867;</text><path d="M204.5554,685.5625 L214.5554,685.5625 C229.5554,685.5625 229.5554,770.0078 244.5554,770.0078 L254.5554,770.0078" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M43.9999,404.0781 L53.9999,404.0781 C68.9999,404.0781 68.9999,685.5625 83.9999,685.5625 L93.9999,685.5625" fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><h2>路由与失败检查(Failure Models)</h2><p>这里主要需要纠结pull和push，超时和失败的定义。</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="331px" preserveAspectRatio="none" style="width:545px;height:331px;background:#fff" version="1.1" viewBox="0 0 545 331" width="545px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="70.333" x="10" y="146.668"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.333" x="20" y="169.6631">routing</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="96.1729" x="130.333" y="62.2227"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76.1729" x="140.333" y="85.2178">heartbeats</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="46.7695" x="276.5059" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26.7695" x="286.5059" y="42.9951">TCP</text><path d="M226.5059,80.3711 L236.5059,80.3711 C251.5059,80.3711 251.5059,38.1484 266.5059,38.1484 L276.5059,38.1484" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="109.4756" x="276.5059" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89.4756" x="286.5059" y="99.292">health probe</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="72.377" x="435.9814" y="48.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52.377" x="445.9814" y="71.1436">metrics</text><path d="M385.9814,94.4453 L395.9814,94.4453 C410.9814,94.4453 410.9814,66.2969 425.9814,66.2969 L435.9814,66.2969" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="97.3896" x="435.9814" y="104.4453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="77.3896" x="445.9814" y="127.4404">load status</text><path d="M385.9814,94.4453 L395.9814,94.4453 C410.9814,94.4453 410.9814,122.5938 425.9814,122.5938 L435.9814,122.5938" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M226.5059,80.3711 L236.5059,80.3711 C251.5059,80.3711 251.5059,94.4453 266.5059,94.4453 L276.5059,94.4453" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M80.333,164.8164 L90.333,164.8164 C105.333,164.8164 105.333,80.3711 120.333,80.3711 L130.333,80.3711" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="50.0986" x="130.333" y="160.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.0986" x="140.333" y="183.7373">APM</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="174.2324" x="230.4316" y="160.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="154.2324" x="240.4316" y="183.7373">real application traffic</text><path d="M180.4316,178.8906 L190.4316,178.8906 C205.4316,178.8906 205.4316,178.8906 220.4316,178.8906 L230.4316,178.8906" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M80.333,164.8164 L90.333,164.8164 C105.333,164.8164 105.333,178.8906 120.333,178.8906 L130.333,178.8906" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="135.1377" x="130.333" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="115.1377" x="140.333" y="268.1826">Update Strategy</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="75.1523" x="315.4707" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.1523" x="325.4707" y="240.0342">Rolling?</text><path d="M265.4707,263.3359 L275.4707,263.3359 C290.4707,263.3359 290.4707,235.1875 305.4707,235.1875 L315.4707,235.1875" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="104.6973" x="315.4707" y="273.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84.6973" x="325.4707" y="296.3311">Drain node?</text><path d="M265.4707,263.3359 L275.4707,263.3359 C290.4707,263.3359 290.4707,291.4844 305.4707,291.4844 L315.4707,291.4844" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M80.333,164.8164 L90.333,164.8164 C105.333,164.8164 105.333,263.3359 120.333,263.3359 L130.333,263.3359" fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><h2>总结</h2><p>只要是异步系统（无法区分超时），共识在有限时间内不能完美地完成</p><p>作为技术人员，不要因为面试八股文就陷入100%分布式高可用、弹性伸缩、容灾且完美调度等理想模型中，而是意识到理论的不完美、技术的局限性，现实的不确定性，才能更好地理解分布式系统。</p><p>扩容是系统工程，物理机房的密度，交换机的插孔，功耗等都会限制最大值，上述方案最终实现的也不过是“昂贵的数据孤岛”。甚至你在专心搞高可用时，你的友商投入人力做Demo已经把项目拿下了。</p></div><div class="tags"><a class="tag-link" href="/tags/PaaS/" rel="tag">PaaS</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>