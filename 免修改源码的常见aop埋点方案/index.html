<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="为了提高软件开发的效率，开源/商业软件的引入也越来越广泛，但是一旦涉及到修改源码，将带来高成本的分支维护问题。本文介绍基于代码、容器、网关等AOP免修改源码的设计方案。"><meta name="keyword" content="PaaS,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>免修改源码的常见AOP埋点方案</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body class="container"><header id="header"><div class="header"><div class="header-left"><div class="author"><div class="author-name"><a href="/">諺</a></div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li style="font-size:.9rem"><a href="/archives" rel="nofollow">zh</a></li><li style="font-size:.9rem"><a href="#" rel="nofollow">|</a></li><li style="font-size:.9rem"><a href="/en" rel="nofollow">en</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">Epistemology</a></li><li><a href="/books" rel="nofollow">読書</a></li></ul></div></div></header><div class="content-wrapper"><div class="post"><section class="article"><div class="title">免修改源码的常见AOP埋点方案</div><div class="date">2021-01-03に投稿</div><div class="content"><p>为了提高软件开发的效率，开源/商业软件的引入也越来越广泛，但是一旦涉及到修改源码，将带来高成本的分支维护问题。本文介绍基于代码、容器、网关等AOP免修改源码的设计方案。</p><span id="more"></span><p>常见的免修改源码的切片方案如下</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U2NyaXB0VHlwZT0iYXBwbGljYXRpb24vZWNtYXNjcmlwdCIgY29udGVudFN0eWxlVHlwZT0idGV4dC9jc3MiIGhlaWdodD0iNDkwcHgiIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiIHN0eWxlPSJ3aWR0aDo4ODNweDtoZWlnaHQ6NDkwcHg7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA4ODMgNDkwIiB3aWR0aD0iODgzcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjQ1IiB4PSIzODguNSIgeT0iMTAiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNSIgeD0iMzk4LjUiIHk9IjMyLjAwMDEiPkFPUDwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI0MTEiIHgyPSI0MTEiIHkxPSI0NC40MDAxIiB5Mj0iNjQuNDAwMSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjM0IiB4Mj0iMzQiIHkxPSI2NC40MDAxIiB5Mj0iODQuNDAwMSIvPjxyZWN0IGZpbGw9IiNGRUZFQ0UiIGhlaWdodD0iMzQuNDAwMSIgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iNDgiIHg9IjEwIiB5PSI4NC40MDAxIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjgiIHg9IjIwIiB5PSIxMDYuNDAwMiI+Q29kZTwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSIzNCIgeDI9IjQ0IiB5MT0iMTU4LjIwMDMiIHkyPSIxNTguMjAwMyIvPjxyZWN0IGZpbGw9IiNGRUZFQ0UiIGhlaWdodD0iNDguODAwMiIgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iMTA5IiB4PSI0NCIgeT0iMTMzLjgwMDIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MiIgeD0iNTQiIHk9IjE1NS44MDAzIj5IYXJkY29kZTwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4OSIgeD0iNTQiIHk9IjE3MC4yMDA0Ij4oTW9kaWZ5IHJlcXVpcmVkKTwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI5OC41IiB4Mj0iMTA4LjUiIHkxPSIyMTQuODAwNSIgeTI9IjIxNC44MDA1Ii8+PHJlY3QgZmlsbD0iI0ZFRkVDRSIgaGVpZ2h0PSIzNC40MDAxIiBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHdpZHRoPSI5MiIgeD0iMTA4LjUiIHk9IjE5Ny42MDA0Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzIiIHg9IjExOC41IiB5PSIyMTkuNjAwNSI+U3ByaW5n55qEQU9QPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9Ijk4LjUiIHgyPSIxMDguNSIgeTE9IjI2NC4yMDA2IiB5Mj0iMjY0LjIwMDYiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjEyOCIgeD0iMTA4LjUiIHk9IjI0Ny4wMDA1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA4IiB4PSIxMTguNSIgeT0iMjY5LjAwMDYiPuS/ruaUuea6kOeggeW5tue7tOaKpOWIhuaUrzwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI5OC41IiB4Mj0iOTguNSIgeTE9IjE4Mi42MDA0IiB5Mj0iMjY0LjIwMDYiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSIzNCIgeDI9IjQ0IiB5MT0iMzEzLjYwMDciIHkyPSIzMTMuNjAwNyIvPjxyZWN0IGZpbGw9IiNGRUZFQ0UiIGhlaWdodD0iMzQuNDAwMSIgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iNTMiIHg9IjQ0IiB5PSIyOTYuNDAwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjMzIiB4PSI1NCIgeT0iMzE4LjQwMDciPlBsdWdpbjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI3MC41IiB4Mj0iODAuNSIgeTE9IjM2My4wMDA4IiB5Mj0iMzYzLjAwMDgiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjE2OSIgeD0iODAuNSIgeT0iMzQ1LjgwMDciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDkiIHg9IjkwLjUiIHk9IjM2Ny44MDA4Ij5KZW5raW5zL1NvbmFycXViZeeahGphcuaPkuS7tjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI3MC41IiB4Mj0iODAuNSIgeTE9IjQxMi40MDA5IiB5Mj0iNDEyLjQwMDkiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjEwMiIgeD0iODAuNSIgeT0iMzk1LjIwMDgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4MiIgeD0iOTAuNSIgeT0iNDE3LjIwMDkiPmMvZ2/kuK3nmoRzb+aPkuS7tjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI3MC41IiB4Mj0iODAuNSIgeTE9IjQ2MS44MDEiIHkyPSI0NjEuODAxIi8+PHJlY3QgZmlsbD0iI0ZFRkVDRSIgaGVpZ2h0PSIzNC40MDAxIiBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHdpZHRoPSIxMDQiIHg9IjgwLjUiIHk9IjQ0NC42MDA5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODQiIHg9IjkwLjUiIHk9IjQ2Ni42MDEiPnB55Lit55qEcHlwaeaPkuS7tjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI3MC41IiB4Mj0iNzAuNSIgeTE9IjMzMC44MDA3IiB5Mj0iNDYxLjgwMSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjM0IiB4Mj0iMzQiIHkxPSIxMTguODAwMiIgeTI9IjMxMy42MDA3Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iMzAxIiB4Mj0iMzAxIiB5MT0iNjQuNDAwMSIgeTI9Ijg0LjQwMDEiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjYzIiB4PSIyNjkuNSIgeT0iODQuNDAwMSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQzIiB4PSIyNzkuNSIgeT0iMTA2LjQwMDIiPlJ1bnRpbWU8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iMzAxIiB4Mj0iMzExIiB5MT0iMTUxLjAwMDMiIHkyPSIxNTEuMDAwMyIvPjxyZWN0IGZpbGw9IiNGRUZFQ0UiIGhlaWdodD0iMzQuNDAwMSIgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iNzciIHg9IjMxMSIgeT0iMTMzLjgwMDIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NyIgeD0iMzIxIiB5PSIxNTUuODAwMyI+SlZNIEFnZW50PC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjMwMSIgeDI9IjMxMSIgeTE9IjIwMC40MDA0IiB5Mj0iMjAwLjQwMDQiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9Ijk5IiB4PSIzMTEiIHk9IjE4My4yMDAzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzkiIHg9IjMyMSIgeT0iMjA1LjIwMDQiPkxEX1BSRUxPQUQ8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iMzAxIiB4Mj0iMzAxIiB5MT0iMTE4LjgwMDIiIHkyPSIyMDAuNDAwNCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjQ4OC41IiB4Mj0iNDg4LjUiIHkxPSI2NC40MDAxIiB5Mj0iODQuNDAwMSIvPjxyZWN0IGZpbGw9IiNGRUZFQ0UiIGhlaWdodD0iMzQuNDAwMSIgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iMTE3IiB4PSI0MzAiIHk9Ijg0LjQwMDEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5NyIgeD0iNDQwIiB5PSIxMDYuNDAwMiI+Q29udGFpbmVyIFNpZGVDYXI8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iNDg4LjUiIHgyPSI0OTguNSIgeTE9IjE1MS4wMDAzIiB5Mj0iMTUxLjAwMDMiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjU2IiB4PSI0OTguNSIgeT0iMTMzLjgwMDIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNiIgeD0iNTA4LjUiIHk9IjE1NS44MDAzIj5Db25zdWw8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iNDg4LjUiIHgyPSI0OTguNSIgeTE9IjIwMC40MDA0IiB5Mj0iMjAwLjQwMDQiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjY4IiB4PSI0OTguNSIgeT0iMTgzLjIwMDMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0OCIgeD0iNTA4LjUiIHk9IjIwNS4yMDA0Ij5Mb2dzdGFzaDwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI0ODguNSIgeDI9IjQ4OC41IiB5MT0iMTE4LjgwMDIiIHkyPSIyMDAuNDAwNCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjYxOCIgeDI9IjYxOCIgeTE9IjY0LjQwMDEiIHkyPSI4NC40MDAxIi8+PHJlY3QgZmlsbD0iI0ZFRkVDRSIgaGVpZ2h0PSIzNC40MDAxIiBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHdpZHRoPSI2MyIgeD0iNTg2LjUiIHk9Ijg0LjQwMDEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0MyIgeD0iNTk2LjUiIHk9IjEwNi40MDAyIj5OZXR3b3JrPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjYxOCIgeDI9IjYyOCIgeTE9IjE1MS4wMDAzIiB5Mj0iMTUxLjAwMDMiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9Ijk3IiB4PSI2MjgiIHk9IjEzMy44MDAyIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzciIHg9IjYzOCIgeT0iMTU1LjgwMDMiPkxvYWQgQmFsYW5jZXI8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iNjc2LjUiIHgyPSI2ODYuNSIgeTE9IjIwMC40MDA0IiB5Mj0iMjAwLjQwMDQiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjY4IiB4PSI2ODYuNSIgeT0iMTgzLjIwMDMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0OCIgeD0iNjk2LjUiIHk9IjIwNS4yMDA0Ij5TaGFyZGluZzwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI2NzYuNSIgeDI9IjY4Ni41IiB5MT0iMjQ5LjgwMDUiIHkyPSIyNDkuODAwNSIvPjxyZWN0IGZpbGw9IiNGRUZFQ0UiIGhlaWdodD0iMzQuNDAwMSIgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB3aWR0aD0iMTM1IiB4PSI2ODYuNSIgeT0iMjMyLjYwMDQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTUiIHg9IjY5Ni41IiB5PSIyNTQuNjAwNSI+Um91bmQgcm9iaW4gYW5kIG1vcmU8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iNjc2LjUiIHgyPSI2NzYuNSIgeTE9IjE2OC4yMDAzIiB5Mj0iMjQ5LjgwMDUiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSI2MTgiIHgyPSI2MjgiIHkxPSIyOTkuMjAwNiIgeTI9IjI5OS4yMDA2Ii8+PHJlY3QgZmlsbD0iI0ZFRkVDRSIgaGVpZ2h0PSIzNC40MDAxIiBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHdpZHRoPSI4MiIgeD0iNjI4IiB5PSIyODIuMDAwNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYyIiB4PSI2MzgiIHk9IjMwNC4wMDA2Ij5NaWRkbGV3YXJlPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjY2OSIgeDI9IjY3OSIgeTE9IjM0OC42MDA3IiB5Mj0iMzQ4LjYwMDciLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjE5MyIgeD0iNjc5IiB5PSIzMzEuNDAwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3MyIgeD0iNjg5IiB5PSIzNTMuNDAwNyI+Rm9yd2FyZCBBdXRoKFNTTy9TQU1ML0xEQVApPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjY2OSIgeDI9IjY3OSIgeTE9IjM5OC4wMDA4IiB5Mj0iMzk4LjAwMDgiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBoZWlnaHQ9IjM0LjQwMDEiIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgd2lkdGg9IjU2IiB4PSI2NzkiIHk9IjM4MC44MDA3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzYiIHg9IjY4OSIgeT0iNDAyLjgwMDgiPkxpbWl0ZXI8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojQTgwMDM2O3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iNjY5IiB4Mj0iNjY5IiB5MT0iMzE2LjQwMDYiIHkyPSIzOTguMDAwOCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6I0E4MDAzNjtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjYxOCIgeDI9IjYxOCIgeTE9IjExOC44MDAyIiB5Mj0iMjk5LjIwMDYiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiNBODAwMzY7c3Ryb2tlLXdpZHRoOjEuNTsiIHgxPSIzNCIgeDI9IjYxOCIgeTE9IjY0LjQwMDEiIHkyPSI2NC40MDAxIi8+PCEtLU1ENT1bNWY5NWQzYTgxY2YzZWVjYWI1ZWMwY2U1YTQ3Mzc0YTBdCkBzdGFydHdicw0Kc2tpbnBhcmFtIHNoYWRvd2luZyBmYWxzZQ0KKyBBT1ANCisrIENvZGUNCisrKyBIYXJkY29kZVxuKE1vZGlmeSByZXF1aXJlZCkNCisrKysgU3ByaW5n55qEQU9QDQorKysrIOS/ruaUuea6kOeggeW5tue7tOaKpOWIhuaUrw0KKysrIFBsdWdpbg0KKysrKyBKZW5raW5zL1NvbmFycXViZeeahGphcuaPkuS7tg0KKysrKyBjL2dv5Lit55qEc2/mj5Lku7YNCisrKysgcHnkuK3nmoRweXBp5o+S5Lu2DQorKyBSdW50aW1lDQorKysgSlZNIEFnZW50DQorKysgTERfUFJFTE9BRA0KKysgQ29udGFpbmVyIFNpZGVDYXINCisrKyBDb25zdWwNCisrKyBMb2dzdGFzaA0KKysgTmV0d29yaw0KKysrIExvYWQgQmFsYW5jZXINCisrKysgU2hhcmRpbmcNCisrKysgUm91bmQgcm9iaW4gYW5kIG1vcmUNCisrKyBNaWRkbGV3YXJlDQorKysrIEZvcndhcmQgQXV0aChTU08vU0FNTC9MREFQKQ0KKysrKyBMaW1pdGVyDQpAZW5kd2JzDQoKUGxhbnRVTUwgdmVyc2lvbiAxLjIwMjEuNChTdW4gQXByIDA0IDA4OjQ5OjM5IEdNVCAyMDIxKQooR1BMIHNvdXJjZSBkaXN0cmlidXRpb24pCkphdmEgUnVudGltZTogT3BlbkpESyBSdW50aW1lIEVudmlyb25tZW50CkpWTTogT3BlbkpESyA2NC1CaXQgU2VydmVyIFZNCkRlZmF1bHQgRW5jb2Rpbmc6IFVURi04Ckxhbmd1YWdlOiBlbgpDb3VudHJ5OiBVUwotLT48L2c+PC9zdmc+"><p>其中Code方案跳过，其它简要介绍</p><h2>Runtime层</h2><h4>JVM Agent插件</h4><p>假如你的程序老是挂掉，除了分析日志还可以参考Uber的免硬编码的JVM profiler方案，用于监控内存、CPU、FD等问题</p><p><a target="_blank" rel="noopener" href="https://github.com/uber-common/jvm-profiler">https://github.com/uber-common/jvm-profiler</a></p><p>此方案代码量很小，而且相当成熟，你可以拿过来自己编译定制</p><h4>LD_PREDLOAD替换glibc</h4><p>参考此文档 <a target="_blank" rel="noopener" href="https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html</a></p><p>此方案会优先glibc库加载，是高阶且危险方案，可以替换容器中的glibc中的标准函数，比如printf，malloc，exec等。这种方案相当于是二进制级别的AOP，就算是C程序也可以魔改，当然代价就是需要充分测试，否则很容易影响更多功能。</p><p>本方案主要用于安全审计、使用分析、性能分析，APM等，一般还会与ptrace一起使用。如果你对性能等因素要求更高，可以参考这个<a target="_blank" rel="noopener" href="https://openresty.com/en/xray/">收费项目-xray</a></p><p>如果要求没那么高，可以用alias/PATH等方案进行替换</p><h2>Container SideCar</h2><p>容器的SideCar一般指同时启动两个容器，一个是业务逻辑，另一个用于日志、命名服务、localhost代理等。</p><p>参考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar">https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar</a></p><p>此方案需要运维一套高可用的PaaS，比如Kubernetes或者Nomad，至少10台机器才能回本，因此需要看你的项目是否能够覆盖这些成本。</p><h2>Network</h2><h4>Load Balancer</h4><p>LB层主要用于支持副本的高可用，当软件本体不支持高可用部署时，你就要通过下面来实现。</p><p><strong>切片LB</strong></p><p>开源版的Jenkins、Gitlab是不支持横向扩容的，而只能最多做到Binlog一样的复制备份，因此网上的开源方案就比较折腾了。比如阿里云就是将上述组件高度定制，但是代码分支也要自己维护了。</p><p>比较偷懒的方案是基于项目ID等Hash值进行切片，这样就可以一定程度上进行多机使用</p><ul><li>如果使用纯Nginx/Caddy等静态配置，后续再扩容时一定需要停机</li><li>如果加一层DB进行KV路由的持久化，后续比较方便</li><li>再偷懒可以用子域名，比如pool1，pool2，用Web系统做一个审批流来分配也是可以的</li></ul><p>现实生产要与成本匹配，100%高可用虽然很好，但是它是非常昂贵的方案。</p><p><strong>非切片方案</strong></p><p>如果负载均衡后面的应用是无状态的（或者是状态存储到Redis中），那么可以这么搞。</p><h4>Middleware</h4><p>此处重要是用于业务切片，比如用户、登陆、白名单、限流等，网上教程很多，可以参考Treafik的设计，跳过。</p><h2>总结</h2><p>如同芯片一样，软件开发后续一定会走向集成化、供应链化、采购化，个人做的工作虽然看似复杂，但是每个人都是可替代的螺丝钉，因此对个人来说，要尽可能提高知识广度。</p></div><div class="tags"><a class="tag-link" href="/tags/PaaS/" rel="tag">PaaS</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><ul class="nav"><li>Prev:<a href="/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%96%BD%E4%B8%AD%E6%97%B6%E9%97%B4%E7%9F%AD%E7%BC%BA%E5%8C%96%E5%AF%B9%E7%AD%96/">项目实施中时间短缺化对策</a></li><li>Next:<a href="/2020-summary/">2020 Summary</a></li></ul><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the<a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus</a></noscript></div></div></div></div><footer><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry</a><span>.</span></div></footer><script>window.onload=function(){var a,e,n,t;a=window,e=document,t="script",n="ga",a.GoogleAnalyticsObject=n,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=+new Date,n=e.createElement(t),t=e.getElementsByTagName(t)[0],n.async=1,n.src="//www.google-analytics.com/analytics.js",t.parentNode.insertBefore(n,t),ga("create","UA-102296742-1","auto"),ga("send","pageview")}</script></body></html>