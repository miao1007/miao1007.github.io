<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="Consul is HashiCorp’s service networking solution for naming service. In this post, we will show how to use consul to design serverless Jenkins clusters."><meta name="keyword" content="Consul,DevOps,High Availability,Jenkins,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Jenkins multiple masters using Consul</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">Jenkins multiple masters using Consul</div><div class="date no-print">2019-11-26 / modified at 2023-07-30 / 1.1k words / 6 mins</div><div class="content"><blockquote><span>️This article has been <strong>over 2 years</strong> since the last update.</span></blockquote><p>Consul is HashiCorp’s service networking solution for naming service. In this post, we will show how to use consul to design serverless Jenkins clusters.</p><span id="more"></span><p>For small or Enterprise teams. there are many DevOps tools to choose.</p><div style="overflow-x:scroll"><table><thead><tr><th></th><th>Small Teams</th><th>Enterprise</th><th>Price</th></tr></thead><tbody><tr><td>SAAS</td><td>CircleCI, Azure, Codefresh, Github Action</td><td>Depends on the security level.</td><td>Pay as pipeline time</td></tr><tr><td>Self-hosted</td><td>single free Jenkins instance is enough.</td><td>Buy enterprise license of SAAS/Jenkins, or develop from Jenkins OSS version.</td><td>Infrastructure/Software License/customization</td></tr></tbody></table></div><p>This post is for readers</p><ul><li>Who are interested in Jenkins’s details.</li><li>Who are in a large team looking for a self-hosting open source(or vendor-neutral) solution, <strong>and</strong> have the ability and time to customize Jenkins.</li><li>This post contains high-level thoughts only, the implementation may cost 6～15 man-months, and there is no open-source product available publicly.</li></ul><h2>Liebig’s law of Jenkins</h2><p>For historical reasons, Jenkins uses a memory and file based solution to maintain the running job status.</p><div style="overflow-x:scroll"><table><thead><tr><th>Running status</th><th>Internal</th><th>Problems</th></tr></thead><tbody><tr><td>Configuration</td><td>XML file based</td><td>Not too bad</td></tr><tr><td>Queue</td><td>ArrayList</td><td>central embedded queue</td></tr><tr><td>Agent</td><td>ConcurrentSkipListMap</td><td>log(n) complexity, may slow when too much.</td></tr><tr><td>Running Jobs</td><td>Bind to agent</td><td>real-time scheduling.</td></tr><tr><td>Logs</td><td>sent from agent into master</td><td>log/network stress.</td></tr></tbody></table></div><h4>Existing multiple masters solutions</h4><p>To overcome the problem, there are some solutions already.</p><ul><li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/binary-log.html">Binlog-like</a> solution: Using <code>SCM Sync configuration plugin</code>/rsync/Enterprise version or Shared NFS to replicate settings from one to another. However, it is just a hot standby failover solution, only <strong>one</strong> Jenkins instance is working.</li><li>Strong consistent solution: You need to implement a centralized lock(Database/RAFT/WAL) to ensure each write waits until confirmation is received from both master and slave, that means you may <strong>need a team</strong> to modify and maintain the core source code from Jenkins.</li><li>Sharding based solution: split jenkins instances into disjoint services. A global and dynamic mapping(consistent hash or else) between users(tenant) and services is required.<ul><li>ClientSide mapping: <a target="_blank" rel="noopener" href="https://docs.openstack.org/infra/publications/gearman-plugin">Gearman</a> is the <strong>real</strong> multiple masters’ solution which the masters are treated as ‘Jobs’ in Gearman. However the <a target="_blank" rel="noopener" href="https://opendev.org/x/gearman-plugin/">repository</a> is unmaintained for nearly 5 years, and it’s <a target="_blank" rel="noopener" href="https://opendev.org/jjb/jenkins-job-builder">cli</a> is more like an Ansible solution, there is no open source Jenkins GUI avaliable in this solution.</li><li>ServerSide mapping: create a load balancer such as Nginx/citus, however they are hard to be maintained and upgraded.</li></ul></li><li>Sidecar based solution: Using AOP and wrappers to forward RESTful services, webhooks and logs into a centralized datalake.</li></ul><p>Here is a summary</p><table><thead><tr><th>Solution</th><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td>Binlog</td><td>easy to create</td><td>only <strong>one</strong> instance is working, bind with NFS/rsync</td></tr><tr><td>Global lock</td><td>Real HA</td><td>patch and maintain source code.</td></tr><tr><td>Sharding</td><td>Easy to understand</td><td>Maintain the mapping</td></tr><tr><td>Sidecar</td><td>AOP based</td><td>Too much works to be wrapped &amp;&amp; too much stacks</td></tr></tbody></table><h2>Serverless</h2><h4>What is serverless?</h4><p>Serverless is stateless(or states are moved outside), which means your Jenkins instance is only a jenkinsfile interceptor and has no bind with the local database(in JENKINS_HOME).</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="DESCRIPTION" height="49px" preserveAspectRatio="none" style="width:388px;height:49px;background:#fff" version="1.1" viewBox="0 0 388 49" width="388px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g class="entity" data-entity="j" data-source-line="2" data-uid="ent0002" id="entity_j"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="91.1006" x="7" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="71.1006" x="17" y="29.9951">Jenkinsfile</text></g><g class="entity" data-entity="master" data-source-line="3" data-uid="ent0003" id="entity_master"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="146.2666" x="133.42" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126.2666" x="143.42" y="29.9951">Jenkinsfile Runner</text></g><g class="entity" data-entity="out" data-source-line="4" data-uid="ent0004" id="entity_out"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="68.6309" x="314.23" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48.6309" x="324.23" y="29.9951">Output</text></g><g class="link" data-entity-1="j" data-entity-2="master" data-source-line="5" data-uid="lnk5" id="link_j_master"><path d="M98.57,25.15 C110.1,25.15 115.63,25.15 127.16,25.15" fill="none" id="j-to-master" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="133.16,25.15,124.16,21.15,128.16,25.15,124.16,29.15,133.16,25.15" style="stroke:#454645;stroke-width:1"/></g><g class="link" data-entity-1="master" data-entity-2="out" data-source-line="6" data-uid="lnk6" id="link_master_out"><path d="M280.05,25.15 C291.29,25.15 296.52,25.15 307.76,25.15" fill="none" id="master-to-out" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="313.76,25.15,304.76,21.15,308.76,25.15,304.76,29.15,313.76,25.15" style="stroke:#454645;stroke-width:1"/></g></g></svg><h4>What’s Jenkins-X serverless solution?</h4><p>The <a target="_blank" rel="noopener" href="https://www.cloudbees.com/blog/serverless-jenkins-jenkins-x">jenkins-X</a> is based on kubernetes, and use the Sidecar pattern too. However</p><ul><li>I just want a jenkinsfile interceptor, but got the full kubernete/helm instances(buy, install, and maintain the kubernetes clusters, and configure the F**K yaml)</li><li>Single-vendor lock in, using CD only with kubernates/GitHub.</li><li>It’s hard to customize own steps, and bind with a fixed git methodology/YAML.</li><li>JVM memory saves, but k8s creates <a target="_blank" rel="noopener" href="https://codefresh.io/continuous-deployment/codefresh-versus-jenkins-x/">new problems</a>.</li></ul><p>See more at <a target="_blank" rel="noopener" href="https://codefresh.io/continuous-deployment/codefresh-versus-jenkins-x/">https://codefresh.io/continuous-deployment/codefresh-versus-jenkins-x/</a></p><h2>My Sidecar based Solution</h2><p>Here is my solution, every masters are independence, where data get eventually consistency with low latency</p><h4>Summary</h4><p>All components are made with opensource products.</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="DESCRIPTION" height="452px" preserveAspectRatio="none" style="width:493px;height:452px;background:#fff" version="1.1" viewBox="0 0 493 452" width="493px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g class="cluster" data-entity="runc" data-source-line="5" data-uid="ent0003" id="cluster_runc"><rect fill="none" height="103.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="476" x="11" y="7"/><path d="M209.0908,7 L209.0908,16.2969 L199.0908,26.2969 L11,26.2969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="188.0908" x="14" y="20.9951">Multi-clouds Agent Pool</text></g><g class="cluster" data-entity="masters" data-source-line="11" data-uid="ent0008" id="cluster_masters"><rect fill="none" height="103.29" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="260" x="129" y="175.3"/><path d="M202.1367,175.3 L202.1367,184.5969 L192.1367,194.5969 L129,194.5969" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="63.1367" x="132" y="189.2951">Masters</text></g><g class="cluster" data-entity="ctrl" data-source-line="15" data-uid="ent0011" id="cluster_ctrl"><rect fill="none" height="96.3" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="215" x="7" y="350.59"/><path d="M96.0713,350.59 L96.0713,359.8869 L86.0713,369.8869 L7,369.8869" fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="79.0713" x="10" y="364.5851">Controller</text></g><g class="entity" data-entity="agent1" data-source-line="6" data-uid="ent0004" id="entity_agent1"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="70.1416" x="53.93" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.1416" x="63.93" y="72.9951">Nomad</text></g><g class="entity" data-entity="agent4" data-source-line="7" data-uid="ent0005" id="entity_agent4"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="69.5195" x="393.24" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49.5195" x="403.24" y="72.9951">Docker</text></g><g class="entity" data-entity="agent2" data-source-line="8" data-uid="ent0006" id="entity_agent2"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="100.1924" x="158.9" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80.1924" x="168.9" y="72.9951">Kubernetes</text></g><g class="entity" data-entity="agent3" data-source-line="9" data-uid="ent0007" id="entity_agent3"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="63.8457" x="294.08" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43.8457" x="304.08" y="72.9951">Mesos</text></g><g class="entity" data-entity="master" data-source-line="12" data-uid="ent0009" id="entity_master"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="78.6865" x="172.66" y="218.3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58.6865" x="182.66" y="241.2951">Jenkins1</text></g><g class="entity" data-entity="master2" data-source-line="13" data-uid="ent0010" id="entity_master2"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="78.6865" x="286.66" y="218.3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58.6865" x="296.66" y="241.2951">Jenkins2</text></g><g class="entity" data-entity="dl" data-source-line="16" data-uid="ent0012" id="entity_dl"><path d="M23.47,395.59 C23.47,385.59 67.0037,385.59 67.0037,385.59 C67.0037,385.59 110.5374,385.59 110.5374,395.59 L110.5374,420.8869 C110.5374,430.8869 67.0037,430.8869 67.0037,430.8869 C67.0037,430.8869 23.47,430.8869 23.47,420.8869 L23.47,395.59" fill="#00FFFF" style="stroke:#454645;stroke-width:.5"/><path d="M23.47,395.59 C23.47,405.59 67.0037,405.59 67.0037,405.59 C67.0037,405.59 110.5374,405.59 110.5374,395.59" fill="none" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.0674" x="33.47" y="422.5851">Data lake</text></g><g class="entity" data-entity="cli" data-source-line="17" data-uid="ent0013" id="entity_cli"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="60.5303" x="145.73" y="390.09"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="155.73" y="413.0851">Client</text></g><g class="entity" data-entity="consul" data-source-line="4" data-uid="ent0002" id="entity_consul"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="65.1924" x="320.4" y="390.09"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45.1924" x="330.4" y="413.0851">consul</text></g><g class="link" data-entity-1="runc" data-entity-2="dl" data-source-line="19" data-uid="lnk14" id="link_runc_dl"><path d="M21.9953,110.5277 C22.0192,110.8272 22.0432,111.1281 22.0674,111.4304 C22.1157,112.0348 22.1647,112.6445 22.2142,113.2593 C22.3133,114.489 22.4147,115.7395 22.5186,117.01 C22.7262,119.5509 22.9434,122.1721 23.1702,124.8682 C24.0774,135.6527 25.1384,147.6366 26.3588,160.4838 C31.24,211.8725 38.67,277.075 49,334.59 C52.08,351.73 55.3084,365.0368 59.1684,379.3568" fill="none" id="runc-to-dl" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/><polygon fill="#454645" points="60.73,385.15,62.2498,375.4191,59.4287,380.3223,54.5255,377.5012,60.73,385.15" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55.8848" x="42" y="241.0069">filebeats</text></g><g class="link" data-entity-1="masters" data-entity-2="consul" data-source-line="20" data-uid="lnk15" id="link_masters_consul"><path d="M144.9121,278.7239 C144.9991,278.9095 145.087,279.0946 145.1759,279.2792 C148.0213,285.1869 151.85,290.5975 157,294.59 C173.57,307.44 232.05,293.63 251,302.59 C292.06,322 322.2145,360.456 338.6545,384.826" fill="none" id="masters-to-consul" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/><polygon fill="#454645" points="342.01,389.8,340.2928,380.102,339.2138,385.655,333.6608,384.576,342.01,389.8" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84.8809" x="294" y="323.1569">Health check</text></g><g class="link" data-entity-1="dl" data-entity-2="masters" data-source-line="21" data-uid="lnk16" id="link_dl_masters"><path d="M59.9717,379.5992 C55.3017,357.4592 52.73,328.66 66,302.59 C68.74,297.21 72.36,298.46 77,294.59 C90.7,283.17 105.205,269.405 116.5213,258.2463 C119.3503,255.4566 121.9801,252.8298 124.3481,250.4432 C125.5322,249.25 126.6508,248.1167 127.6962,247.0533 C127.9575,246.7874 128.2143,246.5259 128.4664,246.2689 C128.5924,246.1404 128.7173,246.013 128.8409,245.8868" fill="none" id="dl-backto-masters" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="61.21,385.47,63.2664,375.8382,60.1781,380.5777,55.4386,377.4893,61.21,385.47" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77.8159" x="67" y="323.1569">RunListener</text></g><g class="link" data-entity-1="masters" data-entity-2="cli" data-source-line="22" data-uid="lnk17" id="link_masters_cli"><path d="M147.9114,284.9479 C148.3385,286.8071 148.0647,285.6151 148.5061,287.5369 C149.3891,291.3804 150.2984,295.3391 151.225,299.3725 C158.6375,331.64 167.15,368.695 172.02,389.9" fill="none" id="masters-backto-cli" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="146.5681,279.1002,144.6846,288.7673,147.6875,283.9733,152.4815,286.9763,146.5681,279.1002" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79.8535" x="159" y="315.6569">Job.xml with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66.022" x="167.9819" y="330.7897">Jenkinsfile</text></g><g class="link" data-entity-1="consul" data-entity-2="cli" data-source-line="23" data-uid="lnk18" id="link_consul_cli"><path d="M319.97,408.24 C287.4,408.24 244.06,408.24 212.43,408.24" fill="none" id="consul-to-cli" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/><polygon fill="#454645" points="206.43,408.24,215.43,412.24,211.43,408.24,215.43,404.24,206.43,408.24" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78.2983" x="224.33" y="401.3069">help choose</text></g><g class="link" data-entity-1="agent1" data-entity-2="master" data-source-line="24" data-uid="lnk19" id="link_agent1_master"><path d="M104.88,86.64 C126.61,110.64 163.56,151.67 169,159.3 C182.58,178.33 195.39,202.02 203.43,217.87" fill="none" id="agent1-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="24.8574" x="163" y="147.3669">TCP</text></g><g class="link" data-entity-1="agent2" data-entity-2="master" data-source-line="25" data-uid="lnk20" id="link_agent2_master"><path d="M209.32,86.63 C209.89,118.57 211.11,186 211.68,217.95" fill="none" id="agent2-master" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g><g class="link" data-entity-1="agent3" data-entity-2="master2" data-source-line="26" data-uid="lnk21" id="link_agent3_master2"><path d="M326,86.63 C326,118.57 326,186 326,217.95" fill="none" id="agent3-master2" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g><g class="link" data-entity-1="agent4" data-entity-2="master2" data-source-line="27" data-uid="lnk22" id="link_agent4_master2"><path d="M417.28,86.63 C397.69,118.57 356.33,186 336.73,217.95" fill="none" id="agent4-master2" style="stroke:#454645;stroke-width:1;stroke-dasharray:1,3"/></g></g></svg><center>multiple-clouds Jenkins</center><p>This solution is not a smart solution, but saves your time</p><ul><li>No stronghly bind with any cloud platforms(Kubernetes/Nomad/Mesos).</li><li>Most works will be transformed into a Spring/Database based project -&gt; They are cost-effective, easy to be designed, developed and matainted, and make employee recruitment or outsourcing easier.</li></ul><h4>Client</h4><ul><li>Create and send raw XML to jenkins instances.</li><li>Inside the XML, the payload can be Jenkinsfile, YAML, JSON, or the other DSL.</li><li>Job definitions will be saved into a database(pg/mysql/elk).</li></ul><h4>Data lake</h4><ul><li>ELK/KsqlDB: ETL, grafana and visualization.</li><li>Jenkins <code>shell</code> step need to be reimplemented with redirect for centralized logs.</li></ul><h4>Jenkins</h4><p>Modifications with jenkins.war and other plugins are not required. PAAS bind naming services(k8s/nomad) are also not required.</p><p>Just create a jenkins plugin(not open sourced here)</p><ul><li>Use <code>hudson.model.listeners.RunListener</code> to send back job results(RUNNING/SUCCESS/FAIL).</li><li>Use <a target="_blank" rel="noopener" href="https://jenkins.io/blog/2018/04/25/configuring-jenkins-pipeline-with-yaml-file/">shared library</a> for intercepting the high-level DSL</li></ul><h4>Consul</h4><ul><li>Use Nomad’s HCL or Kubernetes CRD/annotation or sidecar to register service to the Consul -&gt; No SDK installation required in the jenkins.war.</li><li>Use consul block query and metadata for client side load balancing.</li><li>Use <a target="_blank" rel="noopener" href="https://www.consul.io/docs/commands/maint.html">maintenance mode</a> when releasing or upgrating a Jenkins instance.</li></ul><h4>Why not create and destroy Jenkins container instance per job?</h4><ul><li>JVM cold starts is too slow when you have lots of jobs/plugins(30s or more).</li><li>The main costs is infra(machines/energy) when self-hosting, and Jenkins masters are alway filled with workload.</li></ul><h4>Summary</h4><table><thead><tr><th>Problems</th><th>Before</th><th>After</th></tr></thead><tbody><tr><td>Pipeline defination</td><td>Master Disk</td><td>Database</td></tr><tr><td>Build result</td><td>Master Disk</td><td>Forwarding to data lake by RunListener class</td></tr><tr><td>Step details</td><td>Master Disk</td><td>Just forwarding, not persistence</td></tr><tr><td>Stdout Log</td><td>Master Disk</td><td>Forwarding to ELK by filebeats</td></tr><tr><td>Webhook</td><td>Master Disk</td><td>Spring Controller wrappers</td></tr><tr><td>Cron Job</td><td>Master Disk</td><td>Quartz(on Database)+WebHook</td></tr><tr><td>SCM pulling</td><td>Master Disk</td><td>Quartz or WebHook</td></tr><tr><td>Load balancer</td><td>No</td><td>Consul blocking query</td></tr><tr><td>visualization</td><td>JSP like</td><td>Powered by Spring RESTful API</td></tr></tbody></table><p>I should emphasize again that this solution is not cheap at all.</p><h2>Conclusion</h2><h4>Pros and cons</h4><div style="overflow-x:scroll"><table><thead><tr><th></th><th>Single Jenkins</th><th>Paid Solutions</th><th>Sidecar based Solution</th></tr></thead><tbody><tr><td>Costs</td><td>Free, no guarantees</td><td>License fees</td><td>Customization costs and time</td></tr><tr><td>Parallels jobs</td><td>Limited</td><td>By license type</td><td>10K Jobs+, depends on your datalake</td></tr><tr><td>HA</td><td>No</td><td>Yes</td><td>Yes(Flight jobs still down)</td></tr><tr><td>Pipelines as code</td><td>Groovy</td><td>YAML/NodeJS</td><td>Same as Jenkins + DSL</td></tr><tr><td>Tenant</td><td>No</td><td>Yes</td><td>Customized by Spring</td></tr><tr><td>Authorization</td><td>Simple</td><td>Yes</td><td>Customized by Spring(RBAC/LDAP/…)</td></tr><tr><td>CD</td><td>No</td><td>Yes</td><td>DSL template</td></tr></tbody></table></div><p>So, what you will get depends on how much you pay. This post proposes a way to implement mutilple masters, but requires a lot of works and time.</p></div><div class="tags"><a class="tag-link" href="/tags/Consul/" rel="tag">Consul</a><a class="tag-link" href="/tags/DevOps/" rel="tag">DevOps</a><a class="tag-link" href="/tags/High-Availability/" rel="tag">High Availability</a><a class="tag-link" href="/tags/Jenkins/" rel="tag">Jenkins</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>