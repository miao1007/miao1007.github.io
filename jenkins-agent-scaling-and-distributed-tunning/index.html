<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="With Increasing jobs on compiling task with Jenkins, we are facing agent scaling issues."><meta name="keyword" content="DevOps,Jenkins,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Jenkins Agent Scaling And Distributed Tunning</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body class="container"><header id="header"><div class="header"><div class="header-left"><div class="author"><div class="author-name"><a href="/">諺</a></div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li style="font-size:.9rem"><a href="/archives" rel="nofollow">zh</a></li><li style="font-size:.9rem"><a href="#" rel="nofollow">|</a></li><li style="font-size:.9rem"><a href="/en" rel="nofollow">en</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">Epistemology</a></li><li><a href="/books" rel="nofollow">読書</a></li></ul></div></div></header><div class="content-wrapper"><div class="post"><section class="article"><div class="title">Jenkins Agent Scaling And Distributed Tunning</div><div class="date">2019-09-05に投稿</div><div class="content"><p>With Increasing jobs on compiling task with Jenkins, we are facing agent scaling issues.</p><span id="more"></span><p>For the reader: Who may concern about scaling Jenkins. If you just want a cookbook, please refer [<em>Jenkins 2</em>: Up and Running: Evolve Your Deployment Pipeline for Next Generation Automation)]</p><h2>How many machine/slot required?</h2><p>There are no easy ways to estimate the amount of the machines because you have no context with domain special knowledge, just try it out first in a conservative amount.</p><ul><li>register existing machines to master.</li><li>set slot per agent as CPU logic core.</li><li>Using time-series monitoring tools to check agent workload and analyze with BI(grafana) tools.</li></ul><h2>Choose connection protocol</h2><h4>SSH</h4><p>The master uses ssh to log in on an agent by IP, User, and key, and send back registration info to master. This way is not dynamically, and we find the “cold wake up” time is too slow, so we give it up.</p><blockquote><p>For now(2020), we implemented a ssh cloud provision interface to support the self-hosted agent service.</p></blockquote><h4>Remoting Kafka Plugin</h4><p>This plugin use MQ to persist command and jobs info with four-channel, however, there is too little practice on the internet and has a strong coupling with K8s, so we skipped.</p><h4>swarm-plugin(preferred)</h4><p>swarm-plugin is not docker’s swarm overlay network, it’s just a wrapper of JNLP(<a target="_blank" rel="noopener" href="https://github.com/jenkinsci/remoting">jenkins-remoting</a>) with retry policy. We create a custom shell script in <code>userContent</code> to make an agent easy to connect master. Whatever machine you use(Physical/K8s/HPC), it always works.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://&lt;jenkins_url&gt;/userCotent/swarmcli.sh | sh</span><br></pre></td></tr></table></figure><p>Pros:</p><ul><li>no password/key required</li><li>third party machine supported</li><li>clean code, easy to customize.</li></ul><p>Cons:</p><ul><li>computing and networking in the same jar, not HA.</li></ul><h2>Jenkins Agent Scheduler</h2><p>Scheduling is a comprehensive algorithm, in Jenkins, however, the default way is really simple to find a <em>feasible</em> node.</p><h3>Jenkins internal LoadBalancer</h3><p>In this situation, we are assuming every agent and job has <strong>the same specification</strong>, and we can’t allocate jobs depends on realtime CPU usage. I do not recommend to customize loadbalancer on Jenkins.</p><h4>DefaultLoadbalancer</h4><p>The default algorithm is <a target="_blank" rel="noopener" href="https://github.com/jenkinsci/jenkdiskins/blob/3b860c4affb06ace83c8f50e136121b905060a80/core/src/main/java/hudson/model/LoadBalancer.java#L80">consistent hash</a>, a key-based routing, so there are no concept of priority and orders. you may find one agent is full load, and another is idle.</p><h4>Least/Scores Loadbalancer(Score-based)</h4><p>Least algorithm can be found at <a target="_blank" rel="noopener" href="https://github.com/jenkinsci/leastload-plugin/blob/master/src/main/java/org/bstick12/jenkinsci/plugins/leastload/LeastLoadBalancer.java#L171">LeastLoadBalancer.java</a>, they sort agents with the count of idle slots.</p><p>Scores algorithm can be found at <a target="_blank" rel="noopener" href="https://github.com/jenkinsci/scoring-load-balancer-plugin/blob/d62adfcdb25e51638a13037dd9d91ded0bd4d2f1/src/main/java/jp/ikedam/jenkins/plugins/scoringloadbalancer/rules/NodeLoadScoringRule.java#L43">NodeLoadScoringRule.java</a>, they sort agents by (idle - busy)</p><p>The following shows the result</p><table><thead><tr><th></th><th>Agent1</th><th>Agent2</th></tr></thead><tbody><tr><td>All</td><td>4</td><td>10</td></tr><tr><td>Idle</td><td>3</td><td>5</td></tr><tr><td>Busy</td><td>1</td><td>5</td></tr><tr><td>Least Loadbalancer(Higher is better)</td><td>3</td><td>5</td></tr><tr><td>Scores Loadbalancer(Higher is better)</td><td>20</td><td>0</td></tr></tbody></table><h3>Jenkins external scheduling</h3><p>You can pass the buck with <code>hudson.slaves.Cloud</code> plugin, like EC2/K8S plugin, the PAAS solution, to create and destroy agent remotely on-demand, paying your money by running time.</p><ul><li>kubernete((preferred for SAAS)</li><li>nomad(preferred for self-hosted, plugable driver)</li><li>mesos(preferred for self-hosted)</li></ul><p>When you access hardware board resource, your can also use the <code>Cloud</code> interface to abstract Agent and Slot, to leave the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Comparison_of_cluster_software">algorithm</a> on your self-hosted Hardware-PAAS platform.</p><h2>TroubleShoot</h2><h4>Process limit per user</h4><p>When a Jenkins job starts, the job may trigger other processes like shell or python, which will consume user processes, the limit is usually too small because the agent is the only working user on the machine.</p><p>On 64-bit Linux, max user processes can be found and changed on following command</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -u</span><br><span class="line"><span class="comment"># my result is 1418, which is not enough, could be set to 4096</span></span><br></pre></td></tr></table></figure><h4>JVM ThreadStackSize(-Xss)</h4><p>On 64-bit Linux OS, the default stack size of JVM is 1M(to maintain frames), but <code>new Thread()</code> in java still use <code>fork()</code> syscall and consumes a lot of OS stack size.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check default Xss</span></span><br><span class="line">java -XX:+PrintFlagsFinal -version | grep Stack</span><br></pre></td></tr></table></figure><p>In most case, there are no recursion algorithms on a pipeline, we try to decrease <code>Xss</code> to 256K and it works.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar agent.jar -Xss256K</span><br></pre></td></tr></table></figure><h4>Othe solutions</h4><p>Train our users</p><ul><li>not to use <code>parallels</code> DSL in for loop because it’s a fork bomb and it may block the head-beat thread</li><li>Replace py/shell with DSL to perform a simple task like fileExists, create file, to void process creation.</li></ul></div><div class="tags"><a class="tag-link" href="/tags/DevOps/" rel="tag">DevOps</a><a class="tag-link" href="/tags/Jenkins/" rel="tag">Jenkins</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><ul class="nav"><li>Prev:<a href="/plantuml-for-hexo-plugin-released/">PlantUML for Hexo plugin released</a></li><li>Next:<a href="/se%E4%BC%81%E7%94%BB%E4%B8%8E%E4%B8%8A%E7%BA%BF%E8%AE%B0%E5%BD%95/">SE企画与上线记录</a></li></ul><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the<a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus</a></noscript></div></div></div></div><footer><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry</a><span>.</span></div></footer><script>window.onload=function(){var a,e,n,t;a=window,e=document,t="script",n="ga",a.GoogleAnalyticsObject=n,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=+new Date,n=e.createElement(t),t=e.getElementsByTagName(t)[0],n.async=1,n.src="//www.google-analytics.com/analytics.js",t.parentNode.insertBefore(n,t),ga("create","UA-102296742-1","auto"),ga("send","pageview")}</script></body></html>