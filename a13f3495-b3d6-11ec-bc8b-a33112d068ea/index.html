<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="本文分析了数十款知名项目的权限架构，并提出了一款基于云原生权限框架的灵活配置思路。"><meta name="keyword" content="Authz,CNCF,Open Policy Agent,RuleEngine,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>基于Open Policy Agent的Authz权限设计探索</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">基于Open Policy Agent的Authz权限设计探索</div><div class="date no-print">2021-10-10 / modified at 2025-07-17 / 5k words / 18 mins</div><div class="content"><p>本文分析了数十款知名项目的权限架构，并提出了一款基于云原生权限框架的灵活配置思路。</p><span id="more"></span><h2>快速结论</h2><p>本文虽然介绍OPA框架，但是后续把它给<strong>否决了</strong></p><ul><li>慎用规则引擎与DSL低代码，因为大规模开发下的培训与维护的门槛太高。</li><li>慎用云原生，很多都只是销售术语，技术上并没有突破。</li><li>后续方案仍然用业务代码来实现的，具体请参考我的<a href="/bf6fbf90-2c7d-11ee-bc9f-0f33feb1b7f0/">英文版文章</a></li></ul><h2>背景</h2><h4>术语</h4><p>在设计权限前，而是要明确各种概念与术语，本文定义如下</p><table><thead><tr><th>术语</th><th>定义</th></tr></thead><tbody><tr><td>User/SecurityPrincipal/token/Group/Team</td><td>用户/机器人/凭证等实体或者集合，可以从LDAP等第三方系统获得的镜像数据。类似NAC（网络准入控制）</td></tr><tr><td>Tenant/Namespace/Org/<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/governance/management-groups/overview">management groups</a>/VDC</td><td>含继承关系的租户实体，拥有各自的资源<strong>配额</strong>，一般不会过于干涉到具体的数据权限</td></tr><tr><td>Resource</td><td>资源实体，比如代码仓库/EC2机器的操作/数据权限等</td></tr><tr><td>ResourceGroup/project</td><td>资源组实体的合集，甚至可以包含权限管理的操作，但是不能嵌套</td></tr><tr><td>Capacity/Rule-unit/Action/Permission</td><td>动作+资源的组合的定义，比如 <code>read-report</code> 表示能读取报告</td></tr><tr><td>Policy/statement/Role</td><td>租户在某个Scope下，可以操作的资源合集的实体，比如<code>create-member</code>，大部分用户只能分清“admin/member/readonly”三种角色</td></tr><tr><td>Subscription</td><td>租户成员来创建/订阅的资源关系，非计费场景用不上</td></tr><tr><td>Authentication</td><td>证明你是你(AuthN/IDaaS/LDAP)，比如Auth0/onelogin/forgerock等IAM，本文不涉及</td></tr></tbody></table><p>权限的难点在于</p><ul><li>设计权限要基于MECE的思路去<strong>遍历枚举</strong>所有动作，根据安全要求，在高阶设计阶段就需要尽可能地枚举威胁并加固</li><li>组织间存在<code>继承-覆盖关系</code>与<code>颗粒度</code>两个维度，是三个多对多的关系</li><li>设计师会在低代码与强业务间反复纠结</li></ul><h4>安全理论</h4><p>权限本质是安全，安全中最重要的有两个特点</p><ul><li>机密性：参考BLP模型，比如防泄密，遵循GDPR等</li><li>完整性：参考Biba 模型，比如防止低权限设备提权</li></ul><p>在安全领域中，由美国国防部发布的TCSEC的等级模型最为有名。关于“权限”，主要涉及到</p><ul><li>C2：普通的RBAC</li><li>B1：嵌套权限，即包含Scope的概念</li><li>B2：每一个对象都要标签的等级，比如只有高管A才能访问机密数据B。</li></ul><p>常见项目做到C2就够了，SaaS项目至少需要做到B1，而大数据项目的 <code>row-level filter</code> 需要尽可能做到B2。</p><h4>权限设计高阶思路</h4><p>当前市场中基本没有太多开箱即用的权限管理产品，在大规模、多租户的权限场景中，高阶设计如下</p><ul><li><p>组织：从组织架构推导出人员、组织、继承、SOD等关系</p><ul><li>避免先入为主的扁平化/低颗粒度</li><li>避免双重汇报的组织架构</li><li>避免真实岗位和资源角色绑定</li><li>动作权限与角色需要考虑SOD，比如某人不能自审自批</li></ul></li><li><p>资源：一定先枚举所有资源，这是SE的设计门槛，最好能确认颗粒度，而不要出现树形关系。</p></li><li><p>角色/权限：建议参考AWS/Azure等树形权限设计</p></li></ul><p>如果需要自行开发，参考流程如下</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="573px" preserveAspectRatio="none" style="width:710px;height:573px;background:#fff" version="1.1" viewBox="0 0 710 573" width="710px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="60.1611" x="10" y="267.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40.1611" x="20" y="290.7764">Authz</text><rect fill="#F1F1F1" height="85.1875" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="33.9999" x="120.1611" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="42.9951">&#22522;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="59.292">&#30784;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="75.5889">&#25968;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="91.8857">&#25454;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="197.4329" x="204.1611" y="44.4453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177.4329" x="214.1611" y="67.4404">&#29992;&#25143;/&#32676;&#32452;/&#26426;&#22120;&#20154;&#30340;&#22522;&#26412;&#23646;&#24615;</text><rect fill="#90EE90" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="152.3024" x="451.5939" y="44.4453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="132.3024" x="461.5939" y="67.4404">&#8730; &#36825;&#20123;&#22343;&#21487;&#20197;SaaS&#21270;</text><path d="M401.5939,62.5938 L411.5939,62.5938 C426.5939,62.5938 426.5939,62.5938 441.5939,62.5938 L451.5939,62.5938" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M154.1611,62.5938 L164.1611,62.5938 C179.1611,62.5938 179.1611,62.5938 194.1611,62.5938 L204.1611,62.5938" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M70.1611,285.9297 L80.1611,285.9297 C95.1611,285.9297 95.1611,62.5938 110.1611,62.5938 L120.1611,62.5938" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="85.1875" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="33.9999" x="120.1611" y="125.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="148.1826">&#38656;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="164.4795">&#27714;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="180.7764">&#20998;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="197.0732">&#26512;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="89.9997" x="204.1611" y="149.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="214.1611" y="172.6279">&#36164;&#28304;&#19982;&#35282;&#33394;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="103.9996" x="344.1608" y="121.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.9996" x="354.1608" y="144.4795">&#32487;&#25215;&#65292;&#39063;&#31890;&#24230;</text><path d="M294.1608,167.7813 L304.1608,167.7813 C319.1608,167.7813 319.1608,139.6328 334.1608,139.6328 L344.1608,139.6328" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="134.6862" x="344.1608" y="177.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114.6862" x="354.1608" y="200.7764">SOD&#20114;&#26021;&#30697;&#38453;&#26522;&#20030;</text><path d="M294.1608,167.7813 L304.1608,167.7813 C319.1608,167.7813 319.1608,195.9297 334.1608,195.9297 L344.1608,195.9297" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M154.1611,167.7813 L164.1611,167.7813 C179.1611,167.7813 179.1611,167.7813 194.1611,167.7813 L204.1611,167.7813" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M70.1611,285.9297 L80.1611,285.9297 C95.1611,285.9297 95.1611,167.7813 110.1611,167.7813 L120.1611,167.7813" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="85.1875" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="33.9999" x="120.1611" y="350.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="373.3701">&#26435;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="389.667">&#38480;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="405.9639">&#31574;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="13.9999" x="130.1611" y="422.2607">&#30053;</text><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="129.6141" x="204.1611" y="282.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.9998" x="214.1611" y="305.2217">&#25805;&#20316;&#26435;&#38480;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109.6141" x="214.1611" y="321.5186">(&#36820;&#22238;Boolean&#20540;)</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="132.5535" x="383.7751" y="234.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112.5535" x="393.7751" y="257.0732">&#38750;&#23884;&#22871;RBAC/ACL</text><path d="M333.7751,308.5234 L343.7751,308.5234 C358.7751,308.5234 358.7751,252.2266 373.7751,252.2266 L383.7751,252.2266" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="89.9997" x="383.7751" y="290.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="393.7751" y="313.3701">&#23884;&#22871;&#30340;&#26435;&#38480;</text><path d="M333.7751,308.5234 L343.7751,308.5234 C358.7751,308.5234 358.7751,308.5234 373.7751,308.5234 L383.7751,308.5234" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="134.6862" x="383.7751" y="346.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114.6862" x="393.7751" y="369.667">SOD&#20114;&#26021;&#30697;&#38453;&#26522;&#20030;</text><rect fill="#90EE90" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="130.5231" x="568.4613" y="346.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110.5231" x="578.4613" y="369.667">&#8730; &#23613;&#21487;&#33021;&#36716;&#20026;ACL</text><path d="M518.4613,364.8203 L528.4613,364.8203 C543.4613,364.8203 543.4613,364.8203 558.4613,364.8203 L568.4613,364.8203" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M333.7751,308.5234 L343.7751,308.5234 C358.7751,308.5234 358.7751,364.8203 373.7751,364.8203 L383.7751,364.8203" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M154.1611,392.9688 L164.1611,392.9688 C179.1611,392.9688 179.1611,308.5234 194.1611,308.5234 L204.1611,308.5234" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="128.9234" x="204.1611" y="451.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.7058" x="214.1611" y="474.1123">SQL&#25968;&#25454;&#26435;&#38480;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="108.9234" x="214.1611" y="490.4092">(&#36820;&#22238;&#36807;&#28388;&#30340;&#25968;&#25454;)</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="253.5762" x="383.0845" y="402.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="233.5762" x="393.0845" y="425.9639">&#20363;&#65306;&#21482;&#20801;&#35768;A&#29992;&#25143;&#26597;&#30475;&#33258;&#24049;&#37096;&#38376;&#30340;&#25968;&#25454;</text><path d="M333.0845,477.4141 L343.0845,477.4141 C358.0845,477.4141 358.0845,421.1172 373.0845,421.1172 L383.0845,421.1172" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#90EE90" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="103.3708" x="383.0845" y="459.2656"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.3708" x="393.0845" y="482.2607">&#8730; &#32431;&#32534;&#30721;&#26041;&#26696;</text><path d="M333.0845,477.4141 L343.0845,477.4141 C358.0845,477.4141 358.0845,477.4141 373.0845,477.4141 L383.0845,477.4141" fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#90EE90" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="103.3708" x="383.0845" y="515.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.3708" x="393.0845" y="538.5576">&#8730; &#20302;&#20195;&#30721;&#26041;&#26696;</text><path d="M333.0845,477.4141 L343.0845,477.4141 C358.0845,477.4141 358.0845,533.7109 373.0845,533.7109 L383.0845,533.7109" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M154.1611,392.9688 L164.1611,392.9688 C179.1611,392.9688 179.1611,477.4141 194.1611,477.4141 L204.1611,477.4141" fill="none" style="stroke:#454645;stroke-width:1"/><path d="M70.1611,285.9297 L80.1611,285.9297 C95.1611,285.9297 95.1611,392.9688 110.1611,392.9688 L120.1611,392.9688" fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><h1>权限设计思路</h1><p>本文中，按照“可以复用”，“必须开发”与“有改进潜能”三个维度进行设计评估</p><h2>可复用的组件库</h2><p>下面数据在任何项目都反复使用，这些都是upsert的工作量，不再赘述。需要注意隐私法规。</p><p>以下为管理组侧</p><table><thead><tr><th>数据</th><th>来源</th><th>功能</th></tr></thead><tbody><tr><td>用户贴源层</td><td>第三方IAM Provider系统(SAML/LDAP等)</td><td>证明你是你</td></tr><tr><td>群组贴源层</td><td>第三方IAM Provider系统(SAML/LDAP/Directory等)</td><td>证明你在某个集合中</td></tr><tr><td>SecurityPrincipal</td><td>上述用户与组的贴源数据的并集去重，可以加入额外属性</td><td>使用侧的缓存</td></tr></tbody></table><p>注意这里的群组均不涉及到角色（role）和范围（scope），而只是单纯的数组。同时需要做好上下游的数据防篡改，防止关键群组被提权。</p><blockquote><p>关于扩展属性，简单场景可以用数据库的jsonb/字典表/大宽表，复杂场景可以缓存到Redis/ELK/Clickhouse等广义的列存储中提高性能</p></blockquote><p>以下为资源组侧，可以通过菜单、数据源连接，API网关等抽象方案实现，数据管理也可以参考HW的<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/usermanual-dgc/dgc_01_1001.html">数据湖</a>治理方案。</p><table><thead><tr><th>操作资源</th><th>来源</th><th>功能</th><th>媒介</th></tr></thead><tbody><tr><td>Action</td><td>业务菜单/操作权限</td><td>对资源进行的读写删操作</td><td>HTTP/GraphQL网关</td></tr><tr><td>DataAction</td><td>SQL等语句，含Where条件的参数</td><td>查询数据对应的视图</td><td>DB/BI网关</td></tr><tr><td>Condition</td><td>通过注解/扩展字段等方式录入表达式</td><td>供ABAC使用的属性</td><td>手动/第三方录入</td></tr></tbody></table><blockquote><p>一定先要做好功能（比如菜单）和数据（比如过滤参数）的防遗漏，比如MECE的枚举方法，然后再考虑导入相关人员角色与Mapping设计。</p></blockquote><h2>必须开发的业务代码</h2><p>以下的工作量由于边界/颗粒度难以被公共处理，基本上要自己开发，很考验设计师的抽象能力</p><ul><li>组织架构的继承关系和颗粒度，比如多层嵌套组织，多层嵌套资源（项目）</li><li>资源的颗粒度，比如API级，表级，列级。</li></ul><blockquote><p>网上也有一些开箱即用的RBAC项目，这种黑盒设计的要么太抽象（比如shiro），要么太简陋（开源XXX系统）。建议还是自己实现。</p></blockquote><h2>权限设计选型</h2><h4>三种权限描述方案</h4><table><thead><tr><th>权限关系实现</th><th>解释对象</th><th>代表方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>硬编码真值表</td><td>布尔值</td><td>RBAC数据库</td><td>数组操作；上手简单</td><td>难以处理粒度/属性/覆盖问题</td></tr><tr><td>逻辑等价Logical equivalence</td><td>布尔解释</td><td>规则引擎/有向图/状态机</td><td>形式证明；速度快；属性支持强</td><td>不支持分支/递归；需要逻辑学基础</td></tr><tr><td>实质等价Material equivalence</td><td>目标语言</td><td>Java/自然语言</td><td>符合直觉，堆人天，图灵完备</td><td>代码翻译；上线繁琐；命题歧义</td></tr></tbody></table><p>上述的区别主要就是分析时的“语境”等级，其中低语境的场景下只需要机器去<strong>静态</strong>的执行运算器即可（或者通过定时任务定期生成权限关系），而高语境的场景虽然很强，但是需要“动态解释”工作。三种并没有高低贵贱之分。</p><h4>规则引擎类权限模型的设计不足</h4><p>在传统的数据库判断权限中，底层本质是SQL的交叉运算。那么是否有一种数据结构，能更简化地描述这些细节呢？答案是有向图（以及它的退化Tries，甚至更退化的DFA）。</p><p>举例如下，假如需要实现如下的ABAC场景</p><blockquote><p>部门需要开发一套可视化平台，要求如下：</p><ol><li>如果用户是高级别领导，那么可以看到全部级别数据；如果用户是部门领导，那么只能看到自己部门的数据；如果用户是普通员工，只能看到自己项目的数据</li><li>所有人的权限级别要高于数据的秘密级别</li></ol></blockquote><p>经验上的流程图如下</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="296px" preserveAspectRatio="none" style="width:526px;height:296px;background:#fff" version="1.1" viewBox="0 0 526 296" width="526px" zoomAndPan="magnify" class="kroki">$2<defs/><g><ellipse cx="374.0672" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222;stroke-width:1"/><polygon fill="#F1F1F1" points="308.0677,50,440.0668,50,452.0668,62,440.0668,74,308.0677,74,296.0677,62,308.0677,50" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="131.9991" x="308.0677" y="65.8081">&#29992;&#25143;&#26435;&#38480;&#27604;&#25968;&#25454;&#31192;&#23494;&#32423;&#21035;&#39640;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="19.2178" x="276.8499" y="59.4058">Yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="14.9585" x="452.0668" y="59.4058">No</text><polygon fill="#F1F1F1" points="197.4182,84,269.2561,84,281.2561,96,269.2561,108,197.4182,108,185.4182,96,197.4182,84" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="71.8379" x="197.4182" y="99.8081">&#29992;&#25143;&#26435;&#38480;&#32423;&#21035;?</text><rect fill="#90EE90" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="34.291" x="11" y="143.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.291" x="21" y="164.748">ok</text><polygon fill="#F1F1F1" points="128.2839,143.6094,216.2833,143.6094,228.2833,155.6094,216.2833,167.6094,128.2839,167.6094,116.2839,155.6094,128.2839,143.6094" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="87.9994" x="128.2839" y="159.4175">&#26159;&#33258;&#24049;&#37096;&#38376;&#30340;&#25968;&#25454;</text><rect fill="#90EE90" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="34.291" x="89.1384" y="177.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.291" x="99.1384" y="198.748">ok</text><rect fill="#FFC0CB" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="38.2461" x="219.1602" y="177.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="18.2461" x="229.1602" y="198.748">fail</text><polygon fill="#F1F1F1" points="336.5518,143.6094,424.5512,143.6094,436.5512,155.6094,424.5512,167.6094,336.5518,167.6094,324.5518,155.6094,336.5518,143.6094" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="87.9994" x="336.5518" y="159.4175">&#26159;&#33258;&#24049;&#39033;&#30446;&#30340;&#25968;&#25454;</text><rect fill="#90EE90" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="34.291" x="297.4063" y="177.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.291" x="307.4063" y="198.748">ok</text><rect fill="#FFC0CB" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="38.2461" x="427.4282" y="177.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="18.2461" x="437.4282" y="198.748">fail</text><polygon fill="#F1F1F1" points="233.3371,221.5781,233.3371,221.5781,245.3371,233.5781,233.3371,245.5781,233.3371,245.5781,221.3371,233.5781,233.3371,221.5781" style="stroke:#181818;stroke-width:.5"/><ellipse cx="233.3371" cy="275.5781" fill="none" rx="10" ry="10" style="stroke:#222;stroke-width:1.5"/><line style="stroke:#222;stroke-width:2.5" x1="227.1499" x2="239.5243" y1="269.3909" y2="281.7653"/><line style="stroke:#222;stroke-width:2.5" x1="239.5243" x2="227.1499" y1="269.3909" y2="281.7653"/><rect fill="#FFC0CB" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="38.2461" x="477.0253" y="84"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="18.2461" x="487.0253" y="105.1387">fail</text><line style="stroke:#454645;stroke-width:1" x1="116.2839" x2="106.2839" y1="155.6094" y2="155.6094"/><line style="stroke:#454645;stroke-width:1" x1="106.2839" x2="106.2839" y1="155.6094" y2="177.6094"/><polygon fill="#454645" points="102.2839,167.6094,106.2839,177.6094,110.2839,167.6094,106.2839,171.6094" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="228.2833" x2="238.2833" y1="155.6094" y2="155.6094"/><line style="stroke:#454645;stroke-width:1" x1="238.2833" x2="238.2833" y1="155.6094" y2="177.6094"/><polygon fill="#454645" points="234.2833,167.6094,238.2833,177.6094,242.2833,167.6094,238.2833,171.6094" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="106.2839" x2="106.2839" y1="211.5781" y2="216.5781"/><line style="stroke:#454645;stroke-width:1" x1="106.2839" x2="172.2836" y1="216.5781" y2="216.5781"/><line style="stroke:#454645;stroke-width:1" x1="172.2836" x2="172.2836" y1="216.5781" y2="233.5781"/><polygon fill="#454645" points="168.2836,223.5781,172.2836,233.5781,176.2836,223.5781,172.2836,227.5781" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="324.5518" x2="314.5518" y1="155.6094" y2="155.6094"/><line style="stroke:#454645;stroke-width:1" x1="314.5518" x2="314.5518" y1="155.6094" y2="177.6094"/><polygon fill="#454645" points="310.5518,167.6094,314.5518,177.6094,318.5518,167.6094,314.5518,171.6094" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="436.5512" x2="446.5512" y1="155.6094" y2="155.6094"/><line style="stroke:#454645;stroke-width:1" x1="446.5512" x2="446.5512" y1="155.6094" y2="177.6094"/><polygon fill="#454645" points="442.5512,167.6094,446.5512,177.6094,450.5512,167.6094,446.5512,171.6094" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="314.5518" x2="314.5518" y1="211.5781" y2="233.5781"/><line style="stroke:#454645;stroke-width:1" x1="314.5518" x2="245.3371" y1="233.5781" y2="233.5781"/><polygon fill="#454645" points="255.3371,229.5781,245.3371,233.5781,255.3371,237.5781,251.3371,233.5781" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="185.4182" x2="28.1455" y1="96" y2="96"/><line style="stroke:#454645;stroke-width:1" x1="28.1455" x2="28.1455" y1="96" y2="143.6094"/><polygon fill="#454645" points="24.1455,133.6094,28.1455,143.6094,32.1455,133.6094,28.1455,137.6094" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="43.9997" x="31.6421" y="123.6128">&#39640;&#32423;&#39046;&#23548;</text><line style="stroke:#454645;stroke-width:1" x1="281.2561" x2="380.5515" y1="96" y2="96"/><line style="stroke:#454645;stroke-width:1" x1="380.5515" x2="380.5515" y1="96" y2="143.6094"/><polygon fill="#454645" points="376.5515,133.6094,380.5515,143.6094,384.5515,133.6094,380.5515,137.6094" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="43.9997" x="384.0481" y="123.6128">&#26222;&#36890;&#21592;&#24037;</text><line style="stroke:#454645;stroke-width:1" x1="172.2836" x2="172.2836" y1="96" y2="143.6094"/><polygon fill="#454645" points="168.2836,133.6094,172.2836,143.6094,176.2836,133.6094,172.2836,137.6094" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="43.9997" x="175.7802" y="118.6128">&#37096;&#38376;&#39046;&#23548;</text><line style="stroke:#454645;stroke-width:1" x1="28.1455" x2="28.1455" y1="177.5781" y2="233.5781"/><line style="stroke:#454645;stroke-width:1" x1="28.1455" x2="221.3371" y1="233.5781" y2="233.5781"/><polygon fill="#454645" points="211.3371,229.5781,221.3371,233.5781,211.3371,237.5781,215.3371,233.5781" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="233.3371" x2="233.3371" y1="245.5781" y2="265.5781"/><polygon fill="#454645" points="229.3371,255.5781,233.3371,265.5781,237.3371,255.5781,233.3371,259.5781" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="296.0677" x2="233.3371" y1="62" y2="62"/><line style="stroke:#454645;stroke-width:1" x1="233.3371" x2="233.3371" y1="62" y2="84"/><polygon fill="#454645" points="229.3371,74,233.3371,84,237.3371,74,233.3371,78" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="452.0668" x2="496.1483" y1="62" y2="62"/><line style="stroke:#454645;stroke-width:1" x1="496.1483" x2="496.1483" y1="62" y2="84"/><polygon fill="#454645" points="492.1483,74,496.1483,84,500.1483,74,496.1483,78" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="374.0672" x2="374.0672" y1="30" y2="50"/><polygon fill="#454645" points="370.0672,40,374.0672,50,378.0672,40,374.0672,44" style="stroke:#454645;stroke-width:1"/></g></svg><p>如下是用传统过程式的代码实现，符合Java等语言的编程习惯</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命题： A&amp;((B-&gt;G)|(C&amp;F)-&gt;G)|(D&amp;E)-&gt;G))</span></span><br><span class="line">function test(<span class="title class_">User</span> input)&#123;</span><br><span class="line">  <span class="keyword">if</span>(input.access_level &lt; input.query.param.access_level)&#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (input.access_level &gt;= <span class="number">50</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (input.access_level &lt; <span class="number">50</span> &amp;&amp; input.access_level &gt;=<span class="number">40</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> input.dept == input.query.param.dept;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (input.access_level &lt; <span class="number">40</span> &amp;&amp; input.access_level &gt;=<span class="number">30</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> input.projects.contains(input.query.param.project);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们将其转换为逻辑命题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">命题：</span><br><span class="line">A: 用户权限比数据秘密级别高</span><br><span class="line">B: 用户是高级领导</span><br><span class="line">C: 用户是部门领导</span><br><span class="line">D: 用户是普通员工</span><br><span class="line">E: 用户在看自己部门的数据</span><br><span class="line">F: 用户在看自己项目的数据</span><br><span class="line">G: 用户可以访问数据</span><br></pre></td></tr></table></figure><p>如下是OPA(rego)的实现，它是非时序逻辑。由于不支持if语句，因此产生了重复的语句</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命题：((A&amp;B)-&gt;G)|((A&amp;C&amp;F)-&gt;G)|((A&amp;D&amp;E)-&gt;G)</span></span><br><span class="line">default allow = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 如果满足A与B，那么G命题成立</span></span><br><span class="line">allow &#123;</span><br><span class="line">  input.access_level &gt;= input.query.param.access_level</span><br><span class="line">  input.access_level &gt;= <span class="number">50</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">  input.access_level &gt;= input.query.param.access_level</span><br><span class="line">  input.access_level &gt;= <span class="number">40</span></span><br><span class="line">  input.access_level &lt; <span class="number">50</span></span><br><span class="line">  input.dept == input.query.param.dept</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">  input.access_level &gt;= input.query.param.access_level</span><br><span class="line">  input.access_level &gt;= <span class="number">30</span></span><br><span class="line">  input.access_level &lt; <span class="number">40</span></span><br><span class="line">  input.query.param.project == input.projects[_]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>完整Demo与用例在这里 <a target="_blank" rel="noopener" href="https://play.openpolicyagent.org/p/WFbjph2KyY">https://play.openpolicyagent.org/p/WFbjph2KyY</a> ，本部分的access_level仅供演示设计</p></blockquote><p>通过上面的例子，我们可以看出声明语言的门槛：<strong>你需要手写遍历所有tries的可能性</strong>，类似于电路设计中不允许使用寄存器。</p><p>无论是Drools/Casbin/OPA，它们本质上都是通过维护rules描述出了一个Trie (Prefix Tree)的数据结构，通过遍历所有的分支，找出第一个返回为true的最短路径（Boolean interceptor），特点如下</p><ul><li>对时序逻辑的的支持很差：只有数据结构，没有时间概念，即缓存与“优先级”</li><li>难以枚举：无法拥有值，而是拥有“计算的潜力”，是否拥有权限只有运行时才得知</li></ul><p>但是当前即使在芯片设计中也在推广&quot;低效&quot;的Chisel而不是Verilog，恰恰说明了声明语言的高门槛。</p><blockquote><p>上述的例子尽管从结果上可以看出两种命题是等价的，但是严格的形式证明可以参考《逻辑学导论》中的逻辑等价，或者笛卡尔积相关知识。这种编程风格的门槛非常高。</p></blockquote><h4>数据治理场景的权限(row-level filter)</h4><p>数据主题指对where条件的限制，即Context based row-level filter，比如用户只能看到自己所在部门的数据，这种场景主要在数据治理与BI分析中非常常见。注意这里的filter指代where条件的过滤项。</p><p>大部分权限处理如下：</p><ul><li>数据源的权限处理：需要对数据主题进行贴源，聚合，资产化，定级（比如内部公开，秘密，机密等），脱敏，GDPR等加工。敏感的数据不入库，降低权限开发负担。</li><li>机-机接口（IT租户）的权限：比如数据库表/视图、API-Token授权、消息队列对某个租户开放</li><li>业务级别权限：比如”员工只能看到自己部门的权限“，需要定制</li></ul><p>非业务诉求如下：</p><ul><li>需要尽可能提高开发效率，而不是天天写Controller</li></ul><p>这类场景做到最后，就一定会演化到大数据场景，可以参考Huawei的<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/dgc/index.html">数据湖治理中心</a>服务，或者参考retool的低代码方案。</p><p>上述的定制成本均比较高，门槛在于业务专家上。如果追求快而去愿意掏钱的话，个人更建议</p><ul><li>假如项目定位是度量或者报表，那么就是典型的大数据项目，问题在大数据建模上</li><li>数据录入与处理：购买DGC/Redshift等数据治理服务、ROMA等data Pipeline服务</li><li>数据展示侧：掏钱使用BI软件或者云服务，比如<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/intl/zh-cn/usermanual-dlv/dlv_01_0202.html">DLV</a>等low-code方案。</li></ul><p>如果自己有足够的时间又想用免费的组件，参考如下</p><ul><li>将Context嵌入业务强相关逻辑中，并在SQL/ORM侧的<strong>模版引擎</strong>来改写SQL</li><li>甚至Mybatis的LanguageDriver/插件进行SQL定制，下游集成phoenix等聚合JDBC</li><li>参考redash的<a target="_blank" rel="noopener" href="https://github.com/getredash/redash/issues/3284">讨论</a>，替换redash内置的jinja模版引擎升级为高级语言/rego，最终实现ABAC的过滤方案，但是它没有预编译能力，可能有注入或者性能问题</li></ul><h1>其他功能</h1><p>如下要求是纯工程问题，可以自行决策是否使用</p><h4>三权分立的策略管理界面(Zero-trust)</h4><p>当你的SaaS项目中存在了很多重要数据时，如何让客户信任你呢？</p><p>当然是需要满足SOD(separation of duty，权限职责分离)与自举管理。比如下面是常见的三权分立</p><table><thead><tr><th>角色</th><th>查看业务数据</th><th>IT日常维护</th><th>安全管理与审计</th></tr></thead><tbody><tr><td>业务部门(租户)</td><td>Y</td><td>N</td><td>N</td></tr><tr><td>IT维护人员</td><td>N</td><td>Y</td><td>N</td></tr><tr><td>安全内控部</td><td>N</td><td>N</td><td>Y*</td></tr></tbody></table><p>上面的需求本质是“权限的权限”，或者“policy ownership”，总体上就是把所有人当贼来防（这个只有大公司/SaaS服务才能这样折腾了），上述有三个问题</p><ul><li>需要预置一些初始化账号，配置限制与审计策略（比如二次验证），防止内控部的人私自提权内盗</li><li>需要实现自举(self-compiling)</li><li>权利与义务对等，用户拥有数据后，也需要承担安全责任主体</li></ul><p>此外，此权限方案的开发成本极高，每个动作入口与矩阵都需要进行二维矩阵式的枚举验证，用于写到安全白皮书里面。</p><p>真正要做到安全认证的话，这里还是要请安全团队进行渗透测试，业务侧的设计师很难面面俱到。</p><h4>最终方案</h4><p>经过多个技术调研，最终选择基于AntPathMatcher实现类似Azure的IAM的low-code的权限模型，最终全部RBAC合并到ACL中，全部代码只有一个Java文件。只提供一些checkBoolean的无状态接口，因为大部分权限实际开发后发现会和业务的if/where条件耦合。数据权限仍然无法摆脱mybatis或者jinja等模版引擎。</p><h1>附录</h1><h2>策略引擎的选型</h2><p>以下主要为基于<a href="/tags/RuleEngine">规则引擎</a>的方案，假如你接触过Drools，那么理解会比较容易</p><ul><li>开源方案，通过遍历真值表进行验证，这里是形式化逻辑的领域，通过手写tries的AST来形式化判断权限。<ul><li><a target="_blank" rel="noopener" href="https://v2ex.com/t/887117#reply29">Casbin</a>：偏学术化，而且它的DSL太烂了，就连Harbor这种级别的用户都只能抄官方demo，被用户评价为“读研时给导师打工”。</li><li><a target="_blank" rel="noopener" href="https://www.openpolicyagent.org/">Open Policy Agent</a> (OPA)：来自云原生项目且已毕业，通过实时执行rego策略代码（会优化为WASM代码），判断是否有权限，可以参考<a target="_blank" rel="noopener" href="https://www.openpolicyagent.org/docs/latest/comparison-to-other-systems/">Demo介绍</a>即可。<ul><li>性能：它本身是无状态的，可以堆机器。</li><li>生态(Adopter)：GitOps/K8S等<a target="_blank" rel="noopener" href="https://github.com/open-policy-agent/opa/blob/main/ADOPTERS.md">云应用</a>，但是没有太多业务级的线上场景</li><li>规则能力：对if嵌套逻辑的都不是很好，难以断点调试，也很反直觉。</li><li>缺少开源二次封装（比如GUI/管理编辑界面）与生产实践（比如版本自动发布）</li></ul></li><li>Serverless/Drools/ <a target="_blank" rel="noopener" href="https://www.cloudflare.com/products/cloudflare-workers/">Cloudflare Worker</a>: 可以将上述的编译产物扔到边缘计算中</li><li>AntPathMatcher：Spring自带的工具，可以参考Artifactory开源的PermissonTarget权限模型，被采用。</li></ul></li><li>收费/闭源产品<ul><li>HashiCorp Sentinel: 是proprietary and closed source，设计与文档都很优雅，但是没有API，rules与js代码差不多，仅供参考思路</li><li>Retool: 是我目前见到的最完美的low-code（基于js实现） + 权限方案，既有admin级别，也有项目级别，项目内部有ACL与ABAC，不提供rules，毕竟是YC毕业的收费项目。假如你的项目可以用它的low-code完成，可以把应用本体开发工作量也算进去</li><li><a target="_blank" rel="noopener" href="https://www.ory.sh/">ory</a>的keto ：一款一站式权限方案，当前后台与API均开源，而前台为SaaS提供。用一种DSL来描述图的关系，实现了<a target="_blank" rel="noopener" href="https://research.google/pubs/pub48190/">谷歌论文</a>中图的遍历算法，比OPA的tries树遍历更强大。当前属于创业与重构阶段，可能无法生产使用。</li><li>另外可以参考美团的这篇<a target="_blank" rel="noopener" href="https://tech.meituan.com/2017/06/09/maze-framework.html">自研规则引擎</a>的文章。</li></ul></li></ul><h2>知名软件项目选型一览</h2><h4>云项目设计</h4><p>下图是参考Azure云服务术语反推出的ER逻辑图</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="CLASS" height="561px" preserveAspectRatio="none" style="width:496px;height:561px;background:#fff" version="1.1" viewBox="0 0 496 561" width="496px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g class="entity" data-entity="ManagementGroup" data-source-line="2" data-uid="ent0002" id="entity_ManagementGroup"><rect fill="#F1F1F1" height="48" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="167.1533" x="7" y="132"/><ellipse cx="22" cy="148" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1"/><path d="M24.9688,153.6406 Q24.3906,153.9375 23.75,154.0781 Q23.1094,154.2344 22.4063,154.2344 Q19.9063,154.2344 18.5781,152.5938 Q17.2656,150.9375 17.2656,147.8125 Q17.2656,144.6875 18.5781,143.0313 Q19.9063,141.375 22.4063,141.375 Q23.1094,141.375 23.75,141.5313 Q24.4063,141.6875 24.9688,141.9844 L24.9688,144.7031 Q24.3438,144.125 23.75,143.8594 Q23.1563,143.5781 22.5313,143.5781 Q21.1875,143.5781 20.5,144.6563 Q19.8125,145.7188 19.8125,147.8125 Q19.8125,149.9063 20.5,150.9844 Q21.1875,152.0469 22.5313,152.0469 Q23.1563,152.0469 23.75,151.7813 Q24.3438,151.5 24.9688,150.9219 L24.9688,153.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135.1533" x="36" y="152.8467">ManagementGroup</text><line style="stroke:#181818;stroke-width:.5" x1="8" x2="173.1533" y1="164" y2="164"/><line style="stroke:#181818;stroke-width:.5" x1="8" x2="173.1533" y1="172" y2="172"/></g><g class="entity" data-entity="SecurityPrincipal" data-source-line="3" data-uid="ent0004" id="entity_SecurityPrincipal"><rect fill="#F1F1F1" height="48" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="149.3936" x="267.88" y="7"/><ellipse cx="282.88" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1"/><path d="M285.8488,28.6406 Q285.2706,28.9375 284.63,29.0781 Q283.9894,29.2344 283.2863,29.2344 Q280.7863,29.2344 279.4581,27.5938 Q278.1456,25.9375 278.1456,22.8125 Q278.1456,19.6875 279.4581,18.0313 Q280.7863,16.375 283.2863,16.375 Q283.9894,16.375 284.63,16.5313 Q285.2863,16.6875 285.8488,16.9844 L285.8488,19.7031 Q285.2238,19.125 284.63,18.8594 Q284.0363,18.5781 283.4113,18.5781 Q282.0675,18.5781 281.38,19.6563 Q280.6925,20.7188 280.6925,22.8125 Q280.6925,24.9063 281.38,25.9844 Q282.0675,27.0469 283.4113,27.0469 Q284.0363,27.0469 284.63,26.7813 Q285.2238,26.5 285.8488,25.9219 L285.8488,28.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="117.3936" x="296.88" y="27.8467">SecurityPrincipal</text><line style="stroke:#181818;stroke-width:.5" x1="268.88" x2="416.2736" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:.5" x1="268.88" x2="416.2736" y1="47" y2="47"/></g><g class="entity" data-entity="Subscription" data-source-line="3" data-uid="ent0005" id="entity_Subscription"><rect fill="#F1F1F1" height="48" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="118.9873" x="283.08" y="132"/><ellipse cx="298.08" cy="148" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1"/><path d="M301.0488,153.6406 Q300.4706,153.9375 299.83,154.0781 Q299.1894,154.2344 298.4863,154.2344 Q295.9863,154.2344 294.6581,152.5938 Q293.3456,150.9375 293.3456,147.8125 Q293.3456,144.6875 294.6581,143.0313 Q295.9863,141.375 298.4863,141.375 Q299.1894,141.375 299.83,141.5313 Q300.4863,141.6875 301.0488,141.9844 L301.0488,144.7031 Q300.4238,144.125 299.83,143.8594 Q299.2363,143.5781 298.6113,143.5781 Q297.2675,143.5781 296.58,144.6563 Q295.8925,145.7188 295.8925,147.8125 Q295.8925,149.9063 296.58,150.9844 Q297.2675,152.0469 298.6113,152.0469 Q299.2363,152.0469 299.83,151.7813 Q300.4238,151.5 301.0488,150.9219 L301.0488,153.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86.9873" x="312.08" y="152.8467">Subscription</text><line style="stroke:#181818;stroke-width:.5" x1="284.08" x2="401.0673" y1="164" y2="164"/><line style="stroke:#181818;stroke-width:.5" x1="284.08" x2="401.0673" y1="172" y2="172"/></g><g class="entity" data-entity="ResourceGroup" data-source-line="4" data-uid="ent0007" id="entity_ResourceGroup"><rect fill="#F1F1F1" height="48" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="140.0693" x="266.54" y="288"/><ellipse cx="281.54" cy="304" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1"/><path d="M284.5088,309.6406 Q283.9306,309.9375 283.29,310.0781 Q282.6494,310.2344 281.9463,310.2344 Q279.4463,310.2344 278.1181,308.5938 Q276.8056,306.9375 276.8056,303.8125 Q276.8056,300.6875 278.1181,299.0313 Q279.4463,297.375 281.9463,297.375 Q282.6494,297.375 283.29,297.5313 Q283.9463,297.6875 284.5088,297.9844 L284.5088,300.7031 Q283.8838,300.125 283.29,299.8594 Q282.6963,299.5781 282.0713,299.5781 Q280.7275,299.5781 280.04,300.6563 Q279.3525,301.7188 279.3525,303.8125 Q279.3525,305.9063 280.04,306.9844 Q280.7275,308.0469 282.0713,308.0469 Q282.6963,308.0469 283.29,307.7813 Q283.8838,307.5 284.5088,306.9219 L284.5088,309.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="108.0693" x="295.54" y="308.8467">ResourceGroup</text><line style="stroke:#181818;stroke-width:.5" x1="267.54" x2="405.6093" y1="320" y2="320"/><line style="stroke:#181818;stroke-width:.5" x1="267.54" x2="405.6093" y1="328" y2="328"/></g><g class="entity" data-entity="Resource" data-source-line="5" data-uid="ent0009" id="entity_Resource"><rect fill="#F1F1F1" height="48" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="97.1396" x="304.01" y="397"/><ellipse cx="319.01" cy="413" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1"/><path d="M321.9788,418.6406 Q321.4006,418.9375 320.76,419.0781 Q320.1194,419.2344 319.4163,419.2344 Q316.9163,419.2344 315.5881,417.5938 Q314.2756,415.9375 314.2756,412.8125 Q314.2756,409.6875 315.5881,408.0313 Q316.9163,406.375 319.4163,406.375 Q320.1194,406.375 320.76,406.5313 Q321.4163,406.6875 321.9788,406.9844 L321.9788,409.7031 Q321.3538,409.125 320.76,408.8594 Q320.1663,408.5781 319.5413,408.5781 Q318.1975,408.5781 317.51,409.6563 Q316.8225,410.7188 316.8225,412.8125 Q316.8225,414.9063 317.51,415.9844 Q318.1975,417.0469 319.5413,417.0469 Q320.1663,417.0469 320.76,416.7813 Q321.3538,416.5 321.9788,415.9219 L321.9788,418.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65.1396" x="333.01" y="417.8467">Resource</text><line style="stroke:#181818;stroke-width:.5" x1="305.01" x2="400.1496" y1="429" y2="429"/><line style="stroke:#181818;stroke-width:.5" x1="305.01" x2="400.1496" y1="437" y2="437"/></g><g class="entity" data-entity="Action" data-source-line="6" data-uid="ent0011" id="entity_Action"><rect fill="#F1F1F1" height="48" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="76.0918" x="367.53" y="506"/><ellipse cx="382.53" cy="522" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1"/><path d="M385.4988,527.6406 Q384.9206,527.9375 384.28,528.0781 Q383.6394,528.2344 382.9363,528.2344 Q380.4363,528.2344 379.1081,526.5938 Q377.7956,524.9375 377.7956,521.8125 Q377.7956,518.6875 379.1081,517.0313 Q380.4363,515.375 382.9363,515.375 Q383.6394,515.375 384.28,515.5313 Q384.9363,515.6875 385.4988,515.9844 L385.4988,518.7031 Q384.8738,518.125 384.28,517.8594 Q383.6863,517.5781 383.0613,517.5781 Q381.7175,517.5781 381.03,518.6563 Q380.3425,519.7188 380.3425,521.8125 Q380.3425,523.9063 381.03,524.9844 Q381.7175,526.0469 383.0613,526.0469 Q383.6863,526.0469 384.28,525.7813 Q384.8738,525.5 385.4988,524.9219 L385.4988,527.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="44.0918" x="396.53" y="526.8467">Action</text><line style="stroke:#181818;stroke-width:.5" x1="368.53" x2="442.6218" y1="538" y2="538"/><line style="stroke:#181818;stroke-width:.5" x1="368.53" x2="442.6218" y1="546" y2="546"/></g><g class="entity" data-entity="Role" data-source-line="7" data-uid="ent0013" id="entity_Role"><rect fill="#F1F1F1" height="48" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="62.7959" x="427.18" y="210"/><ellipse cx="442.18" cy="226" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1"/><path d="M445.1488,231.6406 Q444.5706,231.9375 443.93,232.0781 Q443.2894,232.2344 442.5863,232.2344 Q440.0863,232.2344 438.7581,230.5938 Q437.4456,228.9375 437.4456,225.8125 Q437.4456,222.6875 438.7581,221.0313 Q440.0863,219.375 442.5863,219.375 Q443.2894,219.375 443.93,219.5313 Q444.5863,219.6875 445.1488,219.9844 L445.1488,222.7031 Q444.5238,222.125 443.93,221.8594 Q443.3363,221.5781 442.7113,221.5781 Q441.3675,221.5781 440.68,222.6563 Q439.9925,223.7188 439.9925,225.8125 Q439.9925,227.9063 440.68,228.9844 Q441.3675,230.0469 442.7113,230.0469 Q443.3363,230.0469 443.93,229.7813 Q444.5238,229.5 445.1488,228.9219 L445.1488,231.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.7959" x="456.18" y="230.8467">Role</text><line style="stroke:#181818;stroke-width:.5" x1="428.18" x2="488.9759" y1="242" y2="242"/><line style="stroke:#181818;stroke-width:.5" x1="428.18" x2="488.9759" y1="250" y2="250"/></g><g class="link" data-entity-1="ManagementGroup" data-entity-2="ManagementGroup" data-source-line="2" data-uid="lnk3" id="link_ManagementGroup_ManagementGroup"><path codeLine="2" d="M174.5,144.5 C194.43,145.42 209.15,149.26 209.15,156 C209.15,162.74 194.43,166.58 174.5,167.5" fill="none" id="ManagementGroup-ManagementGroup" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44.3574" x="215.15" y="160.5669">nested</text></g><g class="link" data-entity-1="SecurityPrincipal" data-entity-2="Subscription" data-source-line="3" data-uid="lnk6" id="link_SecurityPrincipal_Subscription"><path codeLine="3" d="M342.58,55.42 C342.58,77.31 342.58,109.8 342.58,131.66" fill="none" id="SecurityPrincipal-Subscription" style="stroke:#454645;stroke-width:1"/></g><g class="link" data-entity-1="Subscription" data-entity-2="ResourceGroup" data-source-line="4" data-uid="lnk8" id="link_Subscription_ResourceGroup"><path codeLine="4" d="M341.67,180.39 C340.53,209.42 338.62,258.63 337.49,287.64" fill="none" id="Subscription-ResourceGroup" style="stroke:#454645;stroke-width:1"/></g><g class="link" data-entity-1="ResourceGroup" data-entity-2="Resource" data-source-line="5" data-uid="lnk10" id="link_ResourceGroup_Resource"><path codeLine="5" d="M340.09,336.48 C342.76,354.32 346.41,378.75 349.07,396.57" fill="none" id="ResourceGroup-Resource" style="stroke:#454645;stroke-width:1"/></g><g class="link" data-entity-1="Resource" data-entity-2="Action" data-source-line="6" data-uid="lnk12" id="link_Resource_Action"><path codeLine="6" d="M364.21,445.48 C373.04,463.32 385.14,487.75 393.97,505.57" fill="none" id="Resource-Action" style="stroke:#454645;stroke-width:1"/></g><g class="link" data-entity-1="Role" data-entity-2="Action" data-source-line="7" data-uid="lnk14" id="link_Role_Action"><path codeLine="7" d="M454.42,258.07 C444.53,312.89 419.73,450.51 409.79,505.63" fill="none" id="Role-Action" style="stroke:#454645;stroke-width:1"/></g><g class="link" data-entity-1="SecurityPrincipal" data-entity-2="Role" data-source-line="8" data-uid="lnk15" id="link_SecurityPrincipal_Role"><path codeLine="8" d="M363.64,55.28 C380.43,74.73 403.68,103.73 419.58,132 C433.77,157.23 445,188.65 451.69,209.69" fill="none" id="SecurityPrincipal-Role" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="41.6152" x="400.58" y="98.0669">assign</text></g><g class="link" data-entity-1="SecurityPrincipal" data-entity-2="ManagementGroup" data-source-line="9" data-uid="lnk16" id="link_SecurityPrincipal_ManagementGroup"><path codeLine="9" d="M294.58,55.42 C249.74,77.31 183.17,109.8 138.39,131.66" fill="none" id="SecurityPrincipal-ManagementGroup" style="stroke:#454645;stroke-width:1"/></g></g></svg><p>值得注意的是，云项目中最细的粒度一般是服务实例级别（菜单级），而难以细化到实例内部的数据权限。比如你在租户下申请了K8S集群实例，想分给别人用，很难在管理侧细化到具体的namespace/secret等权限，而需要更细的数据权限方案。</p><blockquote><p>同时也要注意，云项目一般过于复杂，尤其Role是三个多对多，需要规则引擎来实现，中小型快餐项目不推荐照搬使用。假如不涉及到费用、库存和限额，一般也没必要设计资源组的概念。</p></blockquote><h4>常见工具链项目</h4><p>以下为应用层项目（均基于数据库软隔离的方案，即Sharded multi-tenant databases ）</p><table><thead><tr><th>平台</th><th>Gitlab</th><th>Sonarqube</th><th>Artifactory</th><th>SVN</th></tr></thead><tbody><tr><td>SecurityPrincipal</td><td>User/Group</td><td>User/Group</td><td>User/Group</td><td>ACL</td></tr><tr><td>Resources</td><td>code</td><td>code</td><td>artifacts</td><td>code</td></tr><tr><td>Top-level-role</td><td>nested RBAC</td><td>RBAC</td><td>ACL</td><td>ACL</td></tr><tr><td>Repo-level-role</td><td>RBAC</td><td>ACL</td><td>ACL</td><td>ACL</td></tr><tr><td>Path priority &amp; Inheritance</td><td>NA</td><td>NA</td><td>deny&gt;allow,shortest first</td><td>longest first</td></tr><tr><td>comment</td><td>总管理员<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/user/permissions.html">可以看到</a>代码</td><td>Mapping关系复杂度为O(N<sup>2</sup>)</td><td>AntPathMatcher存储RawJSON</td><td><a target="_blank" rel="noopener" href="https://www.visualsvn.com/support/topic/00033/">参考</a></td></tr></tbody></table><p>上文场景中的Role中绑定的是<code>SecurityPrincipal</code>，即个人与群组被作为相同的范畴，因此在Sonarqube等工具被看作ACL。</p><blockquote><p>其中Gitlab组织中加入了“角色概念”而不是一个单纯的数组，是失败中的失败，在项目中枚举了50多种，耗费一周后放弃</p></blockquote><h4>常见APM/Low-code/可视化相关项目</h4><table><thead><tr><th>平台</th><th>retool</th><th>Sentry</th><th>Metabase-Paid</th><th>Redash OSS</th></tr></thead><tbody><tr><td>SecurityPrincipal</td><td>User/Group</td><td>User</td><td>User/Group</td><td>User</td></tr><tr><td>Top-level-role</td><td>NA(SaaS)</td><td>RBAC</td><td>RBAC</td><td>ACL</td></tr><tr><td>Project-level-role</td><td>RBAC</td><td>nested ACL(by copy)</td><td>ACL</td><td>ACL</td></tr><tr><td>comment</td><td>相对Sonar多了<a target="_blank" rel="noopener" href="https://docs.retool.com/docs/user-permissions">文件夹</a>的概念</td><td><a target="_blank" rel="noopener" href="https://docs.sentry.io/product/accounts/membership/">固定的</a>策略</td><td>借助了模版引擎精确到ABAC的<a target="_blank" rel="noopener" href="https://www.metabase.com/learn/permissions/data-sandboxing-row-permissions.html">行级别</a>支持</td><td>人均管理员</td></tr></tbody></table><p>常见P层项目</p><table><thead><tr><th>平台</th><th>mgr grp</th><th>res grp</th><th>mgr member</th><th>res member</th><th>评价</th></tr></thead><tbody><tr><td>OpenLDAP+PAM</td><td>root</td><td>ACL</td><td>User,group</td><td>File</td><td>基于chmod实现的Linux HPC</td></tr><tr><td>开源版K8S</td><td>RBAC</td><td>RBAC</td><td>token</td><td>resources</td><td>名义上RBAC，事实上都要大量定制</td></tr><tr><td>AWS_K8S</td><td>RBAC</td><td>ABAC</td><td>user,group, role</td><td>resources</td><td>AWS的万能方案</td></tr><tr><td>Harbor</td><td>RBAC</td><td>FullAccess</td><td>User</td><td>docker镜像</td><td>灵活度很差</td></tr><tr><td>AWS_S3</td><td>RBAC</td><td>ABAC</td><td>User, Group, role</td><td>精确到<a target="_blank" rel="noopener" href="https://aws.amazon.com/jp/blogs/security/writing-iam-policies-grant-access-to-user-specific-folders-in-an-amazon-s3-bucket/">文件夹</a></td><td>AWS的万能方案</td></tr><tr><td>HashiCorp OSS</td><td>ACL</td><td>ACL</td><td>token</td><td><a target="_blank" rel="noopener" href="https://learn.hashicorp.com/collections/nomad/access-control">capabilities</a>的集合</td><td>IaaS场景足够了</td></tr><tr><td>HashiCorp Enterprise</td><td>ACL</td><td>ACL</td><td>token</td><td><a target="_blank" rel="noopener" href="https://www.hashicorp.com/sentinel">sentinel</a></td><td>万能且收费</td></tr></tbody></table><p>上述可以得出一个结论</p><ul><li>不涉及嵌套时，经典的RBAC/ABAC基本足够</li><li>涉及到嵌套，数据查看与过滤时，基于当前用户的属性（Role也算属性）进行管理，即ABAC是更好的方法，实现上可以转化为ACL</li></ul><h4>其它术语</h4><p>权限模型相关术语</p><ul><li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Access_control_list">ACL</a>, <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh/%E4%BB%A5%E8%A7%92%E8%89%B2%E7%82%BA%E5%9F%BA%E7%A4%8E%E7%9A%84%E5%AD%98%E5%8F%96%E6%8E%A7%E5%88%B6">RBAC</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Attribute-based_access_control">ABAC</a></li></ul><p>微软的RBAC文档写的最好，建议参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/">这里</a>后再来阅读本文</p></div><div class="tags"><a class="tag-link" href="/tags/Authz/" rel="tag">Authz</a><a class="tag-link" href="/tags/CNCF/" rel="tag">CNCF</a><a class="tag-link" href="/tags/Open-Policy-Agent/" rel="tag">Open Policy Agent</a><a class="tag-link" href="/tags/RuleEngine/" rel="tag">RuleEngine</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>