<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="本文分析了数十款知名项目的权限架构，并提出了一款基于云原生权限框架的灵活配置思路。"><meta name="keyword" content="Authz,CNCF,Open Policy Agent,RuleEngine,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>基于Open Policy Agent的Authz权限设计探索</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-102296742-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-102296742-1")</script><meta name="generator" content="Hexo 5.4.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">基于Open Policy Agent的Authz权限设计探索</div><div class="date">2021-10-10 / modified at 2022-12-04</div><div class="content"><p>本文分析了数十款知名项目的权限架构，并提出了一款基于云原生权限框架的灵活配置思路。</p><span id="more"></span><h2>总体流程</h2><p>当前市场中基本没有太多开箱即用的权限管理产品，如果需要自行开发，参考流程如下</p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="489px" preserveAspectRatio="none" style="width:664px;height:489px;background:#fff" version="1.1" viewBox="0 0 664 489" width="664px" zoomAndPan="magnify" class="kroki">$2<defs/><g><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="60" x="10" y="225.5586"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="20" y="248.5537">Authz</text><rect fill="#F1F1F1" height="85.1875" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="34" x="120" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="42.9951">&#22522;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="59.292">&#30784;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="75.5889">&#25968;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="91.8857">&#25454;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="198" x="204" y="44.4453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="178" x="214" y="67.4404">&#29992;&#25143;/&#32676;&#32452;/&#26426;&#22120;&#20154;&#30340;&#22522;&#26412;&#23646;&#24615;</text><rect fill="#90EE90" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="151" x="452" y="44.4453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="462" y="67.4404">&#8730; &#36825;&#20123;&#22343;&#21487;&#20197;SaaS&#21270;</text><path d="M402,62.5938 L412,62.5938 C427,62.5938 427,62.5938 442,62.5938 L452,62.5938 " fill="none" style="stroke:#454645;stroke-width:1"/><path d="M154,62.5938 L164,62.5938 C179,62.5938 179,62.5938 194,62.5938 L204,62.5938 " fill="none" style="stroke:#454645;stroke-width:1"/><path d="M70,243.707 L80,243.707 C95,243.707 95,62.5938 110,62.5938 L120,62.5938 " fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="85.1875" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="34" x="120" y="125.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="148.1826">&#38656;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="164.4795">&#27714;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="180.7764">&#20998;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="197.0732">&#26512;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="90" x="204" y="149.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70" x="214" y="172.6279">&#36164;&#28304;&#19982;&#35282;&#33394;</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="104" x="344" y="149.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="84" x="354" y="172.6279">&#32487;&#25215;&#65292;&#39063;&#31890;&#24230;</text><path d="M294,167.7813 L304,167.7813 C319,167.7813 319,167.7813 334,167.7813 L344,167.7813 " fill="none" style="stroke:#454645;stroke-width:1"/><path d="M154,167.7813 L164,167.7813 C179,167.7813 179,167.7813 194,167.7813 L204,167.7813 " fill="none" style="stroke:#454645;stroke-width:1"/><path d="M70,243.707 L80,243.707 C95,243.707 95,167.7813 110,167.7813 L120,167.7813 " fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="85.1875" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="34" x="120" y="294.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="317.0732">&#26435;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="333.3701">&#38480;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="349.667">&#31574;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="130" y="365.9639">&#30053;</text><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="129" x="204" y="225.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="214" y="248.9248">&#25805;&#20316;&#26435;&#38480;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109" x="214" y="265.2217">(&#36820;&#22238;Boolean&#20540;)</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="132" x="383" y="205.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="393" y="228.9248">&#38750;&#23884;&#22871;RBAC/ACL</text><path d="M333,252.2266 L343,252.2266 C358,252.2266 358,224.0781 373,224.0781 L383,224.0781 " fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="90" x="383" y="262.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70" x="393" y="285.2217">&#23884;&#22871;&#30340;&#26435;&#38480;</text><rect fill="#90EE90" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="129" x="523" y="262.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109" x="533" y="285.2217">&#8730; &#23613;&#21487;&#33021;&#36716;&#20026;ACL</text><path d="M473,280.375 L483,280.375 C498,280.375 498,280.375 513,280.375 L523,280.375 " fill="none" style="stroke:#454645;stroke-width:1"/><path d="M333,252.2266 L343,252.2266 C358,252.2266 358,280.375 373,280.375 L383,280.375 " fill="none" style="stroke:#454645;stroke-width:1"/><path d="M154,336.6719 L164,336.6719 C179,336.6719 179,252.2266 194,252.2266 L204,252.2266 " fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="128" x="204" y="366.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="214" y="389.667">SQL&#25968;&#25454;&#26435;&#38480;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="108" x="214" y="405.9639">(&#36820;&#22238;&#36807;&#28388;&#30340;&#25968;&#25454;)</text><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="253" x="382" y="318.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="233" x="392" y="341.5186">&#20363;&#65306;&#21482;&#20801;&#35768;A&#29992;&#25143;&#26597;&#30475;&#33258;&#24049;&#37096;&#38376;&#30340;&#25968;&#25454;</text><path d="M332,392.9688 L342,392.9688 C357,392.9688 357,336.6719 372,336.6719 L382,336.6719 " fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#90EE90" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="103" x="382" y="374.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="392" y="397.8154">&#8730; &#32431;&#32534;&#30721;&#26041;&#26696;</text><path d="M332,392.9688 L342,392.9688 C357,392.9688 357,392.9688 372,392.9688 L382,392.9688 " fill="none" style="stroke:#454645;stroke-width:1"/><rect fill="#90EE90" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="103" x="382" y="431.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="392" y="454.1123">&#8730; &#20302;&#20195;&#30721;&#26041;&#26696;</text><path d="M332,392.9688 L342,392.9688 C357,392.9688 357,449.2656 372,449.2656 L382,449.2656 " fill="none" style="stroke:#454645;stroke-width:1"/><path d="M154,336.6719 L164,336.6719 C179,336.6719 179,392.9688 194,392.9688 L204,392.9688 " fill="none" style="stroke:#454645;stroke-width:1"/><path d="M70,243.707 L80,243.707 C95,243.707 95,336.6719 110,336.6719 L120,336.6719 " fill="none" style="stroke:#454645;stroke-width:1"/></g></svg><p>本文虽然介绍OPA框架，但是后续把它给<strong>否决了</strong></p><ul><li>慎用规则引擎与DSL，因为大规模开发下的门槛太高。</li><li>慎用云原生，很多都只是销售术语，技术上并没有突破。</li></ul><hr><h2>背景</h2><h4>术语</h4><p>在设计权限前，而是要明确各种概念与术语，本文定义如下</p><table><thead><tr><th>术语</th><th>定义</th></tr></thead><tbody><tr><td>User/SecurityPrincipal/token/Group/Team</td><td>用户/机器人/凭证等实体或者集合，可以从LDAP等第三方系统获得的镜像数据。类似NAC（网络准入控制）</td></tr><tr><td>Tenant/Namespace/Org/<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/governance/management-groups/overview">management groups</a>/VDC</td><td>含继承关系的租户实体，拥有各自的资源<strong>配额</strong>，一般不会过于干涉到具体的数据权限</td></tr><tr><td>Resource</td><td>资源实体，比如代码仓库/EC2机器的操作/数据权限等</td></tr><tr><td>ResourceGroup/project</td><td>资源组实体的合集，甚至可以包含权限管理的操作，但是不能嵌套</td></tr><tr><td>Capacity/Rule-unit/Action/Permission</td><td>动作+资源的组合的定义，比如 <code>read-report</code> 表示能读取报告</td></tr><tr><td>Policy/statement/Role</td><td>租户在某个Scope下，可以操作的资源合集的实体，比如<code>create-member</code>，大部分用户只能分清“admin/member/readonly”三种角色</td></tr><tr><td>Subscription</td><td>租户成员来创建/订阅的资源关系，非计费场景用不上</td></tr><tr><td>Authentication</td><td>证明你是你(AuthN/IDaaS/LDAP)，比如Auth0/onelogin/forgerock等IAM，本文不涉及</td></tr></tbody></table><p>权限的难点在于</p><ul><li>设计权限要<strong>遍历枚举</strong>所有动作，根据安全要求，在高阶设计阶段就需要尽可能地枚举威胁并加固</li><li>组织间存在<code>继承-覆盖关系</code>与<code>颗粒度</code>两个维度，是三个多对多的关系</li><li>设计师会在低代码与强业务间反复纠结</li></ul><h4>安全理论</h4><p>权限本质是安全，安全中最重要的有两个特点</p><ul><li>机密性：参考BLP模型，比如防泄密，遵循GDPR等</li><li>完整性：参考Biba 模型，比如防止低权限设备提权</li></ul><p>在安全领域中，由美国国防部发布的TCSEC的等级模型最为有名。关于“权限”，主要涉及到</p><ul><li>C2：普通的RBAC</li><li>B1：嵌套权限，即包含Scope的概念</li><li>B2：每一个对象都要标签的等级，比如只有高管A才能访问机密数据B。</li></ul><p>常见项目做到C2就够了，SaaS项目至少需要做到B1，而大数据项目需要尽可能做到B2。</p><h4>权限设计高阶思路</h4><p>在大规模、多租户的权限场景中，高阶设计如下</p><ul><li>组织：从组织架构推导出人员、组织、继承、SOD等关系，避免先入为主的扁平化/低颗粒度，避免双重汇报的组织架构</li><li>资源：一定先枚举所有资源，这是SE的设计门槛（threshold），最好是flatten，而不要出现树形关系。</li><li>角色/权限：建议参考AWS/Azure等树形权限设计</li></ul><h1>权限设计思路</h1><p>本文中，按照“可以复用”，“必须开发”与“有改进潜能”三个维度进行设计评估</p><h2>可复用的组件库</h2><p>下面数据在任何项目都反复使用，这些都是upsert的工作量，不再赘述。需要注意隐私法规。</p><p>以下为管理组侧</p><table><thead><tr><th>数据</th><th>来源</th><th>功能</th></tr></thead><tbody><tr><td>用户贴源层</td><td>第三方IAM Provider系统(SAML/LDAP等)</td><td>证明你是你</td></tr><tr><td>群组贴源层</td><td>第三方IAM Provider系统(SAML/LDAP/Directory等)</td><td>证明你在某个集合中</td></tr><tr><td>SecurityPrincipal</td><td>上述用户与组的贴源数据的并集去重，可以加入额外属性</td><td>使用侧的缓存</td></tr></tbody></table><p>注意这里的群组均不涉及到角色（role）和范围（scope），而只是单纯的数组。同时需要做好数据防篡改，防止关键群组被提权。</p><blockquote><p>关于扩展属性，简单场景可以用数据库的jsonb/字典表/大宽表，复杂场景可以缓存到Redis/ELK/Clickhouse等广义的列存储中提高性能</p></blockquote><p>以下为资源组侧，可以通过菜单、数据源连接，贴源/细节层过滤，API网关，Connector等抽象方案实现，数据管理也可以参考HW的<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/usermanual-dgc/dgc_01_1001.html">数据湖</a>治理方案。</p><table><thead><tr><th>操作资源</th><th>来源</th><th>功能</th><th>媒介</th></tr></thead><tbody><tr><td>Action</td><td>业务菜单/操作权限</td><td>对资源进行的读写删操作</td><td>HTTP/GraphQL网关</td></tr><tr><td>DataAction</td><td>SQL等语句，含Where条件的参数</td><td>查询数据对应的视图</td><td>DB/BI网关</td></tr><tr><td>Condition</td><td>通过注解/扩展字段等方式录入表达式</td><td>供ABAC使用的属性</td><td>手动/第三方录入</td></tr></tbody></table><blockquote><p>一定先要做好功能（比如菜单）和数据（比如过滤参数）的防遗漏，比如MECE的枚举方法，然后再考虑导入相关人员角色与Mapping设计。</p></blockquote><h2>必须开发的业务代码</h2><p>以下的工作量由于边界/颗粒度难以被公共处理，基本上要自己开发</p><ul><li>组织架构的继承关系和颗粒度，比如多层嵌套组织，多层嵌套资源（项目）</li></ul><blockquote><p>网上也有一些SpringBoot的开箱即用的RBAC项目，这种黑盒的后期债务很重，一般来说是不推荐的。</p></blockquote><h2>有改进潜能</h2><p>以下的工作量涉及到角色（Role）或者属性，可以通过逻辑等价的方案来提速</p><ul><li>调用侧和被调用侧的权限判断：通过引入策略引擎，导入tries/graph/DFA(比如AntPathMatcher)并编译与遍历，最终计算真值表</li></ul><h2>声明式权限设计的不足</h2><p>在上述的可以复用的组件开发完成后，我们到了最核心的策略匹配，本文暂时选型OPA(rego)为例。</p><p>在传统的数据库判断权限中，底层是操作多条数组进行翻转90度的交叉运算。那么是否有一种数据结构，能更简化地描述这些细节呢？答案是有向图（以及它的退化Tries，甚至更退化的DFA）。</p><p>举例如下，假如需要实现如下的ABAC场景</p><blockquote><p>部门需要开发一套可视化平台，要求如下：</p><ol><li>如果用户是高级别领导，那么可以看到全部级别数据；如果用户是部门领导，那么只能看到自己部门的数据；如果用户是普通员工，只能看到自己项目的数据</li><li>所有人的权限级别要高于数据的秘密级别</li></ol></blockquote><p>经验上的流程图如下</p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="296px" preserveAspectRatio="none" style="width:527px;height:296px;background:#fff" version="1.1" viewBox="0 0 527 296" width="527px" zoomAndPan="magnify" class="kroki">$2<defs/><g><ellipse cx="375.375" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222;stroke-width:1"/><polygon fill="#F1F1F1" points="309.375,50,441.375,50,453.375,62,441.375,74,309.375,74,297.375,62,309.375,50" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="132" x="309.375" y="65.8081">&#29992;&#25143;&#26435;&#38480;&#27604;&#25968;&#25454;&#31192;&#23494;&#32423;&#21035;&#39640;</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="21" x="276.375" y="59.4058">Yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="15" x="453.375" y="59.4058">No</text><polygon fill="#F1F1F1" points="198.25,84,270.25,84,282.25,96,270.25,108,198.25,108,186.25,96,198.25,84" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="72" x="198.25" y="99.8081">&#29992;&#25143;&#26435;&#38480;&#32423;&#21035;?</text><rect fill="#90EE90" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="35" x="11" y="143.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="15" x="21" y="164.748">ok</text><polygon fill="#F1F1F1" points="130,143.6094,218,143.6094,230,155.6094,218,167.6094,130,167.6094,118,155.6094,130,143.6094" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="88" x="130" y="159.4175">&#26159;&#33258;&#24049;&#37096;&#38376;&#30340;&#25968;&#25454;</text><rect fill="#90EE90" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="35" x="90.5" y="177.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="15" x="100.5" y="198.748">ok</text><rect fill="#FFC0CB" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="38" x="221" y="177.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="18" x="231" y="198.748">fail</text><polygon fill="#F1F1F1" points="338.5,143.6094,426.5,143.6094,438.5,155.6094,426.5,167.6094,338.5,167.6094,326.5,155.6094,338.5,143.6094" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="88" x="338.5" y="159.4175">&#26159;&#33258;&#24049;&#39033;&#30446;&#30340;&#25968;&#25454;</text><rect fill="#90EE90" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="35" x="299" y="177.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="15" x="309" y="198.748">ok</text><rect fill="#FFC0CB" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="38" x="429.5" y="177.6094"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="18" x="439.5" y="198.748">fail</text><polygon fill="#F1F1F1" points="234.25,221.5781,234.25,221.5781,246.25,233.5781,234.25,245.5781,234.25,245.5781,222.25,233.5781,234.25,221.5781" style="stroke:#181818;stroke-width:.5"/><ellipse cx="234.25" cy="275.5781" fill="none" rx="10" ry="10" style="stroke:#222;stroke-width:1.5"/><line style="stroke:#222;stroke-width:2.5" x1="228.0628" x2="240.4372" y1="269.3909" y2="281.7653"/><line style="stroke:#222;stroke-width:2.5" x1="240.4372" x2="228.0628" y1="269.3909" y2="281.7653"/><rect fill="#FFC0CB" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="38" x="478.375" y="84"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="18" x="488.375" y="105.1387">fail</text><line style="stroke:#454645;stroke-width:1" x1="118" x2="108" y1="155.6094" y2="155.6094"/><line style="stroke:#454645;stroke-width:1" x1="108" x2="108" y1="155.6094" y2="177.6094"/><polygon fill="#454645" points="104,167.6094,108,177.6094,112,167.6094,108,171.6094" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="230" x2="240" y1="155.6094" y2="155.6094"/><line style="stroke:#454645;stroke-width:1" x1="240" x2="240" y1="155.6094" y2="177.6094"/><polygon fill="#454645" points="236,167.6094,240,177.6094,244,167.6094,240,171.6094" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="108" x2="108" y1="211.5781" y2="216.5781"/><line style="stroke:#454645;stroke-width:1" x1="108" x2="174" y1="216.5781" y2="216.5781"/><line style="stroke:#454645;stroke-width:1" x1="174" x2="174" y1="216.5781" y2="233.5781"/><polygon fill="#454645" points="170,223.5781,174,233.5781,178,223.5781,174,227.5781" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="326.5" x2="316.5" y1="155.6094" y2="155.6094"/><line style="stroke:#454645;stroke-width:1" x1="316.5" x2="316.5" y1="155.6094" y2="177.6094"/><polygon fill="#454645" points="312.5,167.6094,316.5,177.6094,320.5,167.6094,316.5,171.6094" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="438.5" x2="448.5" y1="155.6094" y2="155.6094"/><line style="stroke:#454645;stroke-width:1" x1="448.5" x2="448.5" y1="155.6094" y2="177.6094"/><polygon fill="#454645" points="444.5,167.6094,448.5,177.6094,452.5,167.6094,448.5,171.6094" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="316.5" x2="316.5" y1="211.5781" y2="233.5781"/><line style="stroke:#454645;stroke-width:1" x1="316.5" x2="246.25" y1="233.5781" y2="233.5781"/><polygon fill="#454645" points="256.25,229.5781,246.25,233.5781,256.25,237.5781,252.25,233.5781" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="186.25" x2="28.5" y1="96" y2="96"/><line style="stroke:#454645;stroke-width:1" x1="28.5" x2="28.5" y1="96" y2="143.6094"/><polygon fill="#454645" points="24.5,133.6094,28.5,143.6094,32.5,133.6094,28.5,137.6094" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="44" x="32.5" y="123.6128">&#39640;&#32423;&#39046;&#23548;</text><line style="stroke:#454645;stroke-width:1" x1="282.25" x2="382.5" y1="96" y2="96"/><line style="stroke:#454645;stroke-width:1" x1="382.5" x2="382.5" y1="96" y2="143.6094"/><polygon fill="#454645" points="378.5,133.6094,382.5,143.6094,386.5,133.6094,382.5,137.6094" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="44" x="386.5" y="123.6128">&#26222;&#36890;&#21592;&#24037;</text><line style="stroke:#454645;stroke-width:1" x1="174" x2="174" y1="96" y2="143.6094"/><polygon fill="#454645" points="170,133.6094,174,143.6094,178,133.6094,174,137.6094" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="44" x="178" y="118.6128">&#37096;&#38376;&#39046;&#23548;</text><line style="stroke:#454645;stroke-width:1" x1="28.5" x2="28.5" y1="177.5781" y2="233.5781"/><line style="stroke:#454645;stroke-width:1" x1="28.5" x2="222.25" y1="233.5781" y2="233.5781"/><polygon fill="#454645" points="212.25,229.5781,222.25,233.5781,212.25,237.5781,216.25,233.5781" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="234.25" x2="234.25" y1="245.5781" y2="265.5781"/><polygon fill="#454645" points="230.25,255.5781,234.25,265.5781,238.25,255.5781,234.25,259.5781" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="297.375" x2="234.25" y1="62" y2="62"/><line style="stroke:#454645;stroke-width:1" x1="234.25" x2="234.25" y1="62" y2="84"/><polygon fill="#454645" points="230.25,74,234.25,84,238.25,74,234.25,78" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="453.375" x2="497.375" y1="62" y2="62"/><line style="stroke:#454645;stroke-width:1" x1="497.375" x2="497.375" y1="62" y2="84"/><polygon fill="#454645" points="493.375,74,497.375,84,501.375,74,497.375,78" style="stroke:#454645;stroke-width:1"/><line style="stroke:#454645;stroke-width:1" x1="375.375" x2="375.375" y1="30" y2="50"/><polygon fill="#454645" points="371.375,40,375.375,50,379.375,40,375.375,44" style="stroke:#454645;stroke-width:1"/></g></svg><p>如下是用传统过程式的代码实现，符合Java等语言的编程习惯</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命题： A&amp;((B-&gt;G)|(C&amp;F)-&gt;G)|(D&amp;E)-&gt;G))</span></span><br><span class="line">function test(<span class="title class_">User</span> input)&#123;</span><br><span class="line">  <span class="keyword">if</span>(input.access_level &lt; input.query.param.access_level)&#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (input.access_level &gt;= <span class="number">50</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (input.access_level &lt; <span class="number">50</span> &amp;&amp; input.access_level &gt;=<span class="number">40</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> input.dept == input.query.param.dept;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (input.access_level &lt; <span class="number">40</span> &amp;&amp; input.access_level &gt;=<span class="number">30</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> input.projects.contains(input.query.param.project);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们将其转换为逻辑命题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">命题：</span><br><span class="line">A: 用户权限比数据秘密级别高</span><br><span class="line">B: 用户是高级领导</span><br><span class="line">C: 用户是部门领导</span><br><span class="line">D: 用户是普通员工</span><br><span class="line">E: 用户在看自己部门的数据</span><br><span class="line">F: 用户在看自己项目的数据</span><br><span class="line">G: 用户可以访问数据</span><br></pre></td></tr></table></figure><p>如下是OPA(rego)的实现，它是形式逻辑。由于不推荐if语句，因此产生了重复的语句</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命题：((A&amp;B)-&gt;G)|((A&amp;C&amp;F)-&gt;G)|((A&amp;D&amp;E)-&gt;G)</span></span><br><span class="line">default allow = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 如果满足A与B，那么G命题成立</span></span><br><span class="line">allow &#123;</span><br><span class="line">  input.access_level &gt;= input.query.param.access_level</span><br><span class="line">  input.access_level &gt;= <span class="number">50</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">  input.access_level &gt;= input.query.param.access_level</span><br><span class="line">  input.access_level &gt;= <span class="number">40</span></span><br><span class="line">  input.access_level &lt; <span class="number">50</span></span><br><span class="line">  input.dept == input.query.param.dept</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allow &#123;</span><br><span class="line">  input.access_level &gt;= input.query.param.access_level</span><br><span class="line">  input.access_level &gt;= <span class="number">30</span></span><br><span class="line">  input.access_level &lt; <span class="number">40</span></span><br><span class="line">  input.query.param.project == input.projects[_]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>完整Demo与用例在这里 <a target="_blank" rel="noopener" href="https://play.openpolicyagent.org/p/WFbjph2KyY">https://play.openpolicyagent.org/p/WFbjph2KyY</a> ，本部分的access_level仅供演示设计</p></blockquote><p>无论是Drools/Casbin/OPA，它们本质上都是通过维护rules描述出了一个Trie (Prefix Tree)的数据结构，通过遍历所有的分支，找出第一个返回为true的最短路径（Boolean interceptor），特点如下</p><ul><li>对“蕴含（即时间序列）”的的支持较差：只有数据结构，没有算法</li><li>对“优先级”的支持较差，比如硬编码场景下的CPU分支预测</li><li>难以枚举：无法拥有值，而是拥有“计算的潜力”，是否拥有权限只有运行时才得知</li></ul><p>通过上面的例子，我们可以看出声明语言的门槛：<strong>你需要手写遍历所有tries的可能性</strong>，尤其是公共分支可能需要手动复制多次。当然这里并不用担心性能，引擎也会像EDA一样“综合编译优化”你的规则，并抽取合并为统一的电路。但是当前即使在芯片中也在推广&quot;低效&quot;的Chisel而不是Verilog，恰恰说明了声明语言的高门槛。</p><blockquote><p>上述的例子尽管从结果上可以看出两种命题是等价的，但是严格的形式证明可以参考《逻辑学导论》中的逻辑等价，或者笛卡尔积相关知识。这种编程风格的门槛非常高。</p></blockquote><h1>数据治理场景的权限(row-level filter)</h1><p>数据主题指对where条件的限制，即Context based row-level filter，比如用户只能看到自己所在部门的数据，这种场景主要在数据治理与BI分析中非常常见。注意这里的filter指代where条件的过滤项。</p><p>大部分权限处理如下：</p><ul><li>数据源的权限处理：需要对数据主题进行贴源，聚合，资产化，定级（比如内部公开，秘密，机密等），脱敏，GDPR等加工。敏感的数据不入库，降低权限开发负担。</li><li>机-机接口（IT租户）的权限：比如数据库表/视图、API-Token授权、消息队列对某个租户开放</li><li>业务级别权限：比如”员工只能看到自己部门的权限“，需要定制</li></ul><p>非业务诉求如下：</p><ul><li>需要尽可能提高开发效率，而不是天天写Controller</li></ul><p>这类场景做到最后，就一定会演化到大数据场景，可以参考Huawei的<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/dgc/index.html">数据湖治理中心</a>服务，或者参考retool的低代码方案。</p><p>其实上述的定制成本均比较高，如果追求快而去愿意掏钱的话，个人更建议</p><ul><li>假如项目定位是度量或者报表，那么就是典型的大数据项目，问题在大数据建模上</li><li>数据录入与处理：购买DGC/Redshift等数据治理服务、ROMA等data Pipeline服务</li><li>数据展示侧：掏钱使用BI软件或者云服务，比如<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/intl/zh-cn/usermanual-dlv/dlv_01_0202.html">DLV</a>等low-code方案。</li></ul><p>如果自己有足够的时间又想用免费的组件，参考如下</p><ul><li>将Context嵌入业务强相关逻辑中，并在SQL/ORM侧的<strong>模版引擎</strong>来改写SQL(rewritten SQL Query)</li><li>甚至Mybatis的LanguageDriver/插件进行SQL定制，下游集成phoenix等聚合JDBC</li><li>参考redash的<a target="_blank" rel="noopener" href="https://github.com/getredash/redash/issues/3284">讨论</a>，替换redash内置的jinja模版引擎升级为高级语言/rego，最终实现ABAC的过滤方案，但是它没有预编译能力，可能有注入或者性能问题</li></ul><h1>其他功能</h1><p>如下要求是纯工程问题，可以自行决策是否使用</p><h2>三权分立的策略管理界面(Zero-trust)</h2><p>当你的SaaS项目中存在了很多重要数据时，如何让客户信任你呢？</p><p>当然是需要满足SOD(separation of duty，权限职责分离)与自举管理。比如下面是常见的三权分立</p><table><thead><tr><th>角色</th><th>查看业务数据</th><th>IT日常维护</th><th>安全管理与审计</th></tr></thead><tbody><tr><td>业务部门(租户)</td><td>Y</td><td>N</td><td>N</td></tr><tr><td>IT维护人员</td><td>N</td><td>Y</td><td>N</td></tr><tr><td>安全内控部</td><td>N</td><td>N</td><td>Y*</td></tr></tbody></table><p>上面的需求本质是“权限的权限”，或者“policy ownership”，总体上就是把所有人当贼来防（这个只有大公司/SaaS服务才能这样折腾了），上述有三个问题</p><ul><li>需要预置一些初始化账号，配置限制与审计策略（比如二次验证），防止内控部的人私自提权内盗</li><li>需要实现自举(self-compiling)</li><li>权利与义务对等，用户拥有数据后，也需要承担安全责任主体</li></ul><p>真正要做到安全认证的话，这里还是要请安全团队进行HW渗透测试（即交钱挨打），软件SE很难面面俱到。</p><h2>支持插件化</h2><p>需要实现AOP，比如</p><ul><li>API网关（Traefik/Envoy的middleware）</li><li>代码级别的AOP（比如 Spring Security）</li></ul><h1>总结</h1><h2>三种权限描述方案</h2><table><thead><tr><th>权限关系实现</th><th>解释对象</th><th>代表方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>硬编码真值表</td><td>布尔值</td><td>RBAC数据库</td><td>数组操作；上手简单</td><td>难以处理粒度/属性/覆盖问题</td></tr><tr><td>逻辑等价Logical equivalence</td><td>布尔解释</td><td>规则引擎/有向图/状态机</td><td>形式证明；速度快；属性支持强</td><td>不支持分支/递归；需要逻辑学基础</td></tr><tr><td>实质等价Material equivalence</td><td>目标语言</td><td>Java/自然语言</td><td>符合直觉，堆人天，图灵完备</td><td>代码翻译；上线繁琐；命题歧义</td></tr></tbody></table><p>上述的区别主要就是分析时的“语境”等级，其中低语境的场景下只需要机器去<strong>静态</strong>的执行运算器即可（或者通过定时任务定期生成权限关系），而高语境的场景虽然很强，但是需要“动态解释”工作。三种并没有高低贵贱之分，类似“低功耗嵌入”，“硬件加速卡”与“通用CPU”的关系，开发者需要在人力、时间和规模中进行均衡。</p><blockquote><p>低语境场景是高效且脆弱的，它与高低语境方案是相互对立但同时相互侵蚀的。</p></blockquote><h2>最终方案</h2><p>经过多个技术调研，最终方案如下</p><ul><li>高阶方案：选择基于AntPathMatcher实现类似Azure的IAM的low-code的权限模型，最终全部RBAC合并道ACL中，全部代码只有一个Java文件。只提供一些checkBoolean的无状态接口，因为大部分权限实际开发后发现会和业务的if/where条件耦合。数据权限仍然无法摆脱mybatis或者jinja等模版引擎。</li><li>低代码：谨慎使用低代码（包括但不限于AOP/注解/委任），因为尝试后发现团队中的沟通，测试与重构成本非常高，运维与定位分析成本也很高。</li></ul><p>优点：</p><ul><li>容易枚举，可以从枚举上<strong>证明</strong>框架没问题，单元测试写起来很容易</li><li>代码量低，容易搬迁，交接与重构</li></ul><p>缺点：</p><ul><li>有学习门槛</li><li>不能证明调用方是否遗漏校验</li></ul><h1>附录</h1><h2>策略引擎的选型</h2><p>以下主要为基于<a href="/tags/RuleEngine">规则引擎</a>的方案，假如你接触过Drools，那么理解会比较容易</p><ul><li>开源方案，通过遍历真值表进行验证，这里是形式化逻辑的领域，通过手写tries的AST来形式化判断权限。<ul><li>Casbin：偏学术化，而且它的DSL太烂了，就连Harbor这种级别的用户都只能抄官方demo。希望作者的胶水语言在设计当初应该参考下Jinja、Groovy等成熟设计。</li><li><a target="_blank" rel="noopener" href="https://www.openpolicyagent.org/">Open Policy Agent</a> (OPA)：来自云原生项目且已毕业，通过实时执行rego策略代码（会优化为WASM代码），判断是否有权限，更多可以参考<a target="_blank" rel="noopener" href="https://zhengyinyong.com/post/policy-dsl/">这篇文章</a>。或者直接看<a target="_blank" rel="noopener" href="https://www.openpolicyagent.org/docs/latest/comparison-to-other-systems/">Demo介绍</a>即可。<ul><li>性能：可以扛得住Kafka级别QPS，2000条规则只需要0.02ms，甚至还有OPAL的壳可以对接数据源</li><li>生态(Adopter)：GitOps/K8S等<a target="_blank" rel="noopener" href="https://github.com/open-policy-agent/opa/blob/main/ADOPTERS.md">云应用</a>，但是没有太多业务级的线上场景</li><li>规则能力：对if嵌套逻辑的都不是很好，难以断点调试，也很反直觉。</li><li>缺少开源二次封装（比如GUI/管理编辑界面）与生产实践（比如版本自动发布）</li></ul></li><li>Serverless/Drools/ <a target="_blank" rel="noopener" href="https://www.cloudflare.com/products/cloudflare-workers/">Cloudflare Worker</a>: 可以将上述的编译产物扔到边缘计算中</li><li>AntPathMatcher：Spring自带的工具，可以参考Artifactory开源的PermissonTarget权限模型，被采用。</li></ul></li><li>收费/闭源产品<ul><li>HashiCorp Sentinel: 是proprietary and closed source，设计与文档都很优雅，但是没有API，rules与js代码差不多，仅供参考思路</li><li>Retool: 是我目前见到的最完美的low-code（基于js实现） + 权限方案，既有admin级别，也有项目级别，项目内部有ACL与ABAC，不提供rules，毕竟是YC毕业的收费项目。假如你的项目可以用它的low-code完成，可以把应用本体开发工作量也算进去</li><li><a target="_blank" rel="noopener" href="https://www.ory.sh/">ory</a>的keto ：一款一站式权限方案，当前后台与API均开源，而前台为SaaS提供。用一种DSL来描述图的关系，实现了<a target="_blank" rel="noopener" href="https://research.google/pubs/pub48190/">谷歌论文</a>中图的遍历算法，比OPA的tries树遍历更强大。当前属于创业与重构阶段，可能无法生产使用。</li><li>另外可以参考美团的这篇<a target="_blank" rel="noopener" href="https://tech.meituan.com/2017/06/09/maze-framework.html">自研规则引擎</a>的文章。</li></ul></li></ul><h2>知名软件项目选型一览</h2><h4>云项目设计</h4><p>下图是参考Azure云服务术语反推出的ER逻辑图</p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="899px" preserveAspectRatio="none" style="width:784px;height:899px;background:#fff" version="1.1" viewBox="0 0 784 899" width="784px" zoomAndPan="magnify" class="kroki">$2<defs/><g><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="540" x="5" y="16.1387">An error has occured : java.lang.NoClassDefFoundError: sun/font/GlyphLayout$GVData</text><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="195" x="5" y="30.1074">What the hell is Project Elrond?</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="5" y="44.0762">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="256" x="5" y="58.0449">Diagram size: 83 lines / 1622 characters.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="5" y="72.0137">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="374" x="5" y="85.9824">PlantUML (1.2023.6) cannot parse result from dot/GraphViz.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="5" y="99.9512">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="492" x="5" y="113.9199">Please go to https://plantuml.com/graphviz-dot to check your GraphViz version.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="5" y="127.8887">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="110" x="5" y="141.8574">Java Runtime: null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="113" x="5" y="155.8262">JVM: Substrate VM</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="150" x="5" y="169.7949">Default Encoding: UTF-8</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="92" x="5" y="183.7637">Language: null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="78" x="5" y="197.7324">Country: null</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="5" y="211.7012">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="172" x="5" y="225.6699">PLANTUML_LIMIT_SIZE: 4096</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="5" y="239.6387">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="150" x="5" y="253.6074">This may be caused by :</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="120" x="9" y="267.5762">- a bug in PlantUML</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="144" x="9" y="281.5449">- a problem in GraphViz</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="5" y="295.5137">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="300" x="5" y="309.4824">You should send this diagram and this image to</text><text fill="#000000" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="145" x="309" y="309.4824">plantuml@gmail.com</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="13" x="458" y="309.4824">or</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="45" x="5" y="323.4512">post to</text><text fill="#000000" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="168" x="54" y="323.4512">https://plantuml.com/qa</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="117" x="226" y="323.4512">to solve this issue.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="400" x="5" y="337.4199">You can try to turn around this issue by simplifing your diagram.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="5" y="351.3887">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="395" x="5" y="365.3574">java.lang.NoClassDefFoundError: sun/font/GlyphLayout$GVData</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="700" x="13" y="379.3262">org.graalvm.nativeimage.builder/com.oracle.svm.core.jni.functions.JNIFunctions.FindClass(JNIFunctions.java:343)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="491" x="13" y="393.2949">java.desktop@17.0.7/sun.font.SunLayoutEngine.shape(SunLayoutEngine.java)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="518" x="13" y="407.2637">java.desktop@17.0.7/sun.font.SunLayoutEngine.layout(SunLayoutEngine.java:172)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="547" x="13" y="421.2324">java.desktop@17.0.7/sun.font.GlyphLayout$EngineRecord.layout(GlyphLayout.java:669)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="452" x="13" y="435.2012">java.desktop@17.0.7/sun.font.GlyphLayout.layout(GlyphLayout.java:459)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="646" x="13" y="449.1699">java.desktop@17.0.7/sun.font.ExtendedTextSourceLabel.createGV(ExtendedTextSourceLabel.java:329)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="626" x="13" y="463.1387">java.desktop@17.0.7/sun.font.ExtendedTextSourceLabel.getGV(ExtendedTextSourceLabel.java:315)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="719" x="13" y="477.1074">java.desktop@17.0.7/sun.font.ExtendedTextSourceLabel.createLogicalBounds(ExtendedTextSourceLabel.java:225)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="662" x="13" y="491.0762">java.desktop@17.0.7/sun.font.ExtendedTextSourceLabel.getAdvance(ExtendedTextSourceLabel.java:134)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="413" x="13" y="505.0449">java.desktop@17.0.7/java.awt.font.TextLine.init(TextLine.java:281)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="433" x="13" y="519.0137">java.desktop@17.0.7/java.awt.font.TextLine.&lt;init&gt;(TextLine.java:129)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="511" x="13" y="532.9824">java.desktop@17.0.7/java.awt.font.TextLine.fastCreateTextLine(TextLine.java:978)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="469" x="13" y="546.9512">java.desktop@17.0.7/java.awt.font.TextLayout.fastInit(TextLayout.java:611)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="465" x="13" y="560.9199">java.desktop@17.0.7/java.awt.font.TextLayout.&lt;init&gt;(TextLayout.java:392)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="566" x="13" y="574.8887">net.sourceforge.plantuml.klimt.font.UFontContext.createTextLayout(UFontContext.java:53)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="723" x="13" y="588.8574">net.sourceforge.plantuml.klimt.drawing.svg.DriverCenteredCharacterSvg.draw(DriverCenteredCharacterSvg.java:60)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="723" x="13" y="602.8262">net.sourceforge.plantuml.klimt.drawing.svg.DriverCenteredCharacterSvg.draw(DriverCenteredCharacterSvg.java:48)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="570" x="13" y="616.7949">net.sourceforge.plantuml.klimt.drawing.AbstractUGraphic.draw(AbstractUGraphic.java:144)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="549" x="13" y="630.7637">net.sourceforge.plantuml.klimt.shape.CircledCharacter.drawU(CircledCharacter.java:73)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="553" x="13" y="644.7324">net.sourceforge.plantuml.klimt.shape.TextBlockMarged.drawU(TextBlockMarged.java:85)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="471" x="13" y="658.7012">net.sourceforge.plantuml.svek.HeaderLayout.drawU(HeaderLayout.java:99)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="651" x="13" y="672.6699">net.sourceforge.plantuml.svek.image.EntityImageClassHeader.drawU(EntityImageClassHeader.java:244)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="598" x="13" y="686.6387">net.sourceforge.plantuml.svek.image.EntityImageClass.drawInternal(EntityImageClass.java:233)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="559" x="13" y="700.6074">net.sourceforge.plantuml.svek.image.EntityImageClass.drawU(EntityImageClass.java:154)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="433" x="13" y="714.5762">net.sourceforge.plantuml.svek.SvekResult.drawU(SvekResult.java:89)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="410" x="13" y="728.5449">net.atmp.ImageBuilder.writeImageInternal(ImageBuilder.java:306)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="324" x="13" y="742.5137">net.atmp.ImageBuilder.write(ImageBuilder.java:256)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="718" x="13" y="756.4824">net.sourceforge.plantuml.svek.CucaDiagramFileMakerSvek.createFileInternal(CucaDiagramFileMakerSvek.java:130)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="662" x="13" y="770.4512">net.sourceforge.plantuml.svek.CucaDiagramFileMakerSvek.createFile(CucaDiagramFileMakerSvek.java:70)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="438" x="13" y="784.4199">net.atmp.CucaDiagram.exportDiagramInternal(CucaDiagram.java:435)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="623" x="13" y="798.3887">net.sourceforge.plantuml.classdiagram.ClassDiagram.exportDiagramInternal(ClassDiagram.java:84)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="502" x="13" y="812.3574">net.sourceforge.plantuml.UmlDiagram.exportDiagramNow(UmlDiagram.java:142)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="538" x="13" y="826.3262">net.sourceforge.plantuml.AbstractPSystem.exportDiagram(AbstractPSystem.java:198)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="566" x="13" y="840.2949">net.sourceforge.plantuml.SourceStringReader.outputImage(SourceStringReader.java:165)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="398" x="13" y="854.2637">net.sourceforge.plantuml.Pipe.generateDiagram(Pipe.java:103)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="358" x="13" y="868.2324">net.sourceforge.plantuml.Pipe.managePipe(Pipe.java:94)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="360" x="13" y="882.2012">net.sourceforge.plantuml.Run.managePipe(Run.java:357)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="312" x="13" y="896.1699">net.sourceforge.plantuml.Run.main(Run.java:184)</text><image height="20" width="19" x="765" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAUCAYAAABvVQZ0AAAAaUlEQVR4Xu2PywkAIQxE05L997AtRXBd0Ed+eHUfzGGSyYgiP9JUNx3BEqoMDz2l8CBTCMOZQpagPm3I83EZXuUxfVzIUFUmDFVlMpf8TuZZ8zKD3pHlw7IjmaxLK8wZ9xtcMEz/ze6jA/9BaSqaQt1qAAAAAElFTkSuQmCC" y="6"/></g></svg><p>值得注意的是，云项目中最细的粒度一般是服务实例级别（菜单级），而难以细化到实例内部的数据权限。比如你在租户下申请了K8S集群实例，想分给别人用，很难在管理侧细化到具体的namespace/secret等权限，而需要更细的数据权限方案。</p><blockquote><p>同时也要注意，云项目一般过于复杂，尤其Role是三个多对多，需要规则引擎来实现，中小型快餐项目不推荐照搬使用。假如不涉及到费用、库存和限额，一般也没必要设计资源组的概念。</p></blockquote><h4>常见工具链项目</h4><p>以下为应用层项目（均基于数据库软隔离的方案，即Sharded multi-tenant databases ）</p><table><thead><tr><th>平台</th><th>Gitlab</th><th>Sonarqube</th><th>Artifactory</th><th>SVN</th></tr></thead><tbody><tr><td>SecurityPrincipal</td><td>User/Group</td><td>User/Group</td><td>User/Group</td><td>ACL</td></tr><tr><td>Resources</td><td>code</td><td>code</td><td>artifacts</td><td>code</td></tr><tr><td>Top-level-role</td><td>nested RBAC</td><td>RBAC</td><td>ACL</td><td>ACL</td></tr><tr><td>Repo-level-role</td><td>RBAC</td><td>ACL</td><td>ACL</td><td>ACL</td></tr><tr><td>Path priority &amp; Inheritance</td><td>NA</td><td>NA</td><td>deny&gt;allow,shortest first</td><td>longest first</td></tr><tr><td>comment</td><td>总管理员<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/user/permissions.html">可以看到</a>代码</td><td>Mapping关系复杂度为O(N<sup>2</sup>)</td><td>AntPathMatcher存储RawJSON</td><td><a target="_blank" rel="noopener" href="https://www.visualsvn.com/support/topic/00033/">参考</a></td></tr></tbody></table><p>上文场景中的Role中绑定的是<code>SecurityPrincipal</code>，即个人与群组被作为相同的范畴，因此在Sonarqube等工具被看作ACL。</p><blockquote><p>其中Gitlab组织中加入了“角色概念”而不是一个单纯的数组，是失败中的失败，在项目中枚举了50多种，耗费一周后放弃</p></blockquote><h4>常见APM/Low-code/可视化相关项目</h4><table><thead><tr><th>平台</th><th>retool</th><th>Sentry</th><th>Metabase-Paid</th><th>Redash OSS</th></tr></thead><tbody><tr><td>SecurityPrincipal</td><td>User/Group</td><td>User</td><td>User/Group</td><td>User</td></tr><tr><td>Top-level-role</td><td>NA(SaaS)</td><td>RBAC</td><td>RBAC</td><td>ACL</td></tr><tr><td>Project-level-role</td><td>RBAC</td><td>nested ACL(by copy)</td><td>ACL</td><td>ACL</td></tr><tr><td>comment</td><td>相对Sonar多了<a target="_blank" rel="noopener" href="https://docs.retool.com/docs/user-permissions">文件夹</a>的概念</td><td><a target="_blank" rel="noopener" href="https://docs.sentry.io/product/accounts/membership/">固定的</a>策略</td><td>借助了模版引擎精确到ABAC的<a target="_blank" rel="noopener" href="https://www.metabase.com/learn/permissions/data-sandboxing-row-permissions.html">行级别</a>支持</td><td>人均管理员</td></tr></tbody></table><p>常见P层项目</p><table><thead><tr><th>平台</th><th>mgr grp</th><th>res grp</th><th>mgr member</th><th>res member</th><th>评价</th></tr></thead><tbody><tr><td>OpenLDAP+PAM</td><td>root</td><td>ACL</td><td>User,group</td><td>File</td><td>基于chmod实现的Linux HPC</td></tr><tr><td>开源版K8S</td><td>RBAC</td><td>RBAC</td><td>token</td><td>resources</td><td>名义上RBAC，事实上都要大量定制</td></tr><tr><td>AWS_K8S</td><td>RBAC</td><td>ABAC</td><td>user,group, role</td><td>resources</td><td>AWS的万能方案</td></tr><tr><td>Harbor</td><td>RBAC</td><td>FullAccess</td><td>User</td><td>docker镜像</td><td>灵活度很差</td></tr><tr><td>AWS_S3</td><td>RBAC</td><td>ABAC</td><td>User, Group, role</td><td>精确到<a target="_blank" rel="noopener" href="https://aws.amazon.com/jp/blogs/security/writing-iam-policies-grant-access-to-user-specific-folders-in-an-amazon-s3-bucket/">文件夹</a></td><td>AWS的万能方案</td></tr><tr><td>HashiCorp OSS</td><td>ACL</td><td>ACL</td><td>token</td><td><a target="_blank" rel="noopener" href="https://learn.hashicorp.com/collections/nomad/access-control">capabilities</a>的集合</td><td>IaaS场景足够了</td></tr><tr><td>HashiCorp Enterprise</td><td>ACL</td><td>ACL</td><td>token</td><td><a target="_blank" rel="noopener" href="https://www.hashicorp.com/sentinel">sentinel</a></td><td>万能且收费</td></tr></tbody></table><p>上述可以得出一个结论</p><ul><li>不涉及嵌套时，经典的RBAC/ABAC基本足够</li><li>涉及到嵌套，数据查看与过滤时，基于当前用户的属性（Role也算属性）进行管理，即ABAC是更好的方法，实现上可以转化为ACL</li></ul><h4>其它术语</h4><p>权限模型相关术语</p><ul><li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Access_control_list">ACL</a>, <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh/%E4%BB%A5%E8%A7%92%E8%89%B2%E7%82%BA%E5%9F%BA%E7%A4%8E%E7%9A%84%E5%AD%98%E5%8F%96%E6%8E%A7%E5%88%B6">RBAC</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Attribute-based_access_control">ABAC</a></li></ul><p>微软的RBAC文档写的最好，建议参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/">这里</a>后再来阅读本文</p></div><div class="tags"><a class="tag-link" href="/tags/Authz/" rel="tag">Authz</a><a class="tag-link" href="/tags/CNCF/" rel="tag">CNCF</a><a class="tag-link" href="/tags/Open-Policy-Agent/" rel="tag">Open Policy Agent</a><a class="tag-link" href="/tags/RuleEngine/" rel="tag">RuleEngine</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry</a><span>.</span></div></footer></div></body></html>