<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="为了提高软件开发的效率，开源/商业软件的引入也越来越广泛，但是一旦涉及到修改源码，将带来高成本的分支维护问题。本文介绍基于代码、容器、网关等AOP免修改源码的设计方案。"><meta name="keyword" content="PaaS,System Design"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>免修改源码的常见AOP埋点方案</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-102296742-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-102296742-1")</script><meta name="generator" content="Hexo 5.4.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">免修改源码的常见AOP埋点方案</div><div class="date">2021-01-03 / modified at 2023-05-20</div><div class="content"><p>为了提高软件开发的效率，开源/商业软件的引入也越来越广泛，但是一旦涉及到修改源码，将带来高成本的分支维护问题。本文介绍基于代码、容器、网关等AOP免修改源码的设计方案。</p><span id="more"></span><p>常见的免修改源码的切片方案如下</p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="583px" preserveAspectRatio="none" style="width:950px;height:583px;background:#fff" version="1.1" viewBox="0 0 950 583" width="950px" zoomAndPan="magnify" class="kroki">$2<defs/><g><line style="stroke:#454645;stroke-width:1.5" x1="36" x2="36" y1="63.9688" y2="83.9688"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="52" x="10" y="83.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="32" x="20" y="105.1074">Code</text><line style="stroke:#454645;stroke-width:1.5" x1="36" x2="46" y1="156.9063" y2="156.9063"/><rect fill="#F1F1F1" height="47.9375" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="126" x="46" y="132.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="61" x="56" y="154.0762">Hardcode</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="106" x="56" y="168.0449">(Modify required)</text><line style="stroke:#454645;stroke-width:1.5" x1="109" x2="119" y1="212.8594" y2="212.8594"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="97" x="119" y="195.875"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="77" x="129" y="217.0137">Spring&#30340;AOP</text><line style="stroke:#454645;stroke-width:1.5" x1="109" x2="119" y1="261.8281" y2="261.8281"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="128" x="119" y="244.8438"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="108" x="129" y="265.9824">&#20462;&#25913;&#28304;&#30721;&#24182;&#32500;&#25252;&#20998;&#25903;</text><line style="stroke:#454645;stroke-width:1.5" x1="109" x2="119" y1="310.7969" y2="310.7969"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="118" x="119" y="293.8125"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="98" x="129" y="314.9512">OpenTelemetris</text><line style="stroke:#454645;stroke-width:1.5" x1="109" x2="109" y1="180.875" y2="310.7969"/><line style="stroke:#454645;stroke-width:1.5" x1="36" x2="46" y1="359.7656" y2="359.7656"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="58" x="46" y="342.7813"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="38" x="56" y="363.9199">Plugin</text><line style="stroke:#454645;stroke-width:1.5" x1="75" x2="85" y1="408.7344" y2="408.7344"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="189" x="85" y="391.75"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="169" x="95" y="412.8887">Jenkins/Sonarqube&#30340;jar&#25554;&#20214;</text><line style="stroke:#454645;stroke-width:1.5" x1="75" x2="85" y1="457.7031" y2="457.7031"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="110" x="85" y="440.7188"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="90" x="95" y="461.8574">c/go&#20013;&#30340;so&#25554;&#20214;</text><line style="stroke:#454645;stroke-width:1.5" x1="75" x2="85" y1="506.6719" y2="506.6719"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="107" x="85" y="489.6875"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="87" x="95" y="510.8262">py&#20013;&#30340;pypi&#25554;&#20214;</text><line style="stroke:#454645;stroke-width:1.5" x1="75" x2="85" y1="555.6406" y2="555.6406"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="124" x="85" y="538.6563"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="104" x="95" y="559.7949">license&#26381;&#21153;&#22120;&#25554;&#20214;</text><line style="stroke:#454645;stroke-width:1.5" x1="75" x2="75" y1="376.75" y2="555.6406"/><line style="stroke:#454645;stroke-width:1.5" x1="36" x2="36" y1="117.9375" y2="359.7656"/><line style="stroke:#454645;stroke-width:1.5" x1="329.5" x2="329.5" y1="63.9688" y2="83.9688"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="71" x="294" y="83.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="51" x="304" y="105.1074">Runtime</text><line style="stroke:#454645;stroke-width:1.5" x1="329.5" x2="339.5" y1="149.9219" y2="149.9219"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="82" x="339.5" y="132.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="62" x="349.5" y="154.0762">JVM Agent</text><line style="stroke:#454645;stroke-width:1.5" x1="329.5" x2="339.5" y1="198.8906" y2="198.8906"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="97" x="339.5" y="181.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="77" x="349.5" y="203.0449">LD_PRELOAD</text><line style="stroke:#454645;stroke-width:1.5" x1="329.5" x2="329.5" y1="117.9375" y2="198.8906"/><line style="stroke:#454645;stroke-width:1.5" x1="523" x2="523" y1="63.9688" y2="83.9688"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="133" x="456.5" y="83.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="113" x="466.5" y="105.1074">Container SideCar</text><line style="stroke:#454645;stroke-width:1.5" x1="523" x2="533" y1="149.9219" y2="149.9219"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="62" x="533" y="132.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="42" x="543" y="154.0762">Consul</text><line style="stroke:#454645;stroke-width:1.5" x1="523" x2="533" y1="198.8906" y2="198.8906"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="77" x="533" y="181.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="57" x="543" y="203.0449">Logstash</text><line style="stroke:#454645;stroke-width:1.5" x1="523" x2="523" y1="117.9375" y2="198.8906"/><line style="stroke:#454645;stroke-width:1.5" x1="665.5" x2="665.5" y1="63.9688" y2="83.9688"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="71" x="630" y="83.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="51" x="640" y="105.1074">Network</text><line style="stroke:#454645;stroke-width:1.5" x1="665.5" x2="675.5" y1="149.9219" y2="149.9219"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="109" x="675.5" y="132.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="89" x="685.5" y="154.0762">Load Balancer</text><line style="stroke:#454645;stroke-width:1.5" x1="730" x2="740" y1="198.8906" y2="198.8906"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="76" x="740" y="181.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="56" x="750" y="203.0449">Sharding</text><line style="stroke:#454645;stroke-width:1.5" x1="730" x2="740" y1="247.8594" y2="247.8594"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="160" x="740" y="230.875"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="140" x="750" y="252.0137">Round robin and more</text><line style="stroke:#454645;stroke-width:1.5" x1="730" x2="730" y1="166.9063" y2="247.8594"/><line style="stroke:#454645;stroke-width:1.5" x1="665.5" x2="675.5" y1="296.8281" y2="296.8281"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="90" x="675.5" y="279.8438"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="70" x="685.5" y="300.9824">Middleware</text><line style="stroke:#454645;stroke-width:1.5" x1="720.5" x2="730.5" y1="345.7969" y2="345.7969"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="209" x="730.5" y="328.8125"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="189" x="740.5" y="349.9512">Forward Auth(SSO/SAML/LDAP)</text><line style="stroke:#454645;stroke-width:1.5" x1="720.5" x2="730.5" y1="394.7656" y2="394.7656"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="61" x="730.5" y="377.7813"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="41" x="740.5" y="398.9199">Limiter</text><line style="stroke:#454645;stroke-width:1.5" x1="720.5" x2="720.5" y1="313.8125" y2="394.7656"/><line style="stroke:#454645;stroke-width:1.5" x1="665.5" x2="665.5" y1="117.9375" y2="296.8281"/><line style="stroke:#454645;stroke-width:1.5" x1="36" x2="665.5" y1="63.9688" y2="63.9688"/><rect fill="#F1F1F1" height="33.9688" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:1.5" width="45" x="328.25" y="10"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="25" x="338.25" y="31.1387">AOP</text><line style="stroke:#454645;stroke-width:1.5" x1="350.75" x2="350.75" y1="43.9688" y2="63.9688"/></g></svg><p>其中Code方案跳过，其它简要介绍</p><h2>Runtime层</h2><h4>JVM Agent插件</h4><p>假如你的程序老是挂掉，除了分析日志还可以参考Uber的免硬编码的JVM profiler方案，用于监控内存、CPU、FD等问题</p><p><a target="_blank" rel="noopener" href="https://github.com/uber-common/jvm-profiler">https://github.com/uber-common/jvm-profiler</a></p><p>此方案代码量很小，而且相当成熟，你可以拿过来自己编译定制</p><h4>LD_PREDLOAD替换glibc</h4><p>参考此文档 <a target="_blank" rel="noopener" href="https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html</a></p><p>此方案会优先glibc库加载，是高阶且危险方案，可以替换容器中的glibc中的标准函数，比如printf，malloc，exec/execv等。这种方案相当于是二进制级别的AOP，就算是C程序也可以魔改，当然代价就是需要充分测试，否则很容易影响更多功能。</p><p>本方案主要用于安全审计(但是仍然可能绕过)、使用分析、性能分析，APM等，一般还会与ptrace一起使用。如果你对性能等因素要求更高，可以参考这些</p><ul><li>收费项目-<a target="_blank" rel="noopener" href="https://openresty.com/en/xray/">xray</a></li><li>免费项目-<a target="_blank" rel="noopener" href="https://github.com/a2o/snoopy">https://github.com/a2o/snoopy</a></li></ul><p>如果要求没那么高，与可以用alias/PATH等方案进行替换，可以用environment module等方案进行无缝替换。</p><h2>Container SideCar</h2><p>容器的SideCar一般指同时启动两个容器，一个是业务逻辑，另一个用于日志、命名服务、localhost代理等。</p><p>参考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar">https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar</a></p><p>此方案需要运维一套高可用的PaaS，比如Kubernetes或者Nomad，至少10台机器才能回本，因此需要看你的项目是否能够覆盖这些成本。</p><h2>Network</h2><h4>Load Balancer</h4><p>LB层主要用于支持副本的高可用或者扩容，当软件本体不支持高可用部署时，你就要通过下面来实现。这里无论是生产使用，还是面试System Design，都是重点场景</p><p><strong>切片LB</strong></p><p>开源版的Jenkins、Gitlab等项目是不支持横向扩容的，而只能最多做到Binlog一样的复制备份，因此网上的开源方案就比较折腾了。比如阿里云就是将上述组件高度定制，但是代码分支也要自己维护了。</p><p>比较偷懒的方案是基于项目ID等Hash值进行切片，这样就可以一定程度上进行多机使用</p><ul><li>如果使用纯Nginx/Caddy等静态配置，后续再扩容时一定需要停机</li><li>建议加一层metadata进行KV路由的持久化（比如Consul），后续比较方便，这个也是分布式存储的主流方案</li><li>再偷懒可以用子域名，比如pool1，pool2，用Web系统做一个审批流来分配也是可以的</li></ul><p>现实生产要与成本匹配，100%高可用虽然很好，但是它是非常昂贵的方案。常见的IT项目生命周期一般是3年，停机加班只要几天，而开发元数据切片可能要几个月。</p><p><strong>非切片方案</strong></p><p>如果负载均衡后面的应用是无状态的（或者是状态存储到Redis中），那么可以这么搞。</p><h4>Middleware</h4><p>此处重要是用于业务切片，比如用户IAM、登陆（AuthN）、鉴权（AuthZ）、白名单、限流等，网上教程很多，可以参考Treafik的设计。我在真实项目中，就通过Traefik实现了AuthN与AuthZ，给业务系统只提供当前用户的Context，但是这类系统早晚都会在低代码和强业务间犹豫</p><h2>总结</h2><p>如同芯片一样，软件开发后续一定会走向集成化、供应链化、采购化，个人做的工作虽然看似复杂，但是每个人都是可替代的螺丝钉，因此对个人来说，要尽可能提高知识广度。</p></div><div class="tags"><a class="tag-link" href="/tags/PaaS/" rel="tag">PaaS</a><a class="tag-link" href="/tags/System-Design/" rel="tag">System Design</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry</a><span>.</span></div></footer></div></body></html>