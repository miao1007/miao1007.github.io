<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="随着业务的增加，客户对IT系统的前端速度不太满意，希望通过改造提高速度。"><meta name="keyword" content="JavaScript,Maven,Refactor,Web"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>端到端拉通实现Web首屏优化</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://eu.umami.is/script.js" data-website-id="449a84b6-be9e-49de-a4cc-e0fa6fea1df9"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">端到端拉通实现Web首屏优化</div><div class="date no-print">2018-06-13 / modified at 2022-04-04 / 2.4k words / 9 mins</div><div class="content"><blockquote><span>️This article has been <strong>over 3 years</strong> since the last update.</span></blockquote><p>随着业务的增加，客户对IT系统的前端速度不太满意，希望通过改造提高速度。</p><span id="more"></span><blockquote><p>本文场景是内网企业级应用（SQL多，表格多，图片少）的首屏速度加载优化</p></blockquote><h2>1. Backgroud</h2><p>随着项目业务越做越大，前端也越来越臃肿。经过分析，有如下质量问题</p><ul><li>项目本身有历史债务，由于人员变化导致很多没用到的js不敢删了</li><li>由于项目是自有人员带外包的模式，导致js代码质量难以控制</li><li>研发人员以Java后端为主，本次优化不希望提高研发的学习成本</li></ul><h2>2. Requirement</h2><p>目前项目首页速度已经高达5s，希望通过前后端拉通将速度降低到2.5s（含各种复杂的查询）</p><h2>3. Action</h2><p>众所周知，让界面加快无非几种方法</p><ul><li>压缩js/css为单个文件</li><li>开启gzip/缓存</li><li>使用asm.js /Worker 线程</li><li>通过组件化分批按需加载js/html(比如Angular中的component实现企业级SPA应用)</li><li>后端接口的SQL优化/Redis缓存/Sleuth记录等</li></ul><h2>3.1. 压缩JS/CSS</h2><p>虽然网上有很多基于NodeJS的压缩项目，但是我个人更偏好在Java端使用纯maven实现。最终选择了基于谷歌<code>ClosureCompiler</code>的第三方<code>minify-maven-plugin</code>项目</p><h4>从Demo开始学习</h4><p>开源项目的特点就是文档不是很全，需要自己去找Demo或者看源码，毕竟纯情怀做高质量开源是一件吃力的事情，因此</p><p>导入与使用Demo方法</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/samaxes/minify-maven-plugin.git              </span><br><span class="line">git checkout minify-maven-plugin-1.7.6</span><br><span class="line">mvn clean install</span><br><span class="line"><span class="built_in">cd</span> demo</span><br><span class="line">mvn clean package</span><br></pre></td></tr></table></figure><h4>如何给maven plugin 打断点</h4><p>打开IDEA导入刚刚项目，注意demo项目也要导入。</p><p>进入<code>MinifyMojo.java</code>文件，对感兴趣的位置打上断点</p><p>然后点击<code>maven project</code> ，选择<code>Minify Maven Plugin Demo</code>，在生命周期中的<code>package</code>右键选中debug，这时就可以发现断点进入了，读者就可以自行分析代码了。</p><blockquote><p>这个也是快速阅读开源项目的一个技巧，通过断点降低陷入文档的时间</p></blockquote><h4>插件配置</h4><p>maven配置中的所有配置可以参考<code>MinifyMojo</code>这个对象，下面是我的定制</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>minify<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.samaxes.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minify-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">id</span>&gt;</span>bundle-configuration-minify<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">bundleConfiguration</span>&gt;</span>src/minify/static-bundles.json<span class="tag">&lt;/<span class="name">bundleConfiguration</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">jsEngine</span>&gt;</span>CLOSURE<span class="tag">&lt;/<span class="name">jsEngine</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">jsSourceDir</span>&gt;</span>&lt;![CDATA[/]]&gt;<span class="tag">&lt;/<span class="name">jsSourceDir</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">closureCreateSourceMap</span>&gt;</span>true<span class="tag">&lt;/<span class="name">closureCreateSourceMap</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>minify<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure><p>外部json(src/minify/static-bundles.json)配置，注意这个要注意文件的前后依赖性（比如JQuery插件不能优先加载），因此不要使用通配符偷懒</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bundles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;js&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;js/all/static-combined.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;js/samaxesjs.core.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;js/subdir/samaxesjs.toc.js&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>如果你希望手动打包的话，那么可以在Terminal中运行运行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -P minify表示激活了minify的配置，如果你不要压缩，那么可以去掉它以减少打包时间</span></span><br><span class="line">mvn com.samaxes.maven:minify-maven-plugin:1.7.6:minify -P minify</span><br></pre></td></tr></table></figure><p>如果你在IDEA下希望失去焦点后能够自动刷新打包，可以在<code>Maven Projects</code>选项中选择</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Plugins -&gt; minify -&gt; minify:minify(Right Click) -&gt; Execute Before build</span><br></pre></td></tr></table></figure><p>这样你就可以聚焦业务，不用折腾打包流程了。</p><h2>3.2. 降低传输数据量</h2><h3>请求侧：降低Header信息量</h3><h4>降低Cookies的payload</h4><p>由于很多企业级项目的Cookies非常多，而这些Cookies只要是在同一个域名下，浏览器将<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Cookies">始终</a>拼砖发送，因此冗余的Cookies可以考虑干掉，或者切换到<code>x-auth-token</code>这种更安全的实现。</p><h4>为静态文件使用不同的域名</h4><p>当普通的图片与业务均共享使用同一个域名时，浏览器请求图片等资源时也会带上Cookies，Token等Header信息，导致请求Payload耗时变高。此问题除了显性配置<code>set-cookies</code>，还有使用CDN域名规避的方法，举个StackOverflow的例子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">API业务: stackoverflow.com</span><br><span class="line">静态资源: cdn.sstatic.net</span><br></pre></td></tr></table></figure><h3>返回侧：开启Gzip并配置缓存</h3><p>此处有两种方法，一种是配置在Nginx中存放静态文件，还有一种是直接配置tomcat</p><h4>Nginx配置方法</h4><p>这个网上很多了，详见<a target="_blank" rel="noopener" href="https://www.nginx.com/resources/admin-guide/serving-static-content/">serving-static-content</a>。你可以通过查看js返回的Header中是否有<code>Server: Nginx</code>来判断是否生效，一般来说压缩级别配置到5就差不多可以了</p><h4>Tomcat配置方法</h4><p>同样网上很多，可以参考<a target="_blank" rel="noopener" href="https://community.atlassian.com/t5/Confluence-questions/Tomcat-8-Serving-Static-content-extremely-slow/qaq-p/265520">这里</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8575&quot;</span> <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">maxThreads</span>=<span class="string">&quot;200&quot;</span> <span class="attr">minSpareThreads</span>=<span class="string">&quot;10&quot;</span> <span class="attr">compression</span>=<span class="string">&quot;on&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">compressableMimeType</span>=<span class="string">&quot;text/html,text/xml,text/plain,text/css,application/json,application/javascript,image/gif,image/jpg,image/png&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">protocol</span>=<span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">enableLookups</span>=<span class="string">&quot;false&quot;</span> <span class="attr">acceptCount</span>=<span class="string">&quot;10&quot;</span> <span class="attr">debug</span>=<span class="string">&quot;0&quot;</span> <span class="attr">URIEncoding</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>上面两个方法二选一即可，通过开启Gzip可以将文件压缩到1/3甚至1/4</p><h2>3.3. 按需加载</h2><p>按需加载就是客户点进业务详情页面时再去加载html/js，一般常见的单页应用(Single Page Application)均支持按需加载。在本项目中选用了成熟的AngularJS + UI-Router的方案，可以参考<a target="_blank" rel="noopener" href="https://oclazyload.readme.io/">这里</a>。下面讲两个常见问题</p><h4>项目白屏时间变长(400ms)</h4><p>由于浏览器的主线程是单线程，因此只能使用异步API交给Worker线程池来实现多线程加载。但是有些位置是很难优化的，比如UI-Router是依赖于AngularJS，那么必须在AngularJS初始化完成后才能加载</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParseDOM -&gt; AngularJS.inject() -&gt; AngularJS.eval() -&gt; AngularJS.apply() -&gt; UI-Router</span><br></pre></td></tr></table></figure><p>由于其他JS与AngularJS本身需要初始化，因此这里的UI-Router以及需要加载的界面<strong>只有</strong>等待AngularJS初始化完成<strong>才能</strong>进行请求，可以使用Chrome的Performance工具进行分析调优。</p><p>对策如下</p><ul><li>升级支持预编译生成静态网站的框架，比如Angular/React，前提是项目成员学习跟得上</li><li>降低AngularJS双向绑定的对象，移除主页面的冗余依赖注入对象</li><li>使用假CSS实现视觉效果，避免一直白屏</li></ul><h4>如何压缩按需加载的静态文件</h4><p>此需求在网上尚未找到一个全自动的方案，因为JS里的URL是需要替换的，目前正在研究中，目前思路是基于分析<code>$State</code>的AST对象</p><ul><li>分析AST对象自动生成minify需要的json文件，手动维护一下</li><li>分析AST对象将css/js内联到html中</li></ul><h2>3.4. 后端优化</h2><p>后端优化是一个很宽泛的话题，以Tomcat为例，常见的调用栈如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tomcat -&gt; filterChain -&gt; SpringMVC -&gt; Inteceptors -&gt; Controller -&gt; Service(RPC/SQL)</span><br></pre></td></tr></table></figure><p>常见瓶颈如下</p><h4>过滤器(FilterChain, Inteceptors, AOP)</h4><p>此处包括Tomcat中的过滤器，SpringMVC中的拦截器，以及Controller中暗藏的AOP</p><ul><li>假如在Session过滤器中拦截了js的请求，很可能导致下载一个简单的js都需要去请求Redis =&gt; 过滤器不要偷懒使用<code>/</code>进行全局过滤，而只用把RESTful请求过滤即可</li><li>在访问记录等过滤器中使用了插入SQL的方式记录导致阻塞 =&gt; 应该使用MQ替换掉阻塞任务</li><li>至于AOP，我个人认为是一种反模式，如果缺乏自动提示的IDE，还真很难定位出AOP的位置</li></ul><h4>业务优化</h4><p>对于业务处理来说，一般就是查表或者调用微服务</p><ul><li>数据库优化是一个冗长的议题，如果你使用Mybatis，可以参考我写的<a href="/gitbook/mybatis">Gitbook</a>相关文档</li><li>微服务优化一般来说只能优化传输语法层面，比如将JSON换成二进制通信，更多可以使用Sleuth进行分析，可以参考我写的<a href="/gitbook/mybatis">Gitbook</a>中Eureka的相关文档</li><li>对于频繁调用的可以考虑使用Redis/Elastic进行缓存计算结果</li></ul><h2>4. Summary</h2><p>通过上述改造，项目终于又快起来了，说白了优化只是一个苦力活，这里工作应该尽可能包出去。</p><h2>5. 附录</h2><h4>5.1. 如何区分生产环境</h4><p>在本地开发时，一般开发者喜欢分散开的js文件，而上线后需要打包成一个单独的js文件，那么如何实现呢？</p><ul><li>IDEA自动打包</li></ul><p>最简单的操作就是使用上文的方法自动打包，这样就不用区分各种环境，缺点是打包速度比较慢。</p><ul><li>纯前台实现</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">Env</span>.<span class="property">dev</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">println</span>(<span class="string">&#x27;&lt;script src=&quot;&#x27;</span> + <span class="string">&#x27;a.js&#x27;</span> + <span class="string">&#x27;&quot;&lt;\/script&gt;&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">println</span>(<span class="string">&#x27;&lt;script src=&quot;&#x27;</span> + <span class="string">&#x27;b.js&#x27;</span> + <span class="string">&#x27;&quot;&lt;\/script&gt;&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125; <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">println</span>(<span class="string">&#x27;&lt;script src=&quot;&#x27;</span> + <span class="string">&#x27;xxxx.all.min.js&#x27;</span> + <span class="string">&#x27;&quot;&lt;\/script&gt;&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这种方法的缺点就是很丑，但是js速度不会损失（如果是css的话肯定就慢了）</p><ul><li>后端模版引擎实现</li></ul><p>同上，比如将当前的<code>spring.profile.active</code>作为上下文传到前台即可，这样看到渲染后的界面比较赏心悦目</p><h4>5.2. Chrome的Audio工具</h4><p>虽然网上有很多关于前端优化的文档，但是Chrome自带的这个工具已经非常好用了，通过将分数提高即可实现优化。</p></div><div class="tags"><a class="tag-link" href="/tags/JavaScript/" rel="tag">JavaScript</a><a class="tag-link" href="/tags/Maven/" rel="tag">Maven</a><a class="tag-link" href="/tags/Refactor/" rel="tag">Refactor</a><a class="tag-link" href="/tags/Web/" rel="tag">Web</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry.</a><span> All contents are not allowed to be redistributed or synthesised without an explicit permission.</span></div></footer></div></body></html>