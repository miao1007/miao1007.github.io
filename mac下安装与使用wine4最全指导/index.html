<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="Wine/CrossOver最近终于释出了4.0正式版，支持了Vulkan等新功能。作为折腾党，第一时间试用了下Wine4.0在Mac下的表现，愿意折腾的可以试试。"><meta name="keyword" content="Mac,Wine"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Mac下安装与使用Wine4最全指导</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body class="container"><header id="header"><div class="header"><div class="header-left"><div class="author"><div class="author-name"><a href="/">諺</a></div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li style="font-size:.9rem"><a href="/archives" rel="nofollow">zh</a></li><li style="font-size:.9rem"><a href="#" rel="nofollow">|</a></li><li style="font-size:.9rem"><a href="/en" rel="nofollow">en</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">Epistemology</a></li><li><a href="/books" rel="nofollow">読書</a></li></ul></div></div></header><div class="content-wrapper"><div class="post"><section class="article"><div class="title">Mac下安装与使用Wine4最全指导</div><div class="date">2019-01-29に投稿</div><div class="content"><p>Wine/CrossOver最近终于释出了4.0正式版，支持了Vulkan等新功能。作为折腾党，第一时间试用了下Wine4.0在Mac下的表现，愿意折腾的可以试试。</p><span id="more"></span><h2>原理</h2><p>Wine可以看作ELF解释器(Interceptor)，并实现了WindowsAPI(自己手写一套)与DirectX(基于OpenGL)的Runtime，因此可以复用native的性能，而不用虚拟机去执行虚拟指令集。缺点也明显，上手有一定难度（类似于黑苹果的黑箱调试），需要找DLL与改各种配置，并对日志进行定位分析。</p><p>而Wine的商业版CrossOver是在Wine的基础上新增了GUI界面，定制了Wine的二进制，并维护了很多配置文件(比如到底用哪个DLL更好)，相当于花了150去买自动配置好的文件，节约了时间。</p><p>另外还有Gcenx大佬版的基于CrossOver的<a target="_blank" rel="noopener" href="https://www.codeweavers.com/crossover/source">开源代码</a>编译，性能更好 <a target="_blank" rel="noopener" href="https://github.com/Gcenx/homebrew-wine/">https://github.com/Gcenx/homebrew-wine/</a></p><p>此外还有PortingKit/PlayOnMac等方案。它基于wineskin，融合exe与winelib生成一个App，不过它对应的Wine版本一般是落后+稳定，此方案适用于运行游戏，缺点是占空间，配置更新维护没有CrossOver快，因此这些wrapper类的应用均不再介绍。</p><p>上述均不能保证程序全部正常运行，运行不来的还是要靠虚拟机。</p><h2>安装</h2><h4>开源版wine的安装</h4><p>安装过程建议如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 请不要用brew安装，而是直接到官网安装pkg，因为brew更新较慢，而且没有“用Wine打开”这个菜单</span></span><br><span class="line"><span class="comment"># https://dl.winehq.org/wine-builds/macosx/download.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装wine包管理(自动帮你下载与执行注册表)</span></span><br><span class="line"><span class="comment"># 这里有一堆现成的APP </span></span><br><span class="line"><span class="comment"># https://github.com/Winetricks/winetricks/blob/master/files/verbs/all.txt</span></span><br><span class="line">brew install winetricks</span><br></pre></td></tr></table></figure><p>此外可以参考ArchLinux的<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Wine_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">安装过程</a></p><h4>收费版CrossOver的安装</h4><p>直接点击安装即可。</p><h4>公共的配置</h4><p>此部分主要是做对照实验时使用，并防止重装后丢失数据。</p><p>首先CrossOver安装完成后，新建一个<code>/win7-64</code>的容器</p><p>接着将如下代码复制到<code>~/.bashrc</code>中（或者zshrc，取决于你的Shell）</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">wine_common</span></span>()&#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="function"><span class="title">lk_folder</span></span>()&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;link <span class="variable">$1</span> to <span class="variable">$2</span>&quot;</span></span><br><span class="line">    mkdir -p <span class="variable">$1</span></span><br><span class="line">    mkdir -p <span class="variable">$2</span></span><br><span class="line">    ln -sfn <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="variable">$2</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">export</span> WINEARCH=win64</span><br><span class="line">  <span class="built_in">export</span> WINEPREFIX=<span class="variable">$1</span></span><br><span class="line">  mkdir -p <span class="variable">$WINEPREFIX</span></span><br><span class="line">  <span class="comment"># 防止程序信息丢失，直接放在Mac下</span></span><br><span class="line">  v_user=<span class="string">&quot;<span class="variable">$&#123;WINEPREFIX&#125;</span>/drive_c/users/<span class="variable">$3</span>/&quot;</span></span><br><span class="line">  lk_folder <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/Documents/wine/Application Data/&quot;</span> <span class="variable">$v_user</span></span><br><span class="line">  lk_folder <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/Documents/wine/AppData/&quot;</span> <span class="variable">$v_user</span></span><br><span class="line">  lk_folder <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/Documents/wine/Local Settings/&quot;</span> <span class="variable">$v_user</span></span><br><span class="line"></span><br><span class="line">  lk_folder <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/Documents/wine/My Documents/&quot;</span> <span class="variable">$v_user</span></span><br><span class="line">  lk_folder <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/Documents/wine/My Music/&quot;</span> <span class="variable">$v_user</span></span><br><span class="line">  lk_folder <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/Documents/wine/My Pictures/&quot;</span> <span class="variable">$v_user</span></span><br><span class="line">  lk_folder <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/Documents/wine/My Videos/&quot;</span> <span class="variable">$v_user</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># configurate path</span></span><br><span class="line">  <span class="built_in">export</span> PATH=$(<span class="built_in">echo</span> <span class="variable">$PATH</span>|tr <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;\n&#x27;</span>|grep -v wine|grep -v CrossOver|tr <span class="string">&#x27;\n&#x27;</span> <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$2</span></span><br><span class="line">  <span class="comment"># configurate language</span></span><br><span class="line">  <span class="built_in">export</span> LC_ALL=<span class="string">&quot;en_US.UTF-8&quot;</span>;</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$v_user</span></span><br><span class="line">  <span class="comment"># 可以看出收费版的Wine信息输出是不一样的</span></span><br><span class="line">  wine --version</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">switch_wine</span></span>()&#123;</span><br><span class="line">  WINE_BIN=<span class="string">&quot;/Applications/Wine Staging.app/Contents/Resources/wine/bin&quot;</span></span><br><span class="line">  WINEPREFIX=<span class="variable">$HOME</span>/.wine</span><br><span class="line">  wine_common <span class="variable">$&#123;WINEPREFIX&#125;</span> <span class="variable">$&#123;WINE_BIN&#125;</span> <span class="variable">$USER</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">switch_co</span></span>()&#123;</span><br><span class="line">  BOTTLE_NAME=win7-64</span><br><span class="line">  WINE_BIN=<span class="string">&#x27;/Applications/CrossOver.app/Contents/SharedSupport/CrossOver/CrossOver-Hosted Application&#x27;</span></span><br><span class="line">  WINEPREFIX=<span class="string">&quot;<span class="variable">$HOME</span>/Library/Application Support/CrossOver/Bottles/<span class="variable">$BOTTLE_NAME</span>&quot;</span></span><br><span class="line">  Bottles=$(dirname <span class="variable">$&#123;WINEPREFIX&#125;</span>)</span><br><span class="line">  ln -sfn <span class="string">&quot;<span class="variable">$Bottles</span>/<span class="variable">$BOTTLE_NAME</span>&quot;</span> <span class="string">&quot;<span class="variable">$Bottles</span>/default&quot;</span></span><br><span class="line">  v_users=<span class="variable">$&#123;WINEPREFIX&#125;</span>/drive_c/users</span><br><span class="line">  wine_common <span class="variable">$&#123;WINEPREFIX&#125;</span> <span class="variable">$&#123;WINE_BIN&#125;</span> crossover</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">switch_wine</span><br></pre></td></tr></table></figure><p>这样同时安装免费版与商业版的优点是可以随意切换env(商业版与免费版)，而且数据可以共享（大部分配置全部都可以归档到Document下）</p><h2>使用</h2><p>大部分简单的APP可以通过如下使用</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到社区版 switch_wine</span></span><br><span class="line"><span class="comment"># 切换到商业版 switch_co</span></span><br><span class="line">wine xxx.exe</span><br></pre></td></tr></table></figure><h2>For DirectX Game</h2><p>到此为止，大部分非3D游戏应该都可以运行了。但是要强调一下，Mac下渲染默认是基于OpenGL实现的，因此性能与虚拟机也好不到哪去，不要有过高期望。</p><p>我个人不推荐安装这里的任何dll，如果有问题，只能试试看而已。</p><h4>DirectX9</h4><p>虽然Wine已经完整实现并Build in了DirectX9，但是如果有兼容问题，可以考虑如下方案</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DX9, 10+不相互兼容，需要各自下载各自的，以9为例</span></span><br><span class="line"><span class="comment"># 这里有安装完全包(directx9)与DLL的方案，官方更推荐DLL(d3dx9_36)方案</span></span><br><span class="line"><span class="comment"># 我个人更喜欢安装这个</span></span><br><span class="line">winetricks directx9</span><br></pre></td></tr></table></figure><p>如果还是不能运行，那么就只能换DX的版本或者换Wine的版本了</p><p>另外注册表参数<code>CSMT</code>虽然在网上说有用（CrossOver中叫做Performance Enhanced Graphics），但是实际没有较大的提升</p><h4>DirectX10+</h4><p>在Wine中Mac下暂时<a target="_blank" rel="noopener" href="https://www.codeweavers.com/compatibility/crossover/directx-10">没有</a>找到实现，只有部分Hack的博文。原因是在Mac下，DX10通过如下实现 Metal -&gt; MoltenVK -&gt; Vulkan -&gt; DX10。但是目前支持并不完善，所有DX10与Vulkan都没有实现(dxvk)。同时由于Mac本身性能就一般，所以这里就不折腾了。</p><p>而在CrossOver下，商业版支持了部分DX10+的API，但是总体上只可以看成一个Stub，并非完全支持。</p><h4>关于.NetFrameWork</h4><p>net框架是向前兼容的，理论上安装最新的就可以的，但是我个人建议需要哪个就安装哪个，因为winetricks的依赖管理很复杂，不要强求最新的</p><p>一般用Wine自己实现的Net框架<a target="_blank" rel="noopener" href="https://dl.winehq.org/wine/wine-mono/4.7.1/">Mono</a>是最方便的，注意版本号以<a target="_blank" rel="noopener" href="https://source.winehq.org/git/wine.git/blob/refs/tags/wine-4.0:/dlls/appwiz.cpl/addons.c">此文件</a>实时为准</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wine uninstaller --remove <span class="string">&#x27;&#123;E45D8920-A758-4088-B6C6-31DBB276992E&#125;&#x27;</span></span><br><span class="line">wine msiexec /i wine-mono-4.7.５.msi  </span><br></pre></td></tr></table></figure><p>除此之外，还有如下实现方式</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install Net 3.5</span></span><br><span class="line">winetricks dotnet35</span><br></pre></td></tr></table></figure><p>而在CrossOver下会自动帮你安装好mono</p><h2>结论</h2><h4>与虚拟机的对比</h4><p>Wine方案（包括CrossOver）总体来说，在Mac下使用范围还是有限，适合喜欢折腾的用户。因为Mac下非游戏类的软件均有替代方案，甚至比Windows下功能更强；而游戏由于OpenGL先天性能不行导致只是比虚拟机性能略高，但是散热更低（风扇不会太响），可能有渲染错位，FS性能比虚拟机弱（可能是运行时转换DLL导致，需要PreLoader）的问题。当然这些是与付费软件Parallels对比的，有失公平。</p><p>此外还有一点，为了提高易用性，Wine方案安全隔离完全不够，权限与普通用户一致，没有做到Namespace隔离，因此建议<strong>只运行可信来源的软件</strong>。</p><p>因此在目前场景下，Wine比较适合中小型软件/游戏的使用，以及白名单中的应用。最佳方案还是大硬盘+安全虚拟机综合效果更好</p><h4>Wine各个版本的性能对比</h4><p>普通软件使用任何Wrapper均可运行</p><p>游戏此处有点玄学了，目前3与4并拉不开差距，我个人测试如下（均安装了官网DX9）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PortingKit&#x2F;Wine4&#x2F;Wine3(性能强，兼容弱) &gt; CrossOver &gt; Wine</span><br></pre></td></tr></table></figure><p>需要等到Wine4支持Mac下的Meta绘图框架后，性能才会拉开明显的差距</p><h2>其它配置</h2><h4>主题</h4><p>配置主题(底层是WinXP实现)，可选操作，强迫症专用</p><p>建议配置稳定后再安装，具体可以在<a target="_blank" rel="noopener" href="http://nick-zone.com/mac/download.asp">Nick-zone</a>下载</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主题文件夹</span></span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.wine/drive_c/windows/Resources/Themes</span><br><span class="line"><span class="comment"># 下载拷贝到themes目录</span></span><br></pre></td></tr></table></figure><h4>字体</h4><p>解决乱码问题，网上有直接替换user.reg或者system.reg的方案，我个人不推荐，因为这两个可以看作序列化缓存，<a target="_blank" rel="noopener" href="https://wiki.winehq.org/Regedit">不应该</a>手动修改，缺点是没有复用Mac下的字体</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装一堆CJK字体，能用就行</span></span><br><span class="line">winetricks cjkfonts</span><br></pre></td></tr></table></figure><p>接着配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$HOME</span>/.wine</span><br><span class="line">cat &gt; font_settings.reg &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">REGEDIT4</span></span><br><span class="line"><span class="string">[HKEY_CURRENT_USER\Software\Wine\X11 Driver]</span></span><br><span class="line"><span class="string">&quot;ClientSideWithRender&quot;=&quot;N&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># 导入此文件</span></span><br><span class="line">wine regedit font_settings.reg</span><br></pre></td></tr></table></figure><p>如果有乱码问题，可以配置宿主语言或者传递如下变量，不需要LocaleEmulator等工具</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://wiki.winehq.org/Testing_Languages</span></span><br><span class="line"><span class="comment"># ja_JP, en_US</span></span><br><span class="line"><span class="built_in">export</span> LC_ALL=<span class="string">&quot;zh_CN.UTF-8&quot;</span>;</span><br></pre></td></tr></table></figure><h5>卸载Wine</h5><p>详见<a target="_blank" rel="noopener" href="https://wiki.winehq.org/MacOS">此Wiki</a></p><p>如果需要删除缓存</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ~/.cache/winetricks</span><br></pre></td></tr></table></figure><h4>常见报错处理</h4><ul><li>Q: Unhandled exception: page fault on read access</li><li>A: 这种一般是找不到库导致的，有的程序自嵌所有的库，有的必须找Windows</li></ul><ul><li>Q: fixme xxx</li><li>A: 根据调试经验，除了CG渲染，Fixme相关报错一般与主报错关系不大。建议使用二分法定位。</li></ul><ul><li>Q: PresentationFramework, Version=3.0.0.0, Culture</li><li>A: 安装相应的net库</li></ul><ul><li>Q: 如何彻底重装?</li><li>A: 直接<code>rm -rf $&#123;WINEPREFIX&#125;</code>(慎重执行)即可，winetricks下载的缓存在<code>~/.cache/winetricks</code>中，不会重复下载</li></ul><ul><li>Q: 还是无法运行某程序</li><li>A: 尝试下载使用<a target="_blank" rel="noopener" href="https://dl.winehq.org/wine-builds/macosx/pool/">旧版</a>，通过二分法定位</li></ul><h4>其它资源</h4><ul><li>注册表: <a target="_blank" rel="noopener" href="https://wiki.winehq.org/UsefulRegistryKeys">https://wiki.winehq.org/UsefulRegistryKeys</a></li><li>大佬论坛: <a target="_blank" rel="noopener" href="https://www.reddit.com/r/wine_gaming">https://www.reddit.com/r/wine_gaming</a></li></ul></div><div class="tags"><a class="tag-link" href="/tags/Mac/" rel="tag">Mac</a><a class="tag-link" href="/tags/Wine/" rel="tag">Wine</a></div></section><ul class="nav"><li>Prev:<a href="/%E7%A7%8B%E8%91%89%E5%8E%9F%E5%A5%B3%E4%BB%86%E5%92%96%E5%95%A1%E5%8E%85%EF%BC%88%E3%83%A1%E3%82%A4%E3%83%89%E3%82%AB%E3%83%95%E3%82%A7%EF%BC%89%E4%BD%93%E9%AA%8C/">秋葉原女仆咖啡厅（メイドカフェ）体验</a></li><li>Next:<a href="/sonarqube%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/">SonarQube是如何工作的</a></li></ul><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the<a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus</a></noscript></div></div></div></div><footer><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry</a><span>.</span></div></footer><script>window.onload=function(){var a,e,n,t;a=window,e=document,t="script",n="ga",a.GoogleAnalyticsObject=n,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=+new Date,n=e.createElement(t),t=e.getElementsByTagName(t)[0],n.async=1,n.src="//www.google-analytics.com/analytics.js",t.parentNode.insertBefore(n,t),ga("create","UA-102296742-1","auto"),ga("send","pageview")}</script></body></html>