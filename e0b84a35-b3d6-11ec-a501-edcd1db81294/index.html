<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="Closure Compiler是谷歌推出的一款Javascript压缩工具，在业界有广泛的使用。与传统压缩工具不同的地方在于，它将对代码的AST进行静态分析，而不是简单的正则表达式压缩。"><meta name="keyword" content="AST,AngularJS,JavaScript"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>JS静态分析工具ClosureCompiler介绍</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-102296742-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-102296742-1")</script><meta name="generator" content="Hexo 5.4.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">JS静态分析工具ClosureCompiler介绍</div><div class="date">2018-06-23 / modified at 2022-04-04</div><div class="content"><blockquote><span>️This article has been <strong>over 1 years</strong> since the last update.</span></blockquote><p>Closure Compiler是谷歌推出的一款Javascript压缩工具，在业界有广泛的使用。与传统压缩工具不同的地方在于，它将对代码的AST进行静态分析，而不是简单的正则表达式压缩。</p><span id="more"></span><p>在实际项目中，为了实现自动化提升代码质量，本文将通过在项目中引入此工具</p><ul><li>定制js压缩打包流程</li><li>定制静态检测（比如jslint无法发现的业务特有BUG）</li></ul><p>本文面向读者: 有一定AST基础，面向后端，希望控制代码质量的读者。由于AST的解析非常复杂，本文将只限制在使用工具上，而不会分析内部源码实现。</p><h2>Getting Start</h2><p>引入如下Maven依赖（如果不希望把它记入打包，可以把它配置为test的scope）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.google.javascript/closure-compiler --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.javascript<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>closure-compiler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>r2388<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>一个AST遍历的例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Compiler</span> <span class="variable">compiler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Compiler</span>();</span><br><span class="line"><span class="type">Node</span> <span class="variable">parse</span> <span class="operator">=</span> compiler.parse(SourceFile.fromCode(<span class="string">&quot;a.js&quot;</span>, <span class="string">&quot;var a = 1;&quot;</span>));</span><br><span class="line">NodeTraversal.traverse(compiler, parse, <span class="keyword">new</span> <span class="title class_">NodeTraversal</span>.Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldTraverse</span><span class="params">(NodeTraversal nodeTraversal, Node n, Node parent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(NodeTraversal t, Node n, Node parent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;n = &quot;</span> + n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>一个压缩的例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SourceFile sourceFile;</span><br><span class="line">sourceFile=SourceFile.fromCode(<span class="string">&quot;a.js&quot;</span>, <span class="string">&quot;function sum(left, right)&#123;return 2 + 3&#125;&quot;</span>);</span><br><span class="line"><span class="comment">// 初始化编译器</span></span><br><span class="line"><span class="type">CompilerOptions</span> <span class="variable">opts</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CompilerOptions</span>();</span><br><span class="line">CompilationLevel.SIMPLE_OPTIMIZATIONS.setOptionsForCompilationLevel(opts);</span><br><span class="line"><span class="type">Compiler</span> <span class="variable">compiler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Compiler</span>();</span><br><span class="line"><span class="comment">// 执行编译优化操作</span></span><br><span class="line">compiler.compile(Collections.emptyList(), Collections.singletonList(sourceFile), opts);</span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> compiler.toSource();</span><br><span class="line">System.out.println(s);</span><br><span class="line"><span class="comment">// =&gt; function sum(a,b)&#123;return a+b&#125;;</span></span><br></pre></td></tr></table></figure><h2>对JS代码进行静态转换</h2><p>本部分将定制Closure的转换规则，以实现自动化代码变换。</p><h4>预先准备</h4><p>在完成<code>new Compiler()</code>的构造后，通过下文的样板代码，我们加入了一个新的优化器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为DefaultPassConfig加入额外的优化PassFactory</span></span><br><span class="line"><span class="type">DefaultPassConfig</span> <span class="variable">passes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultPassConfig</span>(opts) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;PassFactory&gt; <span class="title function_">getOptimizations</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;PassFactory&gt; optimizations = <span class="built_in">super</span>.getOptimizations();</span><br><span class="line">        <span class="comment">// 创建了一个名称为`custom_pass`，实现为`CustomCompilerPass`的优化器</span></span><br><span class="line">        <span class="comment">// 并放在了优化器List的最前面</span></span><br><span class="line">        optimizations.add(<span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">PassFactory</span>(<span class="string">&quot;custom_pass&quot;</span>, <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> CompilerPass <span class="title function_">createInternal</span><span class="params">(AbstractCompiler compiler)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomCompilerPass</span>(compiler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> optimizations;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">compiler.setPassConfig(passes);</span><br></pre></td></tr></table></figure><p>接下来只用定制<code>CustomCompilerPass</code>即可实现代码优化了</p><p>这里本质上就是IR到IR的三段编译器</p><h4>函数名变成大写</h4><p>代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomCompilerPass</span> <span class="keyword">implements</span> <span class="title class_">CompilerPass</span> &#123;</span><br><span class="line">    AbstractCompiler compiler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomCompilerPass</span><span class="params">(AbstractCompiler compiler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.compiler = compiler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Node externs, Node root)</span> &#123;</span><br><span class="line">        NodeTraversal.traverse(compiler, root, <span class="keyword">new</span> <span class="title class_">NodeTraversal</span>.AbstractPostOrderCallback()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(NodeTraversal t, Node n, Node parent)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (n.isFunction())&#123;</span><br><span class="line">                    <span class="type">Node</span> <span class="variable">firstChild</span> <span class="operator">=</span> n.getFirstChild();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">qualifiedName</span> <span class="operator">=</span> firstChild.getQualifiedName();</span><br><span class="line">                    <span class="keyword">if</span> (qualifiedName != <span class="literal">null</span>)&#123;</span><br><span class="line">                        firstChild.setString(qualifiedName.toUpperCase());</span><br><span class="line">                        compiler.reportCodeChange();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// -&gt; function SUM(a, b)&#123;return 5&#125;</span></span><br></pre></td></tr></table></figure><p>注意这里树的遍历是后续(PostOrder)遍历，代码树结构大致如下，注意FUNCTION有三个Child</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">BLOCK</span></span><br><span class="line"> (<span class="name">SCRIPT</span></span><br><span class="line">  (<span class="name">FUNCTION</span> </span><br><span class="line">   	<span class="string">&quot;sum&quot;</span> </span><br><span class="line">   (<span class="name">PARAM_LIST</span> </span><br><span class="line">    (<span class="string">&quot;left&quot;</span> <span class="string">&quot;right&quot;</span>) </span><br><span class="line">   (<span class="name">BLOCK</span> </span><br><span class="line">    (<span class="name">RETURN</span> </span><br><span class="line">     (<span class="name">ADD</span> </span><br><span class="line">      (<span class="number">2</span> <span class="number">3</span>))))))))</span><br></pre></td></tr></table></figure><h4>定制JS压缩</h4><p>假设有如下JS，此JS来自UI-Router的SAP代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$stateProvider.<span class="title function_">state</span>(<span class="string">&#x27;home&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/&quot;</span>, <span class="comment">// root route</span></span><br><span class="line">    <span class="attr">views</span>: &#123;</span><br><span class="line">        <span class="string">&quot;lazyLoadView&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">controller</span>: <span class="string">&#x27;AppCtrl&#x27;</span>,</span><br><span class="line">            <span class="attr">templateUrl</span>: <span class="string">&#x27;partials/main.html&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">resolve</span>: &#123;</span><br><span class="line">        <span class="attr">loadMyCtrl</span>: [<span class="string">&#x27;$ocLazyLoad&#x27;</span>, <span class="keyword">function</span>(<span class="params">$ocLazyLoad</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $ocLazyLoad.<span class="title function_">load</span>([<span class="string">&#x27;js/a.js&#x27;</span>,<span class="string">&#x27;js/b.js&#x27;</span>,<span class="string">&#x27;js/c.js&#x27;</span>]);</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>我希望转换为支持在生产环境访问min.js的文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$stateProvider.<span class="title function_">state</span>(<span class="string">&#x27;home&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/&quot;</span>, <span class="comment">// root route</span></span><br><span class="line">    <span class="attr">views</span>: &#123;</span><br><span class="line">        <span class="string">&quot;lazyLoadView&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">controller</span>: <span class="string">&#x27;AppCtrl&#x27;</span>,</span><br><span class="line">            <span class="attr">templateUrl</span>: <span class="string">&#x27;partials/main.html&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">resolve</span>: &#123;</span><br><span class="line">        <span class="attr">loadMyCtrl</span>: [<span class="string">&#x27;$ocLazyLoad&#x27;</span>, <span class="keyword">function</span>(<span class="params">$ocLazyLoad</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $ocLazyLoad.<span class="title function_">load</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">env</span> == <span class="string">&#x27;dev&#x27;</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> [<span class="string">&#x27;js/a.js&#x27;</span>,<span class="string">&#x27;js/b.js&#x27;</span>,<span class="string">&#x27;js/c.js&#x27;</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> [<span class="string">&#x27;js/state/home.min.js&#x27;</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;());</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>我们需要首先匹配</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ocLazyLoad.<span class="title function_">load</span>([<span class="string">&#x27;js/a.js&#x27;</span>,<span class="string">&#x27;js/b.js&#x27;</span>,<span class="string">&#x27;js/c.js&#x27;</span>])</span><br></pre></td></tr></table></figure><p>它的AST如下</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">CALL</span></span><br><span class="line"> (<span class="name">GETPROP</span> </span><br><span class="line">   <span class="string">&quot;$ocLazyLoad&quot;</span></span><br><span class="line">   <span class="string">&quot;load&quot;</span> </span><br><span class="line">  (<span class="name">ARRAYLIT</span></span><br><span class="line">   <span class="string">&quot;js/a.js&quot;</span></span><br><span class="line">   <span class="string">&quot;js/b.js&quot;</span></span><br><span class="line">  <span class="string">&quot; js/c.js&quot;</span>)</span><br></pre></td></tr></table></figure><p>将要替换为</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ocLazyLoad.<span class="title function_">load</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">env</span> == <span class="string">&#x27;dev&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;js/a.js&#x27;</span>,<span class="string">&#x27;js/b.js&#x27;</span>,<span class="string">&#x27;js/c.js&#x27;</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;js/state/home.min.js&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>需要转换的AST如下</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">CALL</span></span><br><span class="line"> (<span class="name">GETPROP</span> </span><br><span class="line">  <span class="string">&quot;$ocLazyLoad&quot;</span></span><br><span class="line">  <span class="string">&quot;load&quot;</span> </span><br><span class="line">  (<span class="name">CALL</span></span><br><span class="line">   (<span class="name">FUNCTION</span></span><br><span class="line">    <span class="string">&quot;&quot;</span></span><br><span class="line">    (<span class="name">PARAM_LIST</span>)</span><br><span class="line">    (<span class="name">BLOCK</span></span><br><span class="line">     (<span class="name">IF</span></span><br><span class="line">      (<span class="name">EQ</span>)</span><br><span class="line">      (<span class="name">BLOCK</span>)</span><br><span class="line">      (<span class="name">BLOCK</span>)))))</span><br></pre></td></tr></table></figure><p>参考代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Node externs, Node root)</span> &#123;</span><br><span class="line">  NodeTraversal.traverse(compiler, root, <span class="keyword">new</span> <span class="title class_">NodeTraversal</span>.AbstractPostOrderCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(NodeTraversal t, Node n, Node parent)</span> &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">state</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="comment">// 获取state</span></span><br><span class="line">      <span class="keyword">if</span> (n.isGetProp()</span><br><span class="line">        &amp;&amp; n.getFirstChild().getString().equals(<span class="string">&quot;$stateProvider&quot;</span>)</span><br><span class="line">        &amp;&amp; n.getLastChild().getString().equals(<span class="string">&quot;state&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> n.getNext();</span><br><span class="line">        state = next.getString();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 通过AST变换，生成一个匿名函数</span></span><br><span class="line">      <span class="keyword">if</span> (n.isGetProp()</span><br><span class="line">        &amp;&amp; n.getFirstChild().getString().equals(<span class="string">&quot;$ocLazyLoad&quot;</span>)</span><br><span class="line">        &amp;&amp; n.getLastChild().getString().equals(<span class="string">&quot;load&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> n.getNext();</span><br><span class="line">        <span class="keyword">if</span> (next.getChildCount() == <span class="number">0</span>)&#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">call</span> <span class="operator">=</span> IR.call(IR.function(IR.name(<span class="string">&quot;&quot;</span>), IR.paramList(),</span><br><span class="line">          IR.block(</span><br><span class="line">            IR.ifNode(</span><br><span class="line">              IR.sheq(</span><br><span class="line">                IR.getprop(IR.name(<span class="string">&quot;window&quot;</span>), IR.string(<span class="string">&quot;env&quot;</span>)),</span><br><span class="line">                IR.string(<span class="string">&quot;dev&quot;</span>)),</span><br><span class="line">              IR.block(</span><br><span class="line">                IR.returnNode(next.cloneTree())</span><br><span class="line">              ),</span><br><span class="line">              IR.block(</span><br><span class="line">                IR.returnNode(IR.arraylit(IR.string(<span class="string">&quot;js/state&quot;</span> + state + <span class="string">&quot;/home.min.js&quot;</span>)))</span><br><span class="line">              ))</span><br><span class="line">          )));</span><br><span class="line">        next.getParent().replaceChild(next, call);</span><br><span class="line">        compiler.reportCodeChange();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意这里使用了一个外部变量<code>window.env</code>，因此需要配置一个extern.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> &#123;<span class="type">String</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">env</span>;</span><br></pre></td></tr></table></figure><p>最终生成的压缩后的js如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$stateProvider.<span class="title function_">state</span>(<span class="string">&quot;index&quot;</span>,&#123;<span class="attr">url</span>:<span class="string">&quot;/&quot;</span>,<span class="attr">views</span>:&#123;<span class="attr">lazyLoadView</span>:&#123;<span class="attr">controller</span>:<span class="string">&quot;AppCtrl&quot;</span>,<span class="attr">templateUrl</span>:<span class="string">&quot;partials/main.html&quot;</span>&#125;&#125;,<span class="attr">resolve</span>:&#123;<span class="attr">loadMyCtrl</span>:[<span class="string">&quot;$ocLazyLoad&quot;</span>,<span class="keyword">function</span>(<span class="params">a</span>)&#123;<span class="keyword">return</span> a.<span class="title function_">load</span>(<span class="string">&quot;dev&quot;</span>===<span class="variable language_">window</span>.<span class="property">env</span>?[<span class="string">&quot;js/a.js&quot;</span>,<span class="string">&quot;js/b.js&quot;</span>,<span class="string">&quot;js/c.js&quot;</span>]:[<span class="string">&quot;js/state/home.min.js&quot;</span>])&#125;]&#125;&#125;);</span><br></pre></td></tr></table></figure><h2>自动加入依赖注入</h2><p>很多人在使用依赖注入时总是忘记写成数组的形式，导致压缩后无法注入</p><p>使用前</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">angular.<span class="title function_">module</span>(<span class="string">&#x27;test&#x27;</span>).<span class="title function_">controller</span>(<span class="keyword">function</span> (<span class="params">$http, $scope</span>) &#123;</span><br><span class="line">    $http.<span class="title function_">post</span>();</span><br><span class="line">    $scope.<span class="property">req</span> = <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>使用后</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">angular.<span class="title function_">module</span>(<span class="string">&quot;test&quot;</span>).<span class="title function_">controller</span>([<span class="string">&quot;$http&quot;</span>,<span class="string">&quot;$scope&quot;</span>,<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;a.<span class="title function_">post</span>();b.<span class="property">req</span>=<span class="number">1</span>&#125;]);</span><br></pre></td></tr></table></figure><p>实现方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Node externs, Node root)</span> &#123;</span><br><span class="line">  NodeTraversal.traverse(compiler, root, <span class="keyword">new</span> <span class="title class_">NodeTraversal</span>.AbstractPostOrderCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(NodeTraversal t, Node n, Node parent)</span> &#123;</span><br><span class="line">      <span class="comment">// 此处自行添加定制过滤条件</span></span><br><span class="line">      <span class="keyword">if</span> (n.isFunction() &amp;&amp; n.getChildAtIndex(<span class="number">1</span>).getChildCount()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">cloneTree</span> <span class="operator">=</span> n.cloneTree();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">paramNode</span> <span class="operator">=</span> cloneTree.getChildAtIndex(<span class="number">1</span>);</span><br><span class="line">        Iterable&lt;Node&gt; children = paramNode.children();</span><br><span class="line">        List&lt;Node&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Node child : children) &#123;</span><br><span class="line">          list.add(IR.string(child.getString()));</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(cloneTree);</span><br><span class="line">        n.getParent().replaceChild(n, IR.arraylit(list.toArray(<span class="keyword">new</span> <span class="title class_">Node</span>[]&#123;&#125;)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2>Eval问题</h2><p>在项目中发现一处冲突，在某遗留代码的AjaxFileUpload.js(大概是2012年的框架吧)中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将data从json转为对象</span></span><br><span class="line">data = <span class="built_in">eval</span>(<span class="string">&quot;data=&quot;</span>+data);</span><br></pre></td></tr></table></figure><p>它被编译器优化后，变成了</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data=<span class="built_in">eval</span>(<span class="string">&quot;data\x3d&quot;</span>+data);</span><br></pre></td></tr></table></figure><p>这类优化可能是为了编码更加完善，但是的确产生了很多未知BUG。正确的解决方法是任何时候都不要使用eval，可以用自带的JSON进行解析。</p><h2>总结</h2><p>通过操作AST，可以实现</p><ul><li>远超正则表达式的高度定制</li><li>不需要Runtime</li></ul><p>不足</p><ul><li>工具开发成本相当高，投入产出比很低，适合有空闲的人来搞，后面的人不一定看的懂</li><li>此技术过于冷门，几乎没有Java的文档，但是对AST有兴趣的可以学习一个</li></ul><h2>参考</h2><ul><li>后续(PostOrder)遍历图解</li></ul><p><img src="http://upload-images.jianshu.io/upload_images/98641-6cd9f235c11d728c.png" alt="Pre Vs. In Vs. Post"></p><ul><li>AST的介绍: <a target="_blank" rel="noopener" href="https://tech.meituan.com/abstract-syntax-tree.html">https://tech.meituan.com/abstract-syntax-tree.html</a></li></ul></div><div class="tags"><a class="tag-link" href="/tags/AST/" rel="tag">AST</a><a class="tag-link" href="/tags/AngularJS/" rel="tag">AngularJS</a><a class="tag-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry</a><span>.</span></div></footer></div></body></html>