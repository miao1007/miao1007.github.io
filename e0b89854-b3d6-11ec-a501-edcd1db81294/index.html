<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="SonarQube是来自瑞士的代码检查工具，除了用来检查项目，它本身也是开源的，源码(代码结构/技术文档等)也必然是值得一读。"><meta name="keyword" content="DevOps,High Availability,SonarQube"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>SonarQube是如何工作的</title><link rel="icon" href="data:image/svg+xml,%3Csvg width='24' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext font-size='24' y='24'%3E諺%3C/text%3E%3C/svg%3E" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-102296742-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-102296742-1")</script><meta name="generator" content="Hexo 5.4.0"></head><body><header><div class="header no-print"><div class="header-container"><div class="header-left"><a href="/">諺</a></div><ul class="header-right"><li><a href="/archives">Archives</a></li><li><a href="/tags" rel="nofollow">Tags</a></li><li><a href="/about" rel="nofollow">About</a></li><li><a href="/epistemology" rel="nofollow">認識論</a></li><li><a href="/books" rel="nofollow">読書</a></li><li><a href="/archives" rel="nofollow">zh</a><a href="#" rel="nofollow">/</a><a href="/en" rel="nofollow">en</a></li></ul></div></div></header><div class="container"><div class="content-wrapper"><div class="post"><section class="article"><div class="title">SonarQube是如何工作的</div><div class="date">2019-01-16 / modified at 2022-04-04</div><div class="content"><blockquote><span>️This article has been <strong>over 1 years</strong> since the last update.</span></blockquote><p>SonarQube是来自瑞士的代码检查工具，除了用来检查项目，它本身也是开源的，源码(代码结构/技术文档等)也必然是值得一读。</p><span id="more"></span><p>通过阅读源码，我们可以学到</p><ul><li>一款顶尖复杂的软件项目的结构与模块如何划分</li><li>一个复杂前端的React实现</li><li>如何混合使用ES与数据库</li></ul><p>在阅读本文前，众所周知源码分析非常耗费时间，重复一下源码分析方法论</p><ul><li>能够充分<strong>使用过</strong>此项目，并阅读<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/architecture/architecture-integration/">文档</a>，这一步主要掌握上下文与术语</li><li>分析项目的pom依赖，并全部过一遍</li><li>找到免编译的路由断点与关键日志位置</li><li>充分使用FindUsage快速Jump</li></ul><h2>预先准备</h2><p>由于编译SonarQube非常繁琐耗时，我建议提前编译好的二进制文件</p><h4>下载源码</h4><ul><li>下载/手动编译二进制文件，解压运行，并确保已经有数据</li></ul><p>本地编译流程</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build.sh</span><br></pre></td></tr></table></figure><p>然后解压并右键启动</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sonar-application/build/distributions/sonarqube-8.9-SNAPSHOT/lib/sonar-application-8.9-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><h4>目录解析</h4><p>如下是安装目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bin：壳而已，Docker容器启动不需要</span><br><span class="line">conf：配置文件</span><br><span class="line">data: 主要是存放h2，elk，插件。如果数据库都外部化了，这里就只有plugin的副本了（PluginClassLoader）</span><br><span class="line">elasticsearch: elk原生包，下文写了可以考虑干掉</span><br><span class="line">extensions: 扩展，注意chmod，启动后会拷贝到  data/web/deploy/plugins</span><br><span class="line">lib: sonar-application-8.9-SNAPSHOT.jar: 所有代码与jar包依赖，内部主要有3个mian方法</span><br><span class="line">logs</span><br><span class="line">temp</span><br><span class="line">web: 启动web时的react文件</span><br></pre></td></tr></table></figure><h4>配置断点</h4><p>在IDEA中配置Remote断点，并在源码中如下位置打下断点</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.ce.app.CeServer<span class="comment">#start</span></span><br></pre></td></tr></table></figure><p>然后再次重新运行SonarQube，如果Ok的话断点就断上了</p><h2>SonarQube组件构成</h2><h4>服务端(ServerSide)</h4><p>在服务端(org.sonar.application.App)启动时，会依此启动<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/8.9/instance-administration/monitoring/">如下</a>Process(通过<code>ps aux|grep sonar</code>分析)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.application.SchedulerImpl#tryToStartAll</span><br><span class="line">	# 由 bin/elasticsearch 的shell启动</span><br><span class="line">	org.elasticsearch.bootstrap.Elasticsearch</span><br><span class="line">	# tryToStartCe</span><br><span class="line">	org.sonar.ce.app.CeServer</span><br><span class="line">	# tryToStartWeb</span><br><span class="line">	org.sonar.server.app.WebServer</span><br></pre></td></tr></table></figure><p>它们的作用分别是</p><ul><li>ElasticSearch: 内嵌的ElasticSearch，版本为7，未修改任何jar包，类似HBase的rowkey的作用</li><li>Compute Engine(CE): 计算引擎，通过解析计算客户端上传的Zip，显示到前端；定时刷新db到elk</li><li>Web: 本质是数据仓库的前台。主要有用React实现的前端与API代理，通过内嵌的Tomcat实现部署</li></ul><p>它们的PID分别如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p_es=`ps aux|grep Elasticsearch|grep java |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line">p_ce=`ps aux|grep CeServer|grep java |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line">p_web=`ps aux|grep WebServer|grep java |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br></pre></td></tr></table></figure><p>通过lsof查看每个服务的监听情况，并在源码中全局搜索</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lsof -i -n -P |grep java|grep LISTEN|grep <span class="variable">$&#123;p_es&#125;</span></span><br><span class="line"><span class="comment"># --&gt; 9001(Elastic默认TCP端口)</span></span><br><span class="line">lsof -i -n -P |grep java|grep LISTEN|grep <span class="variable">$&#123;p_ce&#125;</span></span><br><span class="line"><span class="comment"># --&gt; 54918(没查到，可能是随机端口)</span></span><br><span class="line">lsof -i -n -P |grep java|grep LISTEN|grep <span class="variable">$&#123;p_web&#125;</span></span><br><span class="line"><span class="comment"># --&gt; 9000(HTTP端口), 9092(H2数据库端口)</span></span><br></pre></td></tr></table></figure><h4>客户端(ScannerSide)</h4><p>源码分析器，在客户机上计算，通过HTTP将ZIP发给WebServer，内部有ClassLoader，可以下载服务端的插件到客户端执行Sensor解析等操作。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 上传zip</span><br><span class="line">org.sonar.scanner.report.ReportPublisher#upload</span><br></pre></td></tr></table></figure><p>这里主要涉及到插件开发，可以参考<code>sonar-cxx</code>等优质插件，插件文档很不友好，对编码要求高。</p><p>我在一些项目中，涉及到读取第三方report，这时推荐使用Java-grok框架提高开发速度。</p><h2>组件实现</h2><h4>数据库（demo-only）</h4><p>内嵌H2直接免密码访问如下JDBC即可</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:h2:tcp://127.0.0.1:9092/sonar</span><br></pre></td></tr></table></figure><p>当然生产时可以自己搭建一个本地的pg库。在Java层使用了MyBatis进行查询。所有的SQL都没有用自增主键，而是用的是类似雪花算法（绑定了Mac地址与timestamp）的<code>UuidFactoryImpl</code>实现的。</p><p>这种类似UUID的实现导致无法使用基于主键的二分Join查找，而一定需要基于分词器的ELK作为二级索引缓存（比如先查询issue的ids，再用in去查询files），否则性能会极低。</p><blockquote><p>我使用内嵌的数据库测试发现一个问题：Quality Profiles only supports up to 6.4k build-in rules .</p></blockquote><h4>ElasticSearch里存的啥</h4><p>在SonarQube中，ElasticSearch的配置文件是程序生成的。</p><p>入口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.application.command.CommandFactory#createEsCommand</span><br></pre></td></tr></table></figure><p>默认通过<code>elastic head</code>等工具访问<code>http://localhost:9001/</code>就可以知道里面存的啥了。其实里面只存储了一些主键的uuid</p><p>比如下面存储了issues的主键<code>kee</code>对应下面的<code>_id</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;issues&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AXR4KEWgqc90wyxKGvI6&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_routing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auth_AXR4J_kRLlgBvFiws367&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>此外还有<code>rules</code>也只是用来存储主键，并没有像想象中缓存了很多error/warings的报错。这里的ELK场景类似于提供了一个类似HBase的唯一RowKey（联合主键），是Stream计算后的缓存的缓存，下游DB只用查询<code>in</code>即可，性能更好，这样就算是一堆left join，也都是低计算强度的聚合。</p><blockquote><p>假如你将ELK删除，然后重启可以发现会自动修复，说明本项目中ELK定位只是主键/分页的索引缓存，这个Key承载了太多信息。</p></blockquote><p>在收费版中，Sonarqube支持多个ELK节点，而免费版不支持分离部署。</p><p>外置Elasticsearch并不是为了解决Sonarqube的扩容瓶颈问题，而主要是解决单点可用性问题，你放到外部就算天天备份也意义不大。</p><p>注意配置要提高Xms与Xmx，默认的512太低；将Elastic的索引文件外挂Docker磁盘，可以提高reindex速度。</p><p><strong>How to use external Elasticsearch in Sonarqube</strong></p><p>It’s just a hack at your own risk. See details at <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/67144468/4016014">stackoverflow</a></p><blockquote><p>注意主节点插件升级后，ELK也会同步导入规则，这个场景没有测试</p></blockquote><p>本文实验如下，下面为ELK的配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ELK side, IP=192.168.33.10</span></span><br><span class="line">sysctl -w vm.max_map_count=262144</span><br><span class="line">docker run --name elk -p 9200:9200 bitnami/elasticsearch:7</span><br><span class="line">docker run --name pg -p 5432:5432 -e POSTGRES_USER=<span class="string">&quot;postgres&quot;</span> -e POSTGRES_PASSWORD=<span class="string">&quot;postgres&quot;</span> postgres</span><br><span class="line">psql -U postgres</span><br><span class="line">create database sonarqube;</span><br><span class="line">create user sonarqube with encrypted password <span class="string">&#x27;sonarqube&#x27;</span>;</span><br><span class="line">grant all privileges on database sonarqube to sonarqube;</span><br></pre></td></tr></table></figure><p>sonar配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sonar side, test only</span></span><br><span class="line"><span class="attr">sonar.jdbc.username</span>=<span class="string">sonarqube</span></span><br><span class="line"><span class="attr">sonar.jdbc.password</span>=<span class="string">sonarqube</span></span><br><span class="line"><span class="attr">sonar.jdbc.url</span>=<span class="string">jdbc:postgresql://192.168.33.10:5432/sonarqube</span></span><br><span class="line"><span class="attr">sonar.web.port</span>=<span class="string">9100</span></span><br><span class="line"><span class="attr">sonar.search.port</span>=<span class="string">9200</span></span><br><span class="line"><span class="attr">sonar.search.host</span>=<span class="string">192.168.33.10</span></span><br></pre></td></tr></table></figure><p>执行mock脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; ./elasticsearch/bin/elasticsearch &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"># it&#x27;s a inflate sleep</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar lib/sonar-application-8.9.3-SNAPSHOT.jar </span><br></pre></td></tr></table></figure><p>这种将ELK与Sonar分离部署的方案，启动速度实测为15s左右（主要是ce耗费时间）</p><p>如果需要reindex，按照官方标准的话，就是先关机sonar，清空elk，再启动sonar通过ce进行reindex</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启后相关任务</span></span><br><span class="line">IndexerStartupTask -&gt; AsyncIssueIndexingImpl -&gt; ceQueue -&gt; IssueSyncTaskProcessor</span><br></pre></td></tr></table></figure><h4>WebServer</h4><p>它部署了一个嵌入的Tomcat，通过Java(而不是通过Spring的DSL)手动实现添加webApp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.server.app.TomcatContexts#addContext</span><br></pre></td></tr></table></figure><p>等Tomcat部署后，将调用<code>PlatformServletContextListener</code>启动Platform(这里并没有使用Spring作为依赖注入，而是使用了<code>picocontainer</code>实现，使用Java编码而没有用注解/XML等DSL进行描述依赖关系)，启动API业务</p><p>最终部署如下业务</p><table><thead><tr><th>部署类型</th><th>ContextPath</th><th>ByWho</th></tr></thead><tbody><tr><td>API业务</td><td>/api</td><td>WebServiceFilter, 类似于Struts</td></tr><tr><td>React静态文件</td><td>默认是<code>/</code>, 详见<code>sonar.web.context</code></td><td>web</td></tr><tr><td>插件Jar仓库静态文件</td><td>/deploy</td><td>data/web/deploy</td></tr></tbody></table><p>所有的API请求均可以通过如下位置进行断点分析到业务中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.server.ws.WebServiceEngine#execute</span><br></pre></td></tr></table></figure><p>这样本文的引导作用就达到了，剩下具体业务自行断点分析</p><blockquote><p>我在这里耗费了较多时间，本以为API业务是由Servlet进行处理，没想到居然是通过全手写Filter与Action的方法处理(10年前这种方法很先进)，可以看出SonarQube也是有历史债务的，但是它的代码质量经过长期maintain后仍然清晰。</p><p>注意项目中的<code>StaticResourcesServlet</code>已经事实上废弃，因为已经没有<code>static</code>文件夹了（但是插件可能会使用一些js/css）</p></blockquote><h4>CE如何录入计算结果？</h4><p>CE的启动流程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main入口</span></span><br><span class="line">org.sonar.ce.app.CeServer#main</span><br><span class="line"><span class="comment">// runner入口</span></span><br><span class="line"><span class="comment">// level1 ~ 4 启动依赖注入</span></span><br><span class="line">org.sonar.ce.ComputeEngineImpl#startup</span><br><span class="line"><span class="comment">// 启动定时器</span></span><br><span class="line">org.sonar.ce.queue.CeQueueInitializer#initCe</span><br><span class="line">org.sonar.server.platform.ServerLifecycleNotifier#notifyStart</span><br></pre></td></tr></table></figure><p>最核心的是启动了如下一堆定时器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CeQueueInitializer</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initCe</span><span class="params">()</span> &#123;</span><br><span class="line">  ceDistributedInformation.broadcastWorkerUUIDs();</span><br><span class="line">  processingScheduler.startScheduling();</span><br><span class="line">  <span class="comment">// 两分钟清理一次</span></span><br><span class="line">  cleaningScheduler.startScheduling();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最简单的两分钟清理一次任务： cleaningScheduler</p><ul><li>resetTasksWithUnknownWorkerUUIDs: 将未知UUID的Work的任务配置为PENDING，这里单机版对应的是重装后删除旧的work任务；分布式版本对应hazelcast中不健康的Work任务自动下线，可以搜索<code>update ce_queue set</code>。这里不会删除Pending长时间的任务。</li><li>cancelWornOuts: delete所有Pending的任务</li></ul><blockquote><p>假如你部署了多台Sonarqube社区版连接同一台机器，那么Work的UUID由于是基于时间生成，那么将导致相互reset</p></blockquote><p>总流程如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Scanner(client-side)-(HTTP POST Zip)-&gt;Web-(MQ)-&gt;CE</span><br></pre></td></tr></table></figure><p>首先在Scanner通过Maven等工具在Jenkins等平台(占用这些平台的计算资源)计算出项目的各种分析报告，然后Scanner调用Web中如下接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://localhost:9000/api/ce/submit?projectKey=xxx&amp;projectName=yyy</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">org.sonar.server.ce.ws.SubmitAction#handle</span><br></pre></td></tr></table></figure><p>WebServer将原始RAW文件录入<code>ce_task_input</code>，接着通过消息队列(DB Based)，可以类比为Celery</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.ce.queue.CeQueueImpl#submit(org.sonar.ce.queue.CeTaskSubmit)</span><br></pre></td></tr></table></figure><p>CE侧通过线程池每隔两秒轮询查询任务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.ce.taskprocessor.CeWorkerImpl#call</span><br><span class="line">org.sonar.ce.queue.InternalCeQueueImpl#peek</span><br></pre></td></tr></table></figure><p>最终任务将通过路由到如下位置，执行数据仓库录入等任务(CeTaskProcessor)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.ce.task.step.ComputationStepExecutor#executeStep</span><br></pre></td></tr></table></figure><p>最终匹配的消费者为ExtractReportStep，进行异步计算并存储到数据仓库</p><p><code>CeTaskTypes.REPORT</code></p><p>ReportTaskProcessor: CeTaskTypes.REPORT</p><p>此外还有一个任务<br>IssueSyncTaskProcessor: CeTaskTypes.BRANCH_ISSUE_SYNC 当重启时，会触发此服务。首先检查<code>sonar.internal.es.disableIndexes</code>，然后检查ELK数据是否损坏，并重新reindex到ELK</p><ul><li>IgnoreOrphanBranchStep: 通过ce_task的uuid -&gt; project_branches中是否有数据</li><li>IndexIssuesStep: 通过ce_task的uuid -&gt; project_branches.need_issue_sync判断是否需要同步，然后将 issues/rules/components 的join结果缓存到ELK</li></ul><blockquote><p>思考：为何不直接用MyBatis的缓存注解框架，而是用了ELK？</p></blockquote><h2>疑问解答</h2><h4>SonarQube如何实现存储源码？</h4><p>通过访问表<code>file_sources</code>中的<code>BINARY_DATA</code>与protobuf/LZ4压缩实现存储，它与File通过<code>FILE_UUID</code>进行关联</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.server.source.ws.LinesAction#handle</span><br></pre></td></tr></table></figure><p>你在前台查询的issues等信息，实际上就是数据库多张表join查出来的，SQL优化的好，就算没缓存也很快。</p><h4>SonarQube与Markdown</h4><p>通过基于正则表达式的规则引擎实现，这个做的比较简单，没有实现AST</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.sonar.channel.ChannelDispatcher#consume</span><br></pre></td></tr></table></figure><h4>SonarQube的React如何实现</h4><p>前台使用了React与JSX实现业务，使用Webpack进行打包，使用<a target="_blank" rel="noopener" href="https://webpack.js.org/configuration/dev-server/">WebPackDevServer</a>作为API代理，前端通过如下启动外壳业务，打包脚本见<code>server/sonar-web/config/webpack.config.js</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动业务(使用NodeJS提供Server)</span></span><br><span class="line">node server/sonar-web/scripts/start.js</span><br><span class="line"><span class="comment"># 打包(后续交给Tomcat处理)</span></span><br><span class="line">node server/sonar-web/scripts/build.js</span><br></pre></td></tr></table></figure><h4>SonarQube如何分析代码AST？</h4><p>这里采用插件实现，比如Java在<a target="_blank" rel="noopener" href="https://github.com/SonarSource/sonar-java">这里</a>可以找到，分析后将转为通用格式发给Web进行处理</p><p>如果项目组需要定制Custom Rule，就可以通过访问<code>onMethodInvocationFound</code>实现自己的规则</p><p>当然更推荐用第三方的report解析，比如<code>sonar-cxx</code>插件，这种就只用解析xml而不用写parser了，这种生态成本反而更低一些</p><h2>高可用思路</h2><p>首先不要忘记停机也没啥大不了的，它本质上只属于支持业务。</p><h4>收费版分析</h4><p>首先要明确，收费版（最贵的DC版）即使通过分散元数据实现了扩容（Enterprise-scale），也有downtime的问题：Cluster downtime is required for SonarQube upgrades or plugin installations.</p><p>基于<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/setup/install-cluster/">文档</a>分析如下，不含LB与DB的话，按照200M的issue需求，需要5个节点</p><ul><li>其中2个是jar包业务（4U/16G）</li><li>3个是Jar包里的ElasticSearch（8U/32G）</li></ul><p>这套没什么缺点，除了贵以外。</p><blockquote><p>再次强调，分布式，横向扩容，高可用三者间没有任何覆盖关系。</p></blockquote><h4>社区版分析</h4><p>Sonarqube是单机程序，存在downtime故障。假如想不掏钱实现多机器部署的高可用，那么注意</p><p><strong>思路一</strong>：仍然单节点，降低重启downtime时间</p><ul><li>Elastic：内置的全部屏蔽，外移，方案同上。</li><li>减少插件与插件中的规则，因为启动时会加载规则到DB中，可以删掉不用的css/c#等插件</li></ul><p><strong>思路二</strong>：仍然单节点，思路一 + 报告回传加入持久化</p><p>新增一套生产消费者（类似Azure Stroage Gateway or Azure Queue Storage），将应用侧基于DB的队列换为云服务。</p><ul><li>队列：需要实现file upload queue或者kafka+s3，自己轮训检查后台Pending为空后，从云队列中获取。</li></ul><p><strong>思路三</strong>：多机Web服务高可用（不推荐）</p><p>事实上这套方案意义本身不大，公司级的内部项目，甚至用户粘性没必要做到这么高的运维级别，无状态的Web应用本身CURD很难挂掉，而有状态的CE却难以实现多机部署，导致ROI很低。</p><p>需要解决的问题</p><ul><li>Elastic：内置的全部屏蔽，外移，方案同上。</li><li>CE: 有状态有定时任务的消费者，需要屏蔽只留一台。分布式方案基本上就靠买了，否则自己做还不如搭建多台url-hash切片用。</li><li>Web：理论上是无状态/生产者，可以多机部署，本来就是个壳而已。假如插件更新，仍然要全部停机。但是内部黑盒是否有另外坑，尚不明确。</li><li>多机的JWT-session问题: 需要用<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/instance-administration/delegated-auth/">Delegating Authentication</a>/SSO来实现，只用LDAP是不够的。可以配合使用Traefik等网关的filter实现。</li><li>升级插件重启中的rules表与缓存刷新：尚未明确是否有lock等暗坑</li></ul><p>这种高成本导致还不如用子域名部署多台，因为就算你部署成功，部分场景测试ok。但是一旦升级，你没法证明过程是可信的。</p><h4>写入场景</h4><ul><li>通过API写入门禁规则等信息</li><li>通过上传报告写入issue信息</li></ul><h4>高可用且横向扩展</h4><ul><li>分离部署：不要同时启动三个服务。</li><li>前台Web高可用：解决Session问题就是无状态了，可以用ExternalGroupsProvider实现</li><li>CE高可用：要实现独立部署，不能和web程序混在一起，否则web重启时无法持久化</li></ul><h2>其它</h2><h4>总结</h4><p>对个人来说，分析这个平台是有点后悔的----这套代码本身就是数十年的祖传项目，耗费太多时间了，我从2017年时不时就研究下，但是收益却只有苦劳，几次改版后可能就白分析了。<br>从功利的角度来说，这类CICD的方向太窄，而且基本上只有BAT玩得起这种定制，它本身的LGPL协议也并不友好。</p><p>个人看法</p><ul><li>不要去折腾内部实现高可用等技术细节，ROI太低，重启也没啥；加钱买买买也可以。</li><li>将时间投入在静态检查插件，Wrapper封装等业务中，产生效率价值</li><li>分析本身的溢价很低，投入在算法等基础组件上更好。这么搞面试太吃亏了，假如我是雇主，也不会考虑支付sonar插件外的溢价。说得不好听，可能连能面试你的人都找不到。</li></ul><h4>高可用组网探索</h4><ul><li>Do at your own risk without any community or business support.</li><li>No scaling implemented: only one compute engine work</li><li>Upgrade plugins will require a full restart</li><li>Consume a lot of time.</li></ul><p>Prerequisites node</p><ul><li>clusters(K8S or nomad) or docker exec directly.</li><li><a target="_blank" rel="noopener" href="https://doc.traefik.io/traefik/routing/routers/">Traefik</a> or Consul side-car or the other application gateway(DaemonSet) * N</li><li>External Elastic7 Service * 1</li><li>External Postgres Service * 1</li><li>External SSO/SAML Service * 1</li><li>SonarQube LTS(with computer engine only) * 1</li><li>SonarQube LTS(with elastic/ce removed) * N</li></ul><h4>Architecture</h4> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="661px" preserveAspectRatio="none" style="width:646px;height:661px;background:#fff" version="1.1" viewBox="0 0 646 661" width="646px" zoomAndPan="magnify" class="kroki">$2<defs/><g><g id="cluster_engine"><rect fill="none" height="392.18" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="418" x="7" y="128.8"/><path d="M83,128.8 L83,138.0969 L73,148.0969 L7,148.0969 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="66" x="10" y="142.7951">Clusters</text></g><g id="cluster_cdr"><rect fill="none" height="177.74" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="142" x="208" y="171.8"/><path d="M331,171.8 L331,181.0969 L321,191.0969 L208,191.0969 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="113" x="211" y="185.7951">Traefik Router</text></g><g id="cluster_sonar"><rect fill="none" height="87.29" rx="3.5" ry="3.5" style="stroke:#696969;stroke-width:1" width="370" x="31" y="409.69"/><path d="M129,409.69 L129,418.9869 L119,428.9869 L31,428.9869 " fill="none" style="stroke:#696969;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="88" x="34" y="423.6851">SonarQube</text></g><g id="elem_router"><path d="M229,206.8 L329,206.8 C334,206.8 334,219.9484 334,219.9484 C334,219.9484 334,233.0969 329,233.0969 L229,233.0969 C224,233.0969 224,219.9484 224,219.9484 C224,219.9484 224,206.8 229,206.8 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5"/><path d="M329,206.8 C324,206.8 324,219.9484 324,219.9484 C324,233.0969 329,233.0969 329,233.0969 " fill="none" style="stroke:#454645;stroke-width:1.5"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90" x="229" y="224.7951">Rule:Host(...)</text></g><g id="elem_middle"><path d="M235,307.24 L323,307.24 C328,307.24 328,320.3884 328,320.3884 C328,320.3884 328,333.5369 323,333.5369 L235,333.5369 C230,333.5369 230,320.3884 230,320.3884 C230,320.3884 230,307.24 235,307.24 " fill="#FF6347" style="stroke:#454645;stroke-width:1.5"/><path d="M323,307.24 C318,307.24 318,320.3884 318,320.3884 C318,333.5369 323,333.5369 323,333.5369 " fill="none" style="stroke:#454645;stroke-width:1.5"/><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="235" y="325.2351">Middleware</text></g><g id="elem_sonarQube"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="158" x="47" y="444.69"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="57" y="467.6851">SonarQube Web * N</text></g><g id="elem_ce"><rect fill="#F1F1F1" height="36.2969" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="145" x="239.5" y="444.69"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="249.5" y="467.6851">SonarQube CE * 1</text></g><g id="elem_lb"><path d="M258.5,23.5 L258.5,47.5 M258.5,35.5 L275.5,35.5 " fill="none" style="stroke:#454645;stroke-width:.5"/><ellipse cx="287.5" cy="35.5" fill="#FFE552" rx="12" ry="12" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26" x="266" y="64.4951">ELB</text></g><g id="elem_session"><rect fill="#F1F1F1" height="52.5938" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:.5" width="199" x="441.5" y="294.09"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="179" x="451.5" y="317.0851">Delegating Authentication</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="451.5" y="333.382">CAS or SAML SSO</text></g><g id="elem_elk"><path d="M89.5,608.98 C89.5,598.98 150,598.98 150,598.98 C150,598.98 210.5,598.98 210.5,608.98 L210.5,634.2769 C210.5,644.2769 150,644.2769 150,644.2769 C150,644.2769 89.5,644.2769 89.5,634.2769 L89.5,608.98 " fill="#00FFFF" style="stroke:#454645;stroke-width:.5"/><path d="M89.5,608.98 C89.5,618.98 150,618.98 150,618.98 C150,618.98 210.5,618.98 210.5,608.98 " fill="none" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="99.5" y="635.9751">ElasticSearch7</text></g><g id="elem_front"><ellipse cx="115" cy="14" fill="#454645" rx="8" ry="8" style="stroke:#454645;stroke-width:.5"/><path d="M115,22 L115,49 M102,30 L128,30 M115,49 L102,64 M115,49 L128,64 " fill="none" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="63" x="83.5" y="78.4951">Frontend</text></g><g id="elem_pg"><path d="M290,608.98 C290,598.98 331,598.98 331,598.98 C331,598.98 372,598.98 372,608.98 L372,634.2769 C372,644.2769 331,644.2769 331,644.2769 C331,644.2769 290,644.2769 290,634.2769 L290,608.98 " fill="#00FFFF" style="stroke:#454645;stroke-width:.5"/><path d="M290,608.98 C290,618.98 331,618.98 331,618.98 C331,618.98 372,618.98 372,608.98 " fill="none" style="stroke:#454645;stroke-width:.5"/><text fill="#454645" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="300" y="635.9751">Postgres</text></g><g id="link_lb_router"><path d="M279,68.15 C279,103.35 279,168.99 279,200.77 " fill="none" id="lb-to-router" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="279,205.66,283,196.66,279,200.66,275,196.66,279,205.66" style="stroke:#454645;stroke-width:1"/></g><g id="link_router_middle"><path d="M279,233.41 C279,250.5 279,281.32 279,301.04 " fill="none" id="router-to-middle" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="279,306.02,283,297.02,279,301.02,275,297.02,279,306.02" style="stroke:#454645;stroke-width:1"/></g><g id="link_middle_session"><path d="M334.12,320.39 C367.9,320.39 401.69,320.39 435.47,320.39 " fill="none" id="middle-session" style="stroke:#454645;stroke-width:1;stroke-dasharray:7,7"/><polygon fill="#454645" points="329.38,320.39,338.38,324.39,334.38,320.39,338.38,316.39,329.38,320.39" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="440.33,320.39,431.33,316.39,435.33,320.39,431.33,324.39,440.33,320.39" style="stroke:#454645;stroke-width:1"/></g><g id="link_middle_sonarQube"><path d="M265.42,333.85 C239.32,357.82 181.84,410.58 149.43,440.33 " fill="none" id="middle-to-sonarQube" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="146.22,443.19,155.5606,440.0669,149.9093,439.8153,150.161,434.164,146.22,443.19" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="217" y="389.7569">X-Forwarded-Login</text></g><g id="link_front_lb"><path d="M146.62,43.65 C175.91,43.65 219.19,43.65 248.2,43.65 " fill="none" id="front-to-lb" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="253.17,43.65,244.17,39.65,248.17,43.65,244.17,47.65,253.17,43.65" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="165" y="36.7169">RESTful API</text></g><g id="link_sonarQube_pg"><path d="M123.96,481.15 C122.27,504.21 123,544.86 145,568.98 C154.53,579.44 232.4,598.57 284.32,610.38 " fill="none" id="sonarQube-to-pg" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="288.89,611.65,281.0048,605.7489,284.0152,610.5382,279.2259,613.5486,288.89,611.65" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="146" y="550.0469">Files &amp; Issues</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="158.5" y="565.1797">JWT Tokens</text></g><g id="link_ce_pg"><path d="M319.54,481.48 C325.34,496.05 332.88,517.45 336,536.98 C338.25,551.03 336.69,554.78 336,568.98 C335.63,576.73 334.94,585.1 334.19,592.81 " fill="none" id="ce-to-pg" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="333.61,597.55,338.4906,588.9955,334.1103,592.5751,330.5307,588.1949,333.61,597.55" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="338" y="550.0469">Files &amp; Issues</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="350.5" y="565.1797">JWT Tokens</text></g><g id="link_sonarQube_elk"><path d="M101.21,481.43 C75.27,502.09 40.7,537.56 59,568.98 C65.26,579.74 74.69,588.44 85.14,595.41 " fill="none" id="sonarQube-to-elk" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="89.01,598.49,83.5376,590.3014,84.7829,595.8195,79.2648,597.0648,89.01,598.49" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="60" y="557.5469">RowKey</text></g><g id="link_ce_elk"><path d="M304.45,481.4 C294.04,504 273.39,543.37 246,568.98 C234.8,579.46 221.07,588.48 207.53,595.92 " fill="none" id="ce-to-elk" style="stroke:#454645;stroke-width:1"/><polygon fill="#454645" points="203.56,598.58,213.3822,597.8559,207.9674,596.2189,209.6044,590.8041,203.56,598.58" style="stroke:#454645;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="273" y="557.5469">RowKey</text></g></g></svg><h4>安全加固</h4><p>参考这里的<a target="_blank" rel="noopener" href="https://www.bleepingcomputer.com/news/security/fbi-hackers-stole-government-source-code-via-sonarqube-instances/">泄漏事故</a></p><ul><li>Dockerfile: 基于LTS镜像<ul><li>不采用root的gosu启动，卸载无用的apt包</li><li>对sonar.properties关键信息使用自带AES工具加密，整体配置chmod400/nobody</li><li>移除/审计无用的自带插件，降低攻击面</li></ul></li><li>系统配置<ul><li>不暴露地址到外网</li><li>关闭默认共享项目；配置全局模版，不共享<code>sonar-user</code></li><li>集成SSO/LDAP登陆，并考虑实现群组定时push，基于群组而非用户管理权限</li><li>admin只开启view与admin权限，不开启view source code功能，安装后专人回收账号</li></ul></li></ul></div><div class="tags"><a class="tag-link" href="/tags/DevOps/" rel="tag">DevOps</a><a class="tag-link" href="/tags/High-Availability/" rel="tag">High Availability</a><a class="tag-link" href="/tags/SonarQube/" rel="tag">SonarQube</a></div></section><div class="comments no-print"><noscript>Please enable JavaScript to view comments.</noscript><script async src="https://giscus.app/client.js" data-repo="miao1007/miao1007.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMzA1NTY1MDU=" data-category="General" data-category-id="DIC_kwDOB8giWc4COaTx" data-mapping="url" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous"></script></div></div></div><footer class="no-print"><div class="rights"><a href="/feed.xml" rel="external nofollow">RSS</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" rel="external nofollow" target="_blank">Curry</a><span>.</span></div></footer></div></body></html>